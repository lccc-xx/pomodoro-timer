<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„é’Ÿè®¡æ—¶å™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff6b6b;
            --primary-dark: #ff4757;
            --secondary-color: #1e90ff;
            --secondary-dark: #3742fa;
            --break-color: #2ed573;
            --break-dark: #1dd1a1;
            --success-color: #2ed573;
            --warning-color: #ffa502;
            --error-color: #ff4757;
            --info-color: #1e90ff;
            --dark-bg: #2c3e50;
            --darker-bg: #1e272e;
            --light-text: #f5f6fa;
            --medium-text: #dcdde1;
            --dark-text: #2f3640;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-radius: 12px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            color: var(--light-text);
            min-height: 100vh;
            padding: 20px;
            transition: var(--transition);
        }

        body.light-theme {
            --dark-bg: #f5f6fa;
            --darker-bg: #dcdde1;
            --light-text: #2f3640;
            --medium-text: #353b48;
            --dark-text: #192a56;
            --card-bg: rgba(0, 0, 0, 0.05);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--medium-text);
            font-size: 1.1rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timer-container {
            grid-column: 1;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-time {
            font-size: 5rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            color: var(--light-text);
            text-shadow: 0 2px 20px rgba(255, 107, 107, 0.3);
        }

        .timer-time.work {
            color: var(--primary-color);
        }

        .timer-time.break {
            color: var(--break-color);
        }

        .timer-status {
            font-size: 1.2rem;
            color: var(--medium-text);
            margin-bottom: 10px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--medium-text);
            color: var(--light-text);
        }

        .btn-outline:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .time-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--card-bg);
            color: var(--light-text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .time-btn:hover {
            background: var(--primary-color);
        }

        .time-input {
            width: 60px;
            text-align: center;
            background: transparent;
            border: 2px solid var(--medium-text);
            color: var(--light-text);
            border-radius: 6px;
            padding: 8px;
            font-size: 1.1rem;
        }

        .time-label {
            font-weight: 600;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--medium-text);
            margin-top: 5px;
        }

        .tasks-section {
            grid-column: 2;
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .task-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--medium-text);
            background: transparent;
            color: var(--light-text);
            border-radius: 8px;
            font-size: 1rem;
        }

        .task-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .tasks-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--medium-text);
            border-radius: 4px;
            margin-right: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .task-checkbox.checked {
            background: var(--success-color);
            border-color: var(--success-color);
            position: relative;
        }

        .task-checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-name {
            font-weight: 500;
        }

        .task-pomodoros {
            font-size: 0.85rem;
            color: var(--medium-text);
            margin-top: 4px;
        }

        .task-actions {
            display: flex;
            gap: 5px;
        }

        .task-btn {
            background: transparent;
            border: none;
            color: var(--medium-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .task-btn:hover {
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .history-section {
            margin-top: 20px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .history-info {
            display: flex;
            flex-direction: column;
        }

        .history-task {
            font-weight: 500;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--medium-text);
        }

        .history-duration {
            color: var(--primary-color);
            font-weight: 600;
        }

        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification.info {
            border-left: 4px solid var(--info-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--medium-text);
            border-radius: 8px;
            color: var(--light-text);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--medium-text);
            border-radius: 8px;
            color: var(--light-text);
            font-size: 1rem;
        }

        .modal-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .control-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--light-text);
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .control-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 80px;
        }

        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 140px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .timer-time.running {
            animation: pulse 2s infinite;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .tasks-list::-webkit-scrollbar,
        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .tasks-list::-webkit-scrollbar-track,
        .history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .tasks-list::-webkit-scrollbar-thumb,
        .history-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .timer-time {
                font-size: 3.5rem;
            }
            
            .timer-controls {
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .time-control {
                width: 100%;
                justify-content: space-between;
            }
            
            .theme-toggle {
                bottom: 80px;
                right: 20px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ… ç•ªèŒ„é’Ÿè®¡æ—¶å™¨</h1>
            <p class="subtitle">ä¸“æ³¨å·¥ä½œï¼Œé«˜æ•ˆä¼‘æ¯</p>
        </header>

        <div class="main-layout">
            <div class="card timer-container">
                <div class="timer-display">
                    <div class="timer-status" id="timerStatus">å‡†å¤‡å¼€å§‹</div>
                    <div class="timer-time" id="timerDisplay">25:00</div>
                    <div id="pomodoroName" style="color: var(--medium-text); margin-bottom: 20px;">æœªå‘½åç•ªèŒ„é’Ÿ</div>
                </div>
                
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-primary">
                        <i class="fas fa-play"></i> å¼€å§‹
                    </button>
                    <button id="pauseBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-pause"></i> æš‚åœ
                    </button>
                    <button id="resetBtn" class="btn btn-outline">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                    <button id="skipBtn" class="btn btn-outline">
                        <i class="fas fa-forward"></i> è·³è¿‡
                    </button>
                </div>

                <div class="settings-section">
                    <div class="settings-row">
                        <span class="time-label">ä¸“æ³¨æ—¶é—´ (åˆ†é’Ÿ):</span>
                        <div class="time-control">
                            <button class="time-btn" id="decreaseWorkTime">-</button>
                            <input type="number" id="workTimeInput" class="time-input" value="25" min="1" max="120">
                            <button class="time-btn" id="increaseWorkTime">+</button>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <span class="time-label">ä¼‘æ¯æ—¶é—´ (åˆ†é’Ÿ):</span>
                        <div class="time-control">
                            <button class="time-btn" id="decreaseBreakTime">-</button>
                            <input type="number" id="breakTimeInput" class="time-input" value="5" min="1" max="60">
                            <button class="time-btn" id="increaseBreakTime">+</button>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <span class="time-label">é•¿ä¼‘æ¯æ—¶é—´ (åˆ†é’Ÿ):</span>
                        <div class="time-control">
                            <button class="time-btn" id="decreaseLongBreakTime">-</button>
                            <input type="number" id="longBreakTimeInput" class="time-input" value="15" min="5" max="60">
                            <button class="time-btn" id="increaseLongBreakTime">+</button>
                        </div>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-value" id="pomodorosCompleted">0</div>
                        <div class="stat-label">å·²å®Œæˆç•ªèŒ„é’Ÿ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="focusTimeToday">0h 0m</div>
                        <div class="stat-label">ä»Šæ—¥ä¸“æ³¨æ—¶é•¿</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="tasksCompleted">0</div>
                        <div class="stat-label">å®Œæˆä»»åŠ¡æ•°</div>
                    </div>
                </div>
            </div>

            <div class="card tasks-section">
                <div class="tasks-header">
                    <h2><i class="fas fa-tasks"></i> ä»»åŠ¡åˆ—è¡¨</h2>
                    <button id="resetStatsBtn" class="btn btn-outline" style="padding: 8px 12px; font-size: 0.9rem;">
                        <i class="fas fa-trash-alt"></i> é‡ç½®ç»Ÿè®¡
                    </button>
                </div>
                
                <div class="task-input-group">
                    <input type="text" id="newTaskInput" class="task-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡...">
                    <button id="confirmAddTask" class="btn btn-primary" style="padding: 12px 20px;">
                        <i class="fas fa-plus"></i> æ·»åŠ 
                    </button>
                </div>
                
                <div id="taskList" class="tasks-list">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="history-section">
                    <h3><i class="fas fa-history"></i> æœ€è¿‘å®Œæˆ</h3>
                    <div id="historyList" class="history-list">
                        <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="control-buttons">
        <button id="settingsBtn" class="control-btn" title="è®¾ç½®">
            <i class="fas fa-cog"></i>
        </button>
        <button id="fullscreenBtn" class="control-btn" title="å…¨å±">
            <i class="fas fa-expand"></i>
        </button>
    </div>

    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="themeToggle" class="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">
        <i class="fas fa-moon"></i>
    </button>

    <!-- é€šçŸ¥åŒºåŸŸ -->
    <div id="notifications" class="notifications"></div>

    <!-- ç•ªèŒ„é’Ÿå‘½åæ¨¡æ€æ¡† -->
    <div id="pomodoroNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‘½åç•ªèŒ„é’Ÿ</h3>
                <button id="closeNameModal" class="task-btn" style="position: absolute; right: 20px; top: 20px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="pomodoroNameInput" class="modal-input" placeholder="è¾“å…¥ç•ªèŒ„é’Ÿåç§°..." value="">
                <select id="pomodoroCategory" class="modal-select">
                    <option value="å·¥ä½œ">å·¥ä½œ</option>
                    <option value="å­¦ä¹ ">å­¦ä¹ </option>
                    <option value="é˜…è¯»">é˜…è¯»</option>
                    <option value="ç¼–ç¨‹">ç¼–ç¨‹</option>
                    <option value="å†™ä½œ">å†™ä½œ</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="cancelNameBtn" class="btn btn-outline">å–æ¶ˆ</button>
                <button id="saveNameBtn" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€å¯¹è±¡
        window.timerState = {
            isRunning: false,
            isPaused: false,
            isWorkTime: true,
            timeLeft: 25 * 60, // 25åˆ†é’Ÿï¼Œä»¥ç§’ä¸ºå•ä½
            workTime: 25 * 60,
            breakTime: 5 * 60,
            longBreakTime: 15 * 60,
            pomodorosCompleted: 0,
            focusTimeToday: 0,
            tasksCompleted: 0,
            tasks: [],
            completedPomodoros: [],
            pomodoroName: "æœªå‘½åç•ªèŒ„é’Ÿ",
            pomodoroCategory: "å·¥ä½œ",
            timerInterval: null
        };

        // éŸ³é¢‘ç®¡ç†å™¨
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.initialized = false;
                this.sounds = {};
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                    console.log('[éŸ³é¢‘] éŸ³é¢‘ç³»ç»Ÿå·²åˆå§‹åŒ–');
                } catch (error) {
                    console.error('[éŸ³é¢‘] éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºå¤±è´¥:', error);
                }
            }

            playBeep(frequency = 800, duration = 0.5, type = 'sine') {
                if (!this.initialized || !this.audioContext) {
                    console.log('[éŸ³é¢‘] éŸ³é¢‘æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å£°éŸ³');
                    return;
                }

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (error) {
                    console.error('[éŸ³é¢‘] æ’­æ”¾å£°éŸ³å¤±è´¥:', error);
                }
            }

            playSound(type) {
                switch(type) {
                    case 'start':
                        this.playBeep(600, 0.3, 'sine');
                        break;
                    case 'pause':
                        this.playBeep(400, 0.3, 'sine');
                        break;
                    case 'complete':
                        this.playBeep(800, 1.0, 'sine');
                        setTimeout(() => this.playBeep(600, 0.5, 'sine'), 200);
                        setTimeout(() => this.playBeep(400, 0.5, 'sine'), 400);
                        break;
                    case 'alert':
                        this.playBeep(1000, 0.5, 'sine');
                        break;
                }
            }
        }

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[ç³»ç»Ÿ] ç•ªèŒ„é’Ÿè®¡æ—¶å™¨åˆå§‹åŒ–...');
            init();
        });

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            console.log('[ç³»ç»Ÿ] åŠ è½½æ•°æ®...');
            loadFromStorage();
            updateDisplay();
            updateStats();
            renderTaskList();
            renderHistory();
            setupEventListeners();
            initNotifications();
            
            // éŸ³é¢‘ç®¡ç†å™¨å°†åœ¨ç”¨æˆ·äº¤äº’æ—¶åˆå§‹åŒ–
            window.audioManager = new AudioManager();
            
            console.log('[ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆ');
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem('pomodoroTimerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    Object.assign(window.timerState, data);
                    
                    // å¦‚æœä»Šå¤©çš„æ•°æ®æ˜¯æ˜¨å¤©çš„ï¼Œé‡ç½®æ¯æ—¥ç»Ÿè®¡
                    const today = new Date().toDateString();
                    const savedDate = new Date(data.lastSaved).toDateString();
                    if (today !== savedDate) {
                        window.timerState.focusTimeToday = 0;
                        window.timerState.tasksCompleted = 0;
                        window.timerState.completedPomodoros = window.timerState.completedPomodoros.filter(pomodoro => {
                            return new Date(pomodoro.completedAt).toDateString() === today;
                        });
                    }
                    
                    console.log('[å­˜å‚¨] æ•°æ®åŠ è½½æˆåŠŸ');
                }
            } catch (error) {
                console.error('[å­˜å‚¨] åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage() {
            try {
                const data = {
                    ...window.timerState,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('pomodoroTimerData', JSON.stringify(data));
                console.log('[å­˜å‚¨] æ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('[å­˜å‚¨] ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const { timeLeft, isWorkTime } = window.timerState;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ›´æ–°çŠ¶æ€
            const statusElement = document.getElementById('timerStatus');
            if (window.timerState.isRunning) {
                statusElement.textContent = window.timerState.isWorkTime ? 'ä¸“æ³¨ä¸­...' : 'ä¼‘æ¯ä¸­...';
                document.getElementById('timerDisplay').classList.add('running');
            } else if (window.timerState.isPaused) {
                statusElement.textContent = 'å·²æš‚åœ';
                document.getElementById('timerDisplay').classList.remove('running');
            } else {
                statusElement.textContent = window.timerState.isWorkTime ? 'å‡†å¤‡ä¸“æ³¨' : 'å‡†å¤‡ä¼‘æ¯';
                document.getElementById('timerDisplay').classList.remove('running');
            }
            
            // æ›´æ–°æ—¶é—´è¾“å…¥æ¡†
            document.getElementById('workTimeInput').value = Math.floor(window.timerState.workTime / 60);
            document.getElementById('breakTimeInput').value = Math.floor(window.timerState.breakTime / 60);
            document.getElementById('longBreakTimeInput').value = Math.floor(window.timerState.longBreakTime / 60);
            
            // æ›´æ–°è®¡æ—¶å™¨é¢œè‰²
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.className = 'timer-time';
            timerDisplay.classList.add(isWorkTime ? 'work' : 'break');
            
            // æ›´æ–°ç•ªèŒ„é’Ÿåç§°
            document.getElementById('pomodoroName').textContent = window.timerState.pomodoroName;
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('pomodorosCompleted').textContent = window.timerState.pomodorosCompleted;
            document.getElementById('focusTimeToday').textContent = formatTime(window.timerState.focusTimeToday);
            document.getElementById('tasksCompleted').textContent = window.timerState.tasksCompleted;
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            const { tasks } = window.timerState;
            
            taskList.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                         data-index="${index}"></div>
                    <div class="task-content">
                        <div class="task-name">${task.name}</div>
                        <div class="task-pomodoros">é¢„è®¡: ${task.estimatedPomodoros || 1} ä¸ªç•ªèŒ„</div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn edit-task" data-index="${index}" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-btn delete-task" data-index="${index}" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskElement);
            });
            
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="task-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-tasks" style="margin-right: 10px;"></i>
                        æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»"æ·»åŠ "åˆ›å»ºæ–°ä»»åŠ¡
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const { completedPomodoros } = window.timerState;
            
            historyList.innerHTML = '';
            
            const recentHistory = completedPomodoros.slice(-10).reverse();
            
            recentHistory.forEach((pomodoro, index) => {
                const historyElement = document.createElement('div');
                historyElement.className = 'history-item';
                
                const time = new Date(pomodoro.completedAt).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                historyElement.innerHTML = `
                    <div class="history-info">
                        <div class="history-task">${pomodoro.name || 'æœªå‘½åç•ªèŒ„é’Ÿ'}</div>
                        <div class="history-time">${time}</div>
                    </div>
                    <div class="history-duration">${Math.floor(pomodoro.workTime / 60)}m</div>
                `;
                
                historyList.appendChild(historyElement);
            });
            
            if (recentHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                        æš‚æ— å†å²è®°å½•
                    </div>
                `;
            }
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            window.timerState.isRunning = true;
            window.timerState.isPaused = false;
            
            // åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨
            if (window.audioManager && !window.audioManager.initialized) {
                window.audioManager.init();
            }
            
            // æ’­æ”¾å¼€å§‹å£°éŸ³
            if (window.audioManager && window.audioManager.initialized) {
                window.audioManager.playSound('start');
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> è¿è¡Œä¸­';
            
            // è®¾ç½®å®šæ—¶å™¨
            window.timerState.timerInterval = setInterval(() => {
                window.timerState.timeLeft--;
                
                if (window.timerState.timeLeft <= 0) {
                    completeTimer();
                }
                
                updateDisplay();
                
                if (window.timerState.timeLeft % 10 === 0) {
                    saveToStorage();
                }
            }, 1000);
            
            console.log('[è®¡æ—¶å™¨] è®¡æ—¶å™¨å·²å¯åŠ¨');
        }

        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            if (!window.timerState.isRunning || window.timerState.isPaused) return;
            
            window.timerState.isPaused = true;
            clearInterval(window.timerState.timerInterval);
            
            // æ’­æ”¾æš‚åœå£°éŸ³
            if (window.audioManager && window.audioManager.initialized) {
                window.audioManager.playSound('pause');
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
            
            console.log('[è®¡æ—¶å™¨] è®¡æ—¶å™¨å·²æš‚åœ');
        }

        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[è®¡æ—¶å™¨] è®¡æ—¶å™¨å·²é‡ç½®');
        }

        // å®Œæˆè®¡æ—¶å™¨
        function completeTimer() {
            clearInterval(window.timerState.timerInterval);
            
            const { isWorkTime, workTime, pomodorosCompleted, focusTimeToday, completedPomodoros } = window.timerState;
            
            if (isWorkTime) {
                window.timerState.pomodorosCompleted++;
                window.timerState.focusTimeToday += workTime;
                
                completedPomodoros.push({
                    name: window.timerState.pomodoroName,
                    workTime: workTime,
                    completedAt: new Date().toISOString(),
                    category: window.timerState.pomodoroCategory
                });
                
                const shouldTakeLongBreak = window.timerState.pomodorosCompleted % 4 === 0;
                
                window.timerState.isWorkTime = false;
                window.timerState.timeLeft = shouldTakeLongBreak ? 
                    window.timerState.longBreakTime : 
                    window.timerState.breakTime;
                
                // æ’­æ”¾å®Œæˆå£°éŸ³
                if (window.audioManager && window.audioManager.initialized) {
                    window.audioManager.playSound('complete');
                }
                
                const message = shouldTakeLongBreak ? 
                    'ä¸“æ³¨æ—¶é—´ç»“æŸï¼ç°åœ¨æ˜¯é•¿ä¼‘æ¯æ—¶é—´ã€‚' : 
                    'ä¸“æ³¨æ—¶é—´ç»“æŸï¼ç°åœ¨æ˜¯ä¼‘æ¯æ—¶é—´ã€‚';
                showNotification(message, 'success');
                
                if (Notification.permission === 'granted') {
                    new Notification('ç•ªèŒ„é’Ÿå®Œæˆï¼', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff6b6b"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
                    });
                }
                
                console.log('[è®¡æ—¶å™¨] ä¸“æ³¨æ—¶é—´å®Œæˆï¼Œè¿›å…¥ä¼‘æ¯æ—¶é—´');
            } else {
                window.timerState.isWorkTime = true;
                window.timerState.timeLeft = window.timerState.workTime;
                
                if (window.audioManager && window.audioManager.initialized) {
                    window.audioManager.playSound('alert');
                }
                
                showNotification('ä¼‘æ¯æ—¶é—´ç»“æŸï¼å¼€å§‹ä¸‹ä¸€ä¸ªä¸“æ³¨æ—¶æ®µã€‚', 'info');
                console.log('[è®¡æ—¶å™¨] ä¼‘æ¯æ—¶é—´ç»“æŸï¼Œå¼€å§‹ä¸“æ³¨æ—¶é—´');
            }
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹';
            
            updateDisplay();
            updateStats();
            renderHistory();
            saveToStorage();
            
            if (window.timerState.isWorkTime) {
                setTimeout(() => {
                    showPomodoroNameModal();
                }, 500);
            }
        }

        // è·³è¿‡å½“å‰æ—¶æ®µ
        function skipTimer() {
            if (window.timerState.isRunning) {
                if (!confirm('ç¡®å®šè¦è·³è¿‡å½“å‰æ—¶æ®µå—ï¼Ÿ')) {
                    return;
                }
            }
            
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isWorkTime = !window.timerState.isWorkTime;
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[è®¡æ—¶å™¨] å·²è·³è¿‡å½“å‰æ—¶æ®µ');
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} notification-icon"></i>
                <span>${message}</span>
            `;
            
            notifications.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // è·å–é€šçŸ¥å›¾æ ‡
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': 
                default: return 'fa-info-circle';
            }
        }

        // æ˜¾ç¤ºç•ªèŒ„é’Ÿå‘½åæ¨¡æ€æ¡†
        function showPomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            const nameInput = document.getElementById('pomodoroNameInput');
            const categorySelect = document.getElementById('pomodoroCategory');
            
            nameInput.value = window.timerState.pomodoroName;
            categorySelect.value = window.timerState.pomodoroCategory;
            
            modal.classList.add('show');
            nameInput.focus();
            
            console.log('[æ¨¡æ€æ¡†] æ˜¾ç¤ºç•ªèŒ„é’Ÿå‘½åæ¨¡æ€æ¡†');
        }

        // éšè—ç•ªèŒ„é’Ÿå‘½åæ¨¡æ€æ¡†
        function hidePomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            modal.classList.remove('show');
        }

        // åˆå§‹åŒ–é€šçŸ¥æƒé™
        function initNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                // å¯ä»¥è¯·æ±‚æƒé™
                console.log('[é€šçŸ¥] å¯ä»¥è¯·æ±‚é€šçŸ¥æƒé™');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            console.log('[ç³»ç»Ÿ] è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            
            // éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ–
            let audioManagerInitialized = false;
            
            // ç”¨æˆ·äº¤äº’æ—¶åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨
            const initAudioOnInteraction = () => {
                if (!audioManagerInitialized) {
                    window.audioManager.init();
                    audioManagerInitialized = true;
                    console.log('[éŸ³é¢‘] éŸ³é¢‘ç®¡ç†å™¨å·²åˆå§‹åŒ–');
                }
            };
            
            // æ·»åŠ ç”¨æˆ·äº¤äº’äº‹ä»¶
            const interactionEvents = ['click', 'touchstart', 'keydown', 'mousedown'];
            interactionEvents.forEach(event => {
                document.addEventListener(event, initAudioOnInteraction, { once: true });
            });
            
            // è®¡æ—¶å™¨æ§åˆ¶æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                startTimer();
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                pauseTimer();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                resetTimer();
            });
            
            document.getElementById('skipBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                skipTimer();
            });
            
            // æ—¶é—´è®¾ç½®æŒ‰é’®
            document.getElementById('increaseWorkTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeWorkTime(1);
            });
            
            document.getElementById('decreaseWorkTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeWorkTime(-1);
            });
            
            document.getElementById('increaseBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeBreakTime(1);
            });
            
            document.getElementById('decreaseBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeBreakTime(-1);
            });
            
            document.getElementById('increaseLongBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeLongBreakTime(1);
            });
            
            document.getElementById('decreaseLongBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeLongBreakTime(-1);
            });
            
            // æ—¶é—´è¾“å…¥æ¡†äº‹ä»¶
            const timeInputs = ['workTimeInput', 'breakTimeInput', 'longBreakTimeInput'];
            timeInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('blur', function() {
                    initAudioOnInteraction();
                    const value = parseInt(this.value) || 1;
                    const min = 1;
                    const max = 120;
                    const validatedValue = Math.max(min, Math.min(max, value));
                    
                    this.value = validatedValue;
                    
                    if (id === 'workTimeInput') {
                        window.timerState.workTime = validatedValue * 60;
                        if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.workTime;
                        }
                    } else if (id === 'breakTimeInput') {
                        window.timerState.breakTime = validatedValue * 60;
                        if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.breakTime;
                        }
                    } else if (id === 'longBreakTimeInput') {
                        window.timerState.longBreakTime = validatedValue * 60;
                    }
                    
                    updateDisplay();
                    saveToStorage();
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });
            
            // ç»Ÿè®¡é‡ç½®æŒ‰é’®
            document.getElementById('resetStatsBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    window.timerState.pomodorosCompleted = 0;
                    window.timerState.focusTimeToday = 0;
                    window.timerState.tasksCompleted = 0;
                    window.timerState.completedPomodoros = [];
                    updateStats();
                    renderHistory();
                    saveToStorage();
                    showNotification('ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®', 'success');
                }
            });
            
            // ä»»åŠ¡ç›¸å…³æŒ‰é’®
            document.getElementById('addTaskBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                const input = document.getElementById('newTaskInput');
                input.focus();
                input.select();
            });
            
            document.getElementById('confirmAddTask').addEventListener('click', () => {
                initAudioOnInteraction();
                addNewTask();
            });
            
            document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    initAudioOnInteraction();
                    addNewTask();
                }
            });
            
            // å†å²è®°å½•æ¸…ç©ºæŒ‰é’®
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    window.timerState.completedPomodoros = [];
                    renderHistory();
                    saveToStorage();
                    showNotification('å†å²è®°å½•å·²æ¸…ç©º', 'success');
                }
            });
            
            // æ¨¡æ€æ¡†ç›¸å…³æŒ‰é’®
            document.getElementById('closeNameModal').addEventListener('click', () => {
                initAudioOnInteraction();
                hidePomodoroNameModal();
            });
            
            document.getElementById('cancelNameBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                hidePomodoroNameModal();
            });
            
            document.getElementById('saveNameBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                const name = document.getElementById('pomodoroNameInput').value.trim();
                const category = document.getElementById('pomodoroCategory').value;
                
                if (name) {
                    window.timerState.pomodoroName = name;
                    window.timerState.pomodoroCategory = category;
                    document.getElementById('pomodoroName').textContent = name;
                    hidePomodoroNameModal();
                    saveToStorage();
                    showNotification('ç•ªèŒ„é’Ÿåç§°å·²æ›´æ–°', 'success');
                } else {
                    showNotification('è¯·è¾“å…¥ç•ªèŒ„é’Ÿåç§°', 'error');
                }
            });
            
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settingsBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                showNotification('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            });
            
            // å…¨å±æŒ‰é’®
            document.getElementById('fullscreenBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                toggleFullscreen();
            });
            
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            document.getElementById('themeToggle').addEventListener('click', function() {
                initAudioOnInteraction();
                toggleTheme();
            });
            
            // ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨
            document.getElementById('taskList').addEventListener('click', function(e) {
                initAudioOnInteraction();
                const target = e.target;
                const taskItem = target.closest('.task-item');
                
                if (!taskItem) return;
                
                const index = parseInt(taskItem.querySelector('.task-checkbox').dataset.index);
                
                if (target.classList.contains('task-checkbox')) {
                    toggleTaskCompletion(index);
                } else if (target.closest('.edit-task')) {
                    editTask(index);
                } else if (target.closest('.delete-task')) {
                    deleteTask(index);
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('pomodoroNameModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePomodoroNameModal();
                }
            });
            
            // æŒ‰é”®äº‹ä»¶
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case ' ':
                    case 'Spacebar':
                        e.preventDefault();
                        initAudioOnInteraction();
                        if (window.timerState.isRunning) {
                            pauseTimer();
                        } else {
                            startTimer();
                        }
                        break;
                    case 'Escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                        hidePomodoroNameModal();
                        break;
                    case 'r':
                    case 'R':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            initAudioOnInteraction();
                            resetTimer();
                        }
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            initAudioOnInteraction();
                            skipTimer();
                        }
                        break;
                }
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[ç³»ç»Ÿ] é¡µé¢è¿›å…¥åå°');
                } else {
                    console.log('[ç³»ç»Ÿ] é¡µé¢è¿”å›å‰å°');
                }
            });
            
            // é¡µé¢å¸è½½å‰ä¿å­˜
            window.addEventListener('beforeunload', function() {
                saveToStorage();
                console.log('[ç³»ç»Ÿ] é¡µé¢å¸è½½ï¼Œæ•°æ®å·²ä¿å­˜');
            });
            
            console.log('[ç³»ç»Ÿ] äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        // ä¿®æ”¹ä¸“æ³¨æ—¶é—´
        function changeWorkTime(delta) {
            const newTime = Math.max(1, Math.min(120, Math.floor(window.timerState.workTime / 60) + delta));
            window.timerState.workTime = newTime * 60;
            
            if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.workTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // ä¿®æ”¹ä¼‘æ¯æ—¶é—´
        function changeBreakTime(delta) {
            const newTime = Math.max(1, Math.min(60, Math.floor(window.timerState.breakTime / 60) + delta));
            window.timerState.breakTime = newTime * 60;
            
            if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.breakTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // ä¿®æ”¹é•¿ä¼‘æ¯æ—¶é—´
        function changeLongBreakTime(delta) {
            const newTime = Math.max(5, Math.min(60, Math.floor(window.timerState.longBreakTime / 60) + delta));
            window.timerState.longBreakTime = newTime * 60;
            updateDisplay();
            saveToStorage();
        }

        // æ·»åŠ æ–°ä»»åŠ¡
        function addNewTask() {
            const input = document.getElementById('newTaskInput');
            const name = input.value.trim();
            
            if (!name) {
                showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');
                input.focus();
                return;
            }
            
            const task = {
                id: Date.now(),
                name: name,
                completed: false,
                createdAt: new Date().toISOString(),
                estimatedPomodoros: 1
            };
            
            window.timerState.tasks.push(task);
            input.value = '';
            renderTaskList();
            saveToStorage();
            
            showNotification('ä»»åŠ¡å·²æ·»åŠ ', 'success');
        }

        // åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function toggleTaskCompletion(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                window.timerState.tasks[index].completed = !window.timerState.tasks[index].completed;
                
                if (window.timerState.tasks[index].completed) {
                    window.timerState.tasksCompleted++;
                } else {
                    window.timerState.tasksCompleted--;
                }
                
                renderTaskList();
                updateStats();
                saveToStorage();
                
                const message = window.timerState.tasks[index].completed ? 
                    'ä»»åŠ¡å·²å®Œæˆï¼' : 'ä»»åŠ¡å·²å–æ¶ˆå®Œæˆ';
                showNotification(message, 'success');
            }
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(index) {
            const task = window.timerState.tasks[index];
            const newName = prompt('ç¼–è¾‘ä»»åŠ¡åç§°:', task.name);
            
            if (newName && newName.trim()) {
                task.name = newName.trim();
                renderTaskList();
                saveToStorage();
                showNotification('ä»»åŠ¡å·²æ›´æ–°', 'success');
            }
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                const task = window.timerState.tasks[index];
                
                if (task.completed) {
                    window.timerState.tasksCompleted--;
                }
                
                window.timerState.tasks.splice(index, 1);
                renderTaskList();
                updateStats();
                saveToStorage();
                showNotification('ä»»åŠ¡å·²åˆ é™¤', 'success');
            }
        }

        // åˆ‡æ¢å…¨å±
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('å…¨å±è¯·æ±‚å¤±è´¥:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-theme');
            const icon = document.querySelector('#themeToggle i');
            
            if (isLight) {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
            
            saveToStorage();
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–æ£€æŸ¥
        window.addEventListener('load', function() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®
            const isFirstVisit = !localStorage.getItem('pomodoroTimerFirstVisit');
            if (isFirstVisit) {
                setTimeout(() => {
                    showNotification('æ¬¢è¿ä½¿ç”¨ç•ªèŒ„é’Ÿè®¡æ—¶å™¨ï¼æŒ‰ç©ºæ ¼é”®å¯ä»¥å¿«é€Ÿå¼€å§‹/æš‚åœè®¡æ—¶ã€‚', 'info');
                    localStorage.setItem('pomodoroTimerFirstVisit', 'true');
                }, 2000);
            }
            
            // æ£€æŸ¥æœåŠ¡å·¥ä½œè€…æ”¯æŒ
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('[ç³»ç»Ÿ] Service Worker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸï¼š', registration.scope);
                })
                .catch(error => {
                    console.log('[ç³»ç»Ÿ] Service Worker æ³¨å†Œå¤±è´¥ï¼š', error);
                });
            }
            
            // æ£€æŸ¥ç¦»çº¿çŠ¶æ€
            window.addEventListener('online', function() {
                showNotification('å·²æ¢å¤ç½‘ç»œè¿æ¥', 'success');
            });
            
            window.addEventListener('offline', function() {
                showNotification('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä½†è®¡æ—¶å™¨å¯ç»§ç»­æœ¬åœ°å·¥ä½œ', 'warning');
            });
            
            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š
            if (!('indexedDB' in window)) {
                console.warn('[ç³»ç»Ÿ] IndexedDB ä¸æ”¯æŒï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™');
            }
            
            if (!('serviceWorker' in navigator)) {
                console.warn('[ç³»ç»Ÿ] Service Worker ä¸æ”¯æŒï¼Œæ— æ³•ç¦»çº¿ä½¿ç”¨');
            }
        });

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æç¤º
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: 'ç©ºæ ¼é”®', action: 'å¼€å§‹/æš‚åœè®¡æ—¶' },
                { key: 'R', action: 'é‡ç½®è®¡æ—¶' },
                { key: 'S', action: 'è·³è¿‡å½“å‰æ—¶æ®µ' },
                { key: 'ESC', action: 'é€€å‡ºå…¨å±/å…³é—­æ¨¡æ€æ¡†' },
                { key: 'F11 æˆ– å…¨å±æŒ‰é’®', action: 'åˆ‡æ¢å…¨å±æ¨¡å¼' }
            ];
            
            let message = 'é”®ç›˜å¿«æ·é”®ï¼š\n';
            shortcuts.forEach(shortcut => {
                message += `${shortcut.key}: ${shortcut.action}\n`;
            });
            
            alert(message);
        }

        // æ·»åŠ å¿«æ·é”®å¸®åŠ©èœå•
        document.addEventListener('keydown', function(e) {
            // Ctrl + / æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
            if (e.key === '?' && e.ctrlKey) {
                e.preventDefault();
                showKeyboardShortcuts();
            }
            
            // Ctrl + S ä¿å­˜å½“å‰çŠ¶æ€
            if (e.key === 's' && e.ctrlKey && !e.altKey) {
                e.preventDefault();
                saveToStorage();
                showNotification('æ•°æ®å·²ä¿å­˜', 'success');
            }
        });

        // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        let touchStartY = 0;
        let touchStartX = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndX = e.changedTouches[0].clientX;
            const deltaY = touchStartY - touchEndY;
            const deltaX = touchStartX - touchEndX;
            
            // æ°´å¹³æ»‘åŠ¨å¤§äºå‚ç›´æ»‘åŠ¨
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // å·¦æ»‘
                if (deltaX > 50) {
                    skipTimer();
                    e.preventDefault();
                }
                // å³æ»‘
                else if (deltaX < -50) {
                    resetTimer();
                    e.preventDefault();
                }
            }
            // å‚ç›´æ»‘åŠ¨
            else {
                // ä¸‹æ»‘
                if (deltaY > 50) {
                    if (window.timerState.isRunning) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                    e.preventDefault();
                }
            }
            
            touchStartX = 0;
            touchStartY = 0;
        });

        console.log('[ç³»ç»Ÿ] ç•ªèŒ„é’Ÿè®¡æ—¶å™¨å·²å®Œå…¨åŠ è½½ï¼');
        console.log('[ç³»ç»Ÿ] ç‰ˆæœ¬: 2.0.0 | é«˜çº§åŠŸèƒ½å·²å¯ç”¨');
    </script>
</body>
</html>
// æ·»åŠ ä»»åŠ¡è¾“å…¥æ¡†
        const newTaskInput = document.getElementById('newTaskInput');
        
        // ä»»åŠ¡è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
        newTaskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewTask();
            }
        });

        // æ·»åŠ ä»»åŠ¡æŒ‰é’®äº‹ä»¶
        document.getElementById('confirmAddTask').addEventListener('click', addNewTask);

        // æ·»åŠ ä»»åŠ¡åŠŸèƒ½
        function addNewTask() {
            const taskInput = document.getElementById('newTaskInput');
            const taskName = taskInput.value.trim();
            
            if (!taskName) {
                showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                name: taskName,
                completed: false,
                createdAt: new Date().toISOString(),
                estimatedPomodoros: 1
            };
            
            window.timerState.tasks.unshift(newTask);
            taskInput.value = '';
            
            renderTaskList();
            saveToStorage();
            showNotification('ä»»åŠ¡å·²æ·»åŠ ', 'success');
        }

        // ä»»åŠ¡æ“ä½œåŠŸèƒ½
        function toggleTaskCompletion(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                const task = window.timerState.tasks[index];
                task.completed = !task.completed;
                
                if (task.completed) {
                    window.timerState.tasksCompleted++;
                } else {
                    window.timerState.tasksCompleted = Math.max(0, window.timerState.tasksCompleted - 1);
                }
                
                renderTaskList();
                updateStats();
                saveToStorage();
                
                const message = task.completed ? 'ä»»åŠ¡å·²å®Œæˆï¼' : 'ä»»åŠ¡å·²æ ‡è®°ä¸ºæœªå®Œæˆ';
                showNotification(message, task.completed ? 'success' : 'info');
            }
        }

        function editTask(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                const task = window.timerState.tasks[index];
                const newName = prompt('ç¼–è¾‘ä»»åŠ¡åç§°:', task.name);
                
                if (newName !== null && newName.trim() !== '') {
                    task.name = newName.trim();
                    task.updatedAt = new Date().toISOString();
                    renderTaskList();
                    saveToStorage();
                    showNotification('ä»»åŠ¡å·²æ›´æ–°', 'success');
                }
            }
        }

        function deleteTask(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                const task = window.timerState.tasks[index];
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${task.name}"å—ï¼Ÿ`)) {
                    if (task.completed) {
                        window.timerState.tasksCompleted = Math.max(0, window.timerState.tasksCompleted - 1);
                    }
                    
                    window.timerState.tasks.splice(index, 1);
                    renderTaskList();
                    updateStats();
                    saveToStorage();
                    showNotification('ä»»åŠ¡å·²åˆ é™¤', 'success');
                }
            }
        }

        // å…¨å±åˆ‡æ¢åŠŸèƒ½
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            
            const themeToggleIcon = document.querySelector('#themeToggle i');
            if (document.body.classList.contains('light-theme')) {
                themeToggleIcon.className = 'fas fa-sun';
                document.body.style.backgroundColor = '#f5f6fa';
                document.documentElement.style.backgroundColor = '#f5f6fa';
            } else {
                themeToggleIcon.className = 'fas fa-moon';
                document.body.style.backgroundColor = '';
                document.documentElement.style.backgroundColor = '';
            }
            
            // ä¿å­˜ä¸»é¢˜åå¥½
            localStorage.setItem('pomodoroTheme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
        }

        // åŠ è½½ä¸»é¢˜åå¥½
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('pomodoroTheme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                const themeToggleIcon = document.querySelector('#themeToggle i');
                if (themeToggleIcon) {
                    themeToggleIcon.className = 'fas fa-sun';
                }
            }
        }

        // å±å¹•æ–¹å‘é”å®šåŠŸèƒ½
        function toggleScreenLock() {
            if ('screen' in window && 'orientation' in window.screen) {
                if (window.screen.orientation && 'lock' in window.screen.orientation) {
                    if (!window.screen.orientation.type.includes('landscape')) {
                        window.screen.orientation.lock('landscape').then(() => {
                            showNotification('å±å¹•æ–¹å‘å·²é”å®šä¸ºæ¨ªå±', 'info');
                        }).catch(() => {
                            showNotification('æ— æ³•é”å®šå±å¹•æ–¹å‘', 'warning');
                        });
                    } else {
                        window.screen.orientation.unlock();
                        showNotification('å±å¹•æ–¹å‘é”å®šå·²è§£é™¤', 'info');
                    }
                } else {
                    showNotification('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå±å¹•æ–¹å‘é”å®š', 'warning');
                }
            } else {
                showNotification('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå±å¹•æ–¹å‘API', 'warning');
            }
        }

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportData() {
            try {
                const exportData = {
                    timerState: window.timerState,
                    exportDate: new Date().toISOString(),
                    version: '2.0.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `pomodoro-data-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('[å¯¼å‡º] æ•°æ®å¯¼å‡ºå¤±è´¥:', error);
                showNotification('æ•°æ®å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ•°æ®å¯¼å…¥åŠŸèƒ½
        function importData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.timerState) {
                            throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                        }
                        
                        if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                            Object.assign(window.timerState, importedData.timerState);
                            updateDisplay();
                            updateStats();
                            renderTaskList();
                            renderHistory();
                            saveToStorage();
                            
                            showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                        }
                    } catch (error) {
                        console.error('[å¯¼å…¥] æ•°æ®å¯¼å…¥å¤±è´¥:', error);
                        showNotification('æ•°æ®å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // é‡ç½®æ•°æ®ç¡®è®¤
        document.getElementById('resetStatsBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯å—ï¼Ÿè¿™å°†æ¸…é™¤å·²å®Œæˆç•ªèŒ„é’Ÿã€ä¸“æ³¨æ—¶é•¿å’Œä»»åŠ¡å®Œæˆç»Ÿè®¡ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                window.timerState.pomodorosCompleted = 0;
                window.timerState.focusTimeToday = 0;
                window.timerState.tasksCompleted = 0;
                window.timerState.completedPomodoros = [];
                window.timerState.tasks = window.timerState.tasks.map(task => ({
                    ...task,
                    completed: false
                }));
                
                updateStats();
                renderTaskList();
                renderHistory();
                saveToStorage();
                
                showNotification('æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®', 'success');
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // é˜²æ­¢åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(e.key) {
                case ' ':
                case 'Spacebar':
                    e.preventDefault();
                    if (window.timerState.isRunning) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                    break;
                    
                case 'r':
                case 'R':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        resetTimer();
                    }
                    break;
                    
                case 's':
                case 'S':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        skipTimer();
                    }
                    break;
                    
                case 't':
                case 'T':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        toggleTheme();
                    }
                    break;
                    
                case 'f':
                case 'F':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        toggleFullscreen();
                    }
                    break;
                    
                case 'Escape':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    const modal = document.getElementById('pomodoroNameModal');
                    if (modal.classList.contains('show')) {
                        modal.classList.remove('show');
                    }
                    break;
                    
                case '1':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        changeWorkTime(-1);
                    }
                    break;
                    
                case '2':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        changeWorkTime(1);
                    }
                    break;
                    
                case '3':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        changeBreakTime(-1);
                    }
                    break;
                    
                case '4':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        changeBreakTime(1);
                    }
                    break;
                    
                case '?':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        showKeyboardShortcuts();
                    }
                    break;
            }
        });

        // å¸®åŠ©èœå•
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: 'ç©ºæ ¼é”®', action: 'å¼€å§‹/æš‚åœè®¡æ—¶å™¨' },
                { key: 'Ctrl/Cmd + R', action: 'é‡ç½®è®¡æ—¶å™¨' },
                { key: 'Ctrl/Cmd + S', action: 'è·³è¿‡å½“å‰æ—¶æ®µ' },
                { key: 'Ctrl/Cmd + T', action: 'åˆ‡æ¢ä¸»é¢˜' },
                { key: 'Ctrl/Cmd + F', action: 'åˆ‡æ¢å…¨å±æ¨¡å¼' },
                { key: 'ESC', action: 'é€€å‡ºå…¨å±/å…³é—­æ¨¡æ€æ¡†' },
                { key: 'Ctrl/Cmd + 1/2', action: 'å‡å°‘/å¢åŠ ä¸“æ³¨æ—¶é—´' },
                { key: 'Ctrl/Cmd + 3/4', action: 'å‡å°‘/å¢åŠ ä¼‘æ¯æ—¶é—´' },
                { key: 'Ctrl/Cmd + ?', action: 'æ˜¾ç¤ºé”®ç›˜å¿«æ·é”®' }
            ];
            
            let message = 'é”®ç›˜å¿«æ·é”®ï¼š\n\n';
            shortcuts.forEach(shortcut => {
                message += `${shortcut.key}: ${shortcut.action}\n`;
            });
            
            message += '\nè§¦æ‘¸æ‰‹åŠ¿ï¼š\n';
            message += 'â€¢ å‘å·¦æ»‘åŠ¨: è·³è¿‡å½“å‰æ—¶æ®µ\n';
            message += 'â€¢ å‘å³æ»‘åŠ¨: é‡ç½®è®¡æ—¶å™¨\n';
            message += 'â€¢ å‘ä¸‹æ»‘åŠ¨: å¼€å§‹/æš‚åœè®¡æ—¶å™¨';
            
            alert(message);
        }

        // åˆå§‹åŒ–åŠ è½½ä¸»é¢˜
        loadThemePreference();

        // è‡ªåŠ¨ä¿å­˜è®¡æ—¶å™¨
        setInterval(() => {
            if (window.timerState.isRunning) {
                saveToStorage();
            }
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡

        // é¡µé¢éšè—æ—¶è‡ªåŠ¨ä¿å­˜
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                saveToStorage();
            }
        });

        // çª—å£å…³é—­å‰ç¡®è®¤
        window.addEventListener('beforeunload', function(e) {
            if (window.timerState.isRunning) {
                e.preventDefault();
                e.returnValue = 'è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return e.returnValue;
            }
        });

        // è¯­éŸ³æ§åˆ¶åŠŸèƒ½
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = false;
            
            recognition.onresult = function(event) {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                console.log('[è¯­éŸ³] è¯†åˆ«åˆ°:', transcript);
                
                if (transcript.includes('å¼€å§‹') || transcript.includes('start')) {
                    startTimer();
                    showNotification('è¯­éŸ³æŒ‡ä»¤: å¼€å§‹è®¡æ—¶', 'success');
                } else if (transcript.includes('æš‚åœ') || transcript.includes('stop') || transcript.includes('pause')) {
                    pauseTimer();
                    showNotification('è¯­éŸ³æŒ‡ä»¤: æš‚åœè®¡æ—¶', 'success');
                } else if (transcript.includes('é‡ç½®') || transcript.includes('reset')) {
                    resetTimer();
                    showNotification('è¯­éŸ³æŒ‡ä»¤: é‡ç½®è®¡æ—¶', 'success');
                } else if (transcript.includes('è·³è¿‡') || transcript.includes('skip')) {
                    skipTimer();
                    showNotification('è¯­éŸ³æŒ‡ä»¤: è·³è¿‡æ—¶æ®µ', 'success');
                } else if (transcript.includes('ä¸“æ³¨æ—¶é—´')) {
                    const match = transcript.match(/\d+/);
                    if (match) {
                        const minutes = parseInt(match[0]);
                        if (minutes >= 1 && minutes <= 120) {
                            window.timerState.workTime = minutes * 60;
                            updateDisplay();
                            showNotification(`è¯­éŸ³æŒ‡ä»¤: ä¸“æ³¨æ—¶é—´è®¾ç½®ä¸º ${minutes} åˆ†é’Ÿ`, 'success');
                        }
                    }
                } else if (transcript.includes('ä¼‘æ¯æ—¶é—´')) {
                    const match = transcript.match(/\d+/);
                    if (match) {
                        const minutes = parseInt(match[0]);
                        if (minutes >= 1 && minutes <= 60) {
                            window.timerState.breakTime = minutes * 60;
                            updateDisplay();
                            showNotification(`è¯­éŸ³æŒ‡ä»¤: ä¼‘æ¯æ—¶é—´è®¾ç½®ä¸º ${minutes} åˆ†é’Ÿ`, 'success');
                        }
                    }
                }
            };
            
            // è¯­éŸ³æ§åˆ¶æŒ‰é’®
            const voiceBtn = document.createElement('button');
            voiceBtn.className = 'control-btn';
            voiceBtn.title = 'è¯­éŸ³æ§åˆ¶';
            voiceBtn.style.right = '200px';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.style.position = 'fixed';
            voiceBtn.style.bottom = '20px';
            document.body.appendChild(voiceBtn);
            
            let isListening = false;
            
            voiceBtn.addEventListener('click', function() {
                if (!isListening) {
                    try {
                        recognition.start();
                        isListening = true;
                        voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        voiceBtn.style.background = 'var(--primary-color)';
                        showNotification('è¯­éŸ³æ§åˆ¶å·²å¼€å¯', 'success');
                    } catch (error) {
                        console.error('[è¯­éŸ³] å¯åŠ¨å¤±è´¥:', error);
                        showNotification('è¯­éŸ³æ§åˆ¶å¯åŠ¨å¤±è´¥', 'error');
                    }
                } else {
                    recognition.stop();
                    isListening = false;
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    voiceBtn.style.background = '';
                    showNotification('è¯­éŸ³æ§åˆ¶å·²å…³é—­', 'info');
                }
            });
            
            recognition.onend = function() {
                if (isListening) {
                    // è‡ªåŠ¨é‡æ–°å¼€å§‹
                    setTimeout(() => recognition.start(), 100);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('[è¯­éŸ³] è¯†åˆ«é”™è¯¯:', event.error);
                isListening = false;
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceBtn.style.background = '';
            };
        }

        // æ€§èƒ½ç›‘æ§
        if ('performance' in window && 'memory' in window.performance) {
            setInterval(() => {
                const memory = window.performance.memory;
                if (memory) {
                    const usedMB = Math.round(memory.usedJSHeapSize / 1048576);
                    const totalMB = Math.round(memory.totalJSHeapSize / 1048576);
                    
                    if (usedMB > totalMB * 0.8) {
                        console.warn('[æ€§èƒ½] å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜:', `${usedMB}MB/${totalMB}MB`);
                        
                        // è§¦å‘åƒåœ¾å›æ”¶
                        if (window.gc) {
                            window.gc();
                        }
                    }
                }
            }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        }

        // ç¦»çº¿æ£€æµ‹
        window.addEventListener('online', () => {
            showNotification('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä½†åº”ç”¨å¯ç»§ç»­ç¦»çº¿ä½¿ç”¨', 'warning');
        });

        // é¡µé¢åŠ è½½åŠ¨ç”»
        window.addEventListener('load', () => {
            document.body.style.opacity = 0;
            document.body.style.transition = 'opacity 0.3s ease-in';
            
            setTimeout(() => {
                document.body.style.opacity = 1;
            }, 100);
        });

        console.log('[ç³»ç»Ÿ] æ‰€æœ‰ä»£ç åŠ è½½å®Œæˆ');
        console.log('[ç³»ç»Ÿ] ç•ªèŒ„é’Ÿè®¡æ—¶å™¨ 2.0.0 å·²å°±ç»ª');
        console.log('[ç³»ç»Ÿ] åŠŸèƒ½åˆ—è¡¨: è®¡æ—¶å™¨ã€ä»»åŠ¡ç®¡ç†ã€ç»Ÿè®¡ã€ä¸»é¢˜åˆ‡æ¢ã€å…¨å±ã€è¯­éŸ³æ§åˆ¶ã€ç¦»çº¿æ”¯æŒ');
    </script>
</body>
</html>
