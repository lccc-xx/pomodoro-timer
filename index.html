<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„é’Ÿæ—¶é—´ç®¡ç†å·¥å…· v6.2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 40px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h2 i {
            color: #3498db;
        }
        
        /* ç•ªèŒ„é’Ÿæ§åˆ¶åŒºåŸŸ */
        .timer-container {
            text-align: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 30px;
        }
        
        .timer-display {
            font-size: 5.5rem;
            font-weight: 300;
            color: white;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 233, 123, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(250, 112, 154, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* æ—¶é—´è®¾ç½® */
        .time-settings {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-input-group label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .time-input-group input {
            width: 80px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            transition: border-color 0.3s;
        }
        
        .time-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .preset-times {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .preset-time {
            padding: 8px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .preset-time:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        /* ä¸­æ–­æ§åˆ¶ */
        .interrupt-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .interrupt-controls input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 100px;
            font-size: 1rem;
        }
        
        .interrupt-timer {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e74c3c;
            margin: 10px 0;
            min-height: 40px;
            display: none;
        }
        
        .interrupt-timer.show {
            display: block;
            animation: pulse 1s infinite;
        }
        
        /* å£°éŸ³æ§åˆ¶ */
        .sound-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .volume-control input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
        }
        
        .sound-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sound-option {
            padding: 8px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sound-option:hover {
            background: #e0e0e0;
        }
        
        .sound-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* è®°å½•å’Œå†å² */
        .record-list, .history-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .record-item, .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .record-item.focus {
            border-left-color: #3498db;
        }
        
        .record-item.break {
            border-left-color: #2ecc71;
        }
        
        .no-records, .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        /* ç³»ç»Ÿæ—¥å¿— */
        .log-content {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            padding: 15px;
            background: #1a1a1a;
            color: #e0e0e0;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid;
        }
        
        .log-entry.info {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        
        .log-entry.success {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        
        .log-entry.warning {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }
        
        .log-entry.error {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        /* åŠ¨ç”» */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .timer-display {
                font-size: 4rem;
            }
            
            .timer-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .time-settings {
                flex-direction: column;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
        }
        
        /* å…¼å®¹æ€§è­¦å‘Š */
        .compatibility-warning {
            padding: 15px 20px;
            margin: 0 20px 20px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .compatibility-warning.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .compatibility-warning.success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .compatibility-warning ul {
            margin: 10px 0 0 20px;
        }
        
        /* è§¦æ‘¸åé¦ˆ */
        .touch-feedback {
            transform: scale(0.95);
            transition: transform 0.1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ… ç•ªèŒ„é’Ÿæ—¶é—´ç®¡ç†å·¥å…·</h1>
            <div class="subtitle">v6.2.0 - é«˜æ•ˆä¸“æ³¨ï¼Œæ™ºèƒ½æé†’ï¼Œä¸“ä¸šçº§æ—¶é—´ç®¡ç†ç³»ç»Ÿ</div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§åˆ—ï¼šä¸»è¦æ§åˆ¶ -->
            <div class="left-column">
                <!-- ç•ªèŒ„é’Ÿè®¡æ—¶å™¨ -->
                <div class="section">
                    <h2>â±ï¸ ç•ªèŒ„é’Ÿè®¡æ—¶å™¨</h2>
                    <div class="timer-container">
                        <div id="timerDisplay" class="timer-display">25:00</div>
                        <div id="pomodoroStatus" style="color: white; font-size: 1.2rem; margin-bottom: 20px;">ğŸ¯ å‡†å¤‡å¼€å§‹ä¸“æ³¨</div>
                        <div id="deviceStatus" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 10px;">ğŸ”§ æ­£åœ¨æ£€æŸ¥éŸ³é¢‘ç³»ç»Ÿ...</div>
                        
                        <div class="timer-controls">
                            <button id="startBtn" class="btn btn-primary">â–¶ï¸ å¼€å§‹ä¸“æ³¨</button>
                            <button id="pauseBtn" class="btn btn-secondary" disabled>â¸ï¸ æš‚åœ</button>
                            <button id="resetBtn" class="btn btn-warning">ğŸ”„ é‡ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- æ—¶é—´è®¾ç½® -->
                <div class="section">
                    <h2>âš™ï¸ æ—¶é—´è®¾ç½®</h2>
                    <div class="time-settings">
                        <div class="time-input-group">
                            <label>ä¸“æ³¨æ—¶é•¿:</label>
                            <input type="number" id="focusTime" min="1" max="120" value="25">
                            <span>åˆ†é’Ÿ</span>
                        </div>
                        <div class="time-input-group">
                            <label>ä¼‘æ¯æ—¶é•¿:</label>
                            <input type="number" id="breakTime" min="1" max="60" value="5">
                            <span>åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <h3 style="color: #666; margin-bottom: 10px;">å¿«é€Ÿé¢„è®¾</h3>
                        <div class="preset-times">
                            <button class="preset-time" data-minutes="15">15åˆ†é’Ÿ</button>
                            <button class="preset-time" data-minutes="25">25åˆ†é’Ÿ</button>
                            <button class="preset-time" data-minutes="30">30åˆ†é’Ÿ</button>
                            <button class="preset-time" data-minutes="45">45åˆ†é’Ÿ</button>
                            <button class="preset-time" data-minutes="60">60åˆ†é’Ÿ</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 20px;">
                        <input type="number" id="customMinutes" min="1" max="120" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿ" style="flex: 1;">
                        <button id="setCustomTimeBtn" class="btn btn-primary" style="padding: 10px 20px;">åº”ç”¨è‡ªå®šä¹‰æ—¶é—´</button>
                    </div>
                </div>

                <!-- ä¸­æ–­æ§åˆ¶ -->
                <div class="section">
                    <h2>â° æ™ºèƒ½ä¸­æ–­</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">è®¾ç½®ä¸­æ–­æ—¶é—´ï¼Œé¿å…è¿‡åº¦ä¸“æ³¨</p>
                    
                    <div class="interrupt-controls">
                        <input type="number" id="interruptMinutes" min="0" max="60" placeholder="åˆ†é’Ÿ" value="0">
                        <input type="number" id="interruptSeconds" min="0" max="59" placeholder="ç§’" value="30">
                        <input type="text" id="interruptReason" placeholder="ä¸­æ–­åŸå›  (å¯é€‰)" style="flex: 1;">
                        <button id="startInterruptBtn" class="btn btn-success">â±ï¸ å¼€å§‹ä¸­æ–­</button>
                        <button id="cancelInterruptBtn" class="btn btn-danger" style="display: none;">âŒ å–æ¶ˆä¸­æ–­</button>
                    </div>
                    
                    <div id="interruptTimerDisplay" class="interrupt-timer"></div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <h4 style="color: #666; margin-bottom: 10px;">å¿«é€Ÿæµ‹è¯•</h4>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="quick-test-btn btn" data-seconds="5" style="padding: 8px 15px;">5ç§’</button>
                            <button class="quick-test-btn btn" data-seconds="10" style="padding: 8px 15px;">10ç§’</button>
                            <button class="quick-test-btn btn" data-seconds="30" style="padding: 8px 15px;">30ç§’</button>
                            <button class="quick-test-btn btn" data-seconds="60" style="padding: 8px 15px;">1åˆ†é’Ÿ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§åˆ—ï¼šè®¾ç½®å’Œè®°å½• -->
            <div class="right-column">
                <!-- å£°éŸ³å’Œéœ‡åŠ¨æ§åˆ¶ -->
                <div class="section">
                    <h2>ğŸ”Š å£°éŸ³ä¸éœ‡åŠ¨</h2>
                    <div class="sound-controls">
                        <div class="volume-control">
                            <span>ğŸ”ˆ éŸ³é‡:</span>
                            <input type="range" id="volumeControl" min="0" max="100" value="50">
                            <span id="volumeValue">50%</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="vibrationToggle" checked>
                                <span>ğŸ“³ éœ‡åŠ¨æé†’</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="clickSoundToggle" checked>
                                <span>ğŸ‘† ç‚¹å‡»éŸ³æ•ˆ</span>
                            </label>
                        </div>
                        
                        <div>
                            <h4 style="color: #666; margin-bottom: 10px;">å£°éŸ³ç±»å‹</h4>
                            <div class="sound-options">
                                <div class="sound-option active" data-sound="beep">èœ‚é¸£å£°</div>
                                <div class="sound-option" data-sound="bell">é“ƒå£°</div>
                                <div class="sound-option" data-sound="chord">å’Œå¼¦éŸ³</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button id="testSoundBtn" class="btn btn-secondary" style="padding: 10px 20px; flex: 1;">ğŸµ æµ‹è¯•å£°éŸ³</button>
                            <button id="testSoundBtn2" class="btn btn-secondary" style="padding: 10px 20px; flex: 1;">ğŸ”Š æµ‹è¯•å£°éŸ³2</button>
                            <button id="stopSoundBtn" class="btn btn-warning" style="padding: 10px 20px; flex: 1;">ğŸ”‡ åœæ­¢æ‰€æœ‰å£°éŸ³</button>
                        </div>
                    </div>
                </div>

                <!-- è®°å½•å’Œç»Ÿè®¡ -->
                <div class="section">
                    <h2>ğŸ“Š è®°å½•ä¸ç»Ÿè®¡</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 0.9rem; color: #666;">ä»Šæ—¥å®Œæˆ</div>
                            <div id="todayCompleted" style="font-size: 2rem; font-weight: bold; color: #3498db;">0</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 0.9rem; color: #666;">æ€»å®Œæˆæ•°</div>
                            <div id="totalCompleted" style="font-size: 2rem; font-weight: bold; color: #2ecc71;">0</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="font-size: 0.9rem; color: #666;">æ€»ä¸“æ³¨(å°æ—¶)</div>
                            <div id="totalFocusTime" style="font-size: 2rem; font-weight: bold; color: #9b59b6;">0.0</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="font-size: 1.1rem;">ğŸ“‹ æœ€è¿‘è®°å½•</h3>
                            <div style="display: flex; gap: 10px;">
                                <button id="exportRecordsBtn" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ“¤ å¯¼å‡ºè®°å½•</button>
                                <button id="clearRecordsBtn" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                            </div>
                        </div>
                        <div id="recordList" class="record-list">
                            <div class="no-records">æš‚æ— è®°å½•ï¼Œå¼€å§‹æ‚¨çš„ç¬¬ä¸€ä¸ªç•ªèŒ„é’Ÿå§ï¼</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>ğŸ“ˆ ä¸­æ–­å†å²</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-history">æš‚æ— ä¸­æ–­è®°å½•</div>
                    </div>
                </div>

                <div class="section">
                    <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: #666;">å®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€</div>
                        <div style="display: flex; gap: 10px;">
                            <button id="clearLogBtn" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">æ¸…ç©ºæ—¥å¿—</button>
                            <button id="toggleLogBtn" class="btn" style="padding: 8px 15px; font-size: 0.9rem;">éšè—æ—¥å¿—</button>
                        </div>
                    </div>
                    <div id="logContent" class="log-content">
                        <!-- æ—¥å¿—å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>

        <div id="statusBar" class="status-bar"></div>
    </div>

    <script>
        'use strict';
        
        // éŸ³é¢‘ç”Ÿæˆå™¨ç±»
        class AudioGenerator {
            constructor() {
                this.audioContext = null;
                this.activeSounds = new Set();
                this.initialized = false;
                this.initialize();
            }
            
            initialize() {
                try {
                    if (window.AudioContext || window.webkitAudioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.initialized = true;
                        addLogEntry('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ', 'success', 'éŸ³é¢‘');
                    } else {
                        addLogEntry('æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API', 'warning', 'éŸ³é¢‘');
                    }
                } catch (error) {
                    addLogEntry(`éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                }
            }
            
            async ensureRunning() {
                try {
                    if (!this.audioContext) {
                        this.initialize();
                        if (!this.audioContext) {
                            return false;
                        }
                    }
                    
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                        addLogEntry('AudioContextæ¢å¤æˆåŠŸ', 'success', 'éŸ³é¢‘');
                    }
                    
                    return this.audioContext.state === 'running';
                } catch (error) {
                    addLogEntry(`AudioContextå¯åŠ¨å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                    return false;
                }
            }
            
            getAudioContext() {
                try {
                    return this.audioContext || null;
                } catch (error) {
                    addLogEntry(`è·å–AudioContextå¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                    return null;
                }
            }
            
            playBeep(frequency = 800, duration = 0.5, volume = 0.5) {
                return this.playTone(frequency, duration, volume, 'sine');
            }
            
            playBell(frequency = 440, duration = 1, volume = 0.5) {
                return this.playTone(frequency, duration, volume, 'sine', true);
            }
            
            playChord(duration = 1, volume = 0.5) {
                return this.playTone(440, duration, volume, 'sine', true, [523.25, 659.25]);
            }
            
            playClick(frequency = 1000, duration = 0.1, volume = 0.3) {
                return this.playTone(frequency, duration, volume, 'square');
            }
            
            playTone(baseFrequency, duration, volume, type = 'sine', fadeOut = false, additionalFrequencies = []) {
                if (!this.audioContext || !window.userInteracted) {
                    addLogEntry('éŸ³é¢‘æœªåˆå§‹åŒ–æˆ–æœªæ¿€æ´»', 'warning', 'éŸ³é¢‘');
                    return false;
                }
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = type;
                    oscillator.frequency.value = baseFrequency;
                    gainNode.gain.value = volume;
                    
                    const now = this.audioContext.currentTime;
                    oscillator.start(now);
                    
                    if (fadeOut) {
                        gainNode.gain.setValueAtTime(volume, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    }
                    
                    if (additionalFrequencies && additionalFrequencies.length > 0) {
                        additionalFrequencies.forEach(freq => {
                            const extraOsc = this.audioContext.createOscillator();
                            const extraGain = this.audioContext.createGain();
                            
                            extraOsc.connect(extraGain);
                            extraGain.connect(this.audioContext.destination);
                            
                            extraOsc.type = type;
                            extraOsc.frequency.value = freq;
                            extraGain.gain.value = volume * 0.7;
                            
                            extraOsc.start(now);
                            if (fadeOut) {
                                extraGain.gain.setValueAtTime(volume * 0.7, now);
                                extraGain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                            }
                            extraOsc.stop(now + duration);
                        });
                    }
                    
                    oscillator.stop(now + duration);
                    
                    const soundId = Symbol('sound');
                    this.activeSounds.add(soundId);
                    
                    setTimeout(() => {
                        this.activeSounds.delete(soundId);
                    }, duration * 1000 + 100);
                    
                    addLogEntry(`æ’­æ”¾å£°éŸ³: ${baseFrequency}Hz, ç±»å‹: ${type}`, 'info', 'éŸ³é¢‘');
                    return true;
                } catch (error) {
                    addLogEntry(`æ’­æ”¾å£°éŸ³å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                    return false;
                }
            }
            
            stopAll() {
                try {
                    if (this.audioContext) {
                        this.audioContext.close();
                        this.audioContext = null;
                    }
                    this.activeSounds.clear();
                    this.initialized = false;
                    addLogEntry('åœæ­¢æ‰€æœ‰å£°éŸ³', 'info', 'éŸ³é¢‘');
                } catch (error) {
                    addLogEntry(`åœæ­¢å£°éŸ³å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                }
            }
        }
        
        // ä¸»åº”ç”¨å˜é‡
        let audioGenerator = null;
        let pomodoroSeconds = 1500; // 25åˆ†é’Ÿ
        let isPomodoroRunning = false;
        let isPomodoroBreak = false;
        let pomodoroInterval = null;
        let interruptSeconds = 0;
        let isInterruptRunning = false;
        let interruptInterval = null;
        let soundEnabled = false;
        let vibrationEnabled = true;
        let clickSoundEnabled = true;
        let volume = 0.5;
        let currentSoundType = 'beep';
        let pomodoroRecords = [];
        let currentSessionHistory = [];
        let todayCompleted = 0;
        let totalCompleted = 0;
        let totalFocusTime = 0;
        let isLogVisible = true;
        
        // DOMå…ƒç´ å¼•ç”¨
        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const focusTimeInput = document.getElementById('focusTime');
        const breakTimeInput = document.getElementById('breakTime');
        const customMinutesInput = document.getElementById('customMinutes');
        const setCustomTimeBtn = document.getElementById('setCustomTimeBtn');
        const interruptMinutesInput = document.getElementById('interruptMinutes');
        const interruptSecondsInput = document.getElementById('interruptSeconds');
        const interruptReasonInput = document.getElementById('interruptReason');
        const startInterruptBtn = document.getElementById('startInterruptBtn');
        const cancelInterruptBtn = document.getElementById('cancelInterruptBtn');
        const interruptTimerDisplay = document.getElementById('interruptTimerDisplay');
        const volumeControl = document.getElementById('volumeControl');
        const volumeValue = document.getElementById('volumeValue');
        const vibrationToggle = document.getElementById('vibrationToggle');
        const clickSoundToggle = document.getElementById('clickSoundToggle');
        const soundOptions = document.querySelectorAll('.sound-option');
        const testSoundBtn = document.getElementById('testSoundBtn');
        const testSoundBtn2 = document.getElementById('testSoundBtn2');
        const stopSoundBtn = document.getElementById('stopSoundBtn');
        const presetTimeButtons = document.querySelectorAll('.preset-time');
        const quickTestButtons = document.querySelectorAll('.quick-test-btn');
        const exportRecordsBtn = document.getElementById('exportRecordsBtn');
        const clearRecordsBtn = document.getElementById('clearRecordsBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const toggleLogBtn = document.getElementById('toggleLogBtn');
        const pomodoroStatus = document.getElementById('pomodoroStatus');
        const deviceStatusElement = document.getElementById('deviceStatus');
        const statusBar = document.getElementById('statusBar');
        const recordList = document.getElementById('recordList');
        const historyList = document.getElementById('historyList');
        const logContent = document.getElementById('logContent');
        const todayCompletedEl = document.getElementById('todayCompleted');
        const totalCompletedEl = document.getElementById('totalCompleted');
        const totalFocusTimeEl = document.getElementById('totalFocusTime');
        
        // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
        async function initAudioSystem() {
            try {
                if (!audioGenerator) {
                    audioGenerator = new AudioGenerator();
                }
                
                const success = await audioGenerator.ensureRunning();
                if (success) {
                    soundEnabled = true;
                    window.userInteracted = true;
                    updateDeviceStatus();
                    addLogEntry('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success', 'éŸ³é¢‘');
                    return true;
                } else {
                    addLogEntry('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’', 'warning', 'éŸ³é¢‘');
                    return false;
                }
            } catch (error) {
                addLogEntry(`éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–é”™è¯¯: ${error.message}`, 'error', 'éŸ³é¢‘');
                return false;
            }
        }
        
        // æ’­æ”¾å£°éŸ³
        async function playSound(type = 'beep') {
            if (!soundEnabled || !audioGenerator) {
                addLogEntry('å£°éŸ³æ’­æ”¾è¢«è·³è¿‡: éŸ³é¢‘æœªå¯ç”¨', 'warning', 'éŸ³é¢‘');
                return false;
            }
            
            try {
                let result = false;
                const currentVolume = volume;
                
                switch(type) {
                    case 'beep':
                        result = audioGenerator.playBeep(800, 0.5, currentVolume);
                        break;
                    case 'bell':
                        result = audioGenerator.playBell(440, 1, currentVolume);
                        break;
                    case 'chord':
                        result = audioGenerator.playChord(1, currentVolume);
                        break;
                    default:
                        result = audioGenerator.playBeep(800, 0.5, currentVolume);
                }
                
                if (result && vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate(200);
                }
                
                return result;
            } catch (error) {
                addLogEntry(`æ’­æ”¾å£°éŸ³å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                return false;
            }
        }
        
        // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
        async function playClickSound(type = 'normal') {
            if (!clickSoundEnabled || !audioGenerator || !window.userInteracted) {
                return false;
            }
            
            try {
                if (type === 'test') {
                    return audioGenerator.playBeep(600, 0.1, volume * 0.3);
                } else {
                    return audioGenerator.playClick(1000, 0.1, volume * 0.3);
                }
            } catch (error) {
                console.error('ç‚¹å‡»éŸ³æ•ˆé”™è¯¯:', error);
                return false;
            }
        }
        
        // éœ‡åŠ¨åŠŸèƒ½
        function vibrate(pattern) {
            if (vibrationEnabled && navigator.vibrate) {
                try {
                    navigator.vibrate(pattern);
                } catch (error) {
                    addLogEntry(`éœ‡åŠ¨å¤±è´¥: ${error.message}`, 'error', 'è®¾å¤‡');
                }
            }
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        function updateDeviceStatus() {
            if (!deviceStatusElement) return;
            
            const ctx = audioGenerator ? audioGenerator.getAudioContext() : null;
            let statusText = '';
            
            if (ctx) {
                switch(ctx.state) {
                    case 'running':
                        statusText = 'âœ… éŸ³é¢‘å·²æ¿€æ´»';
                        break;
                    case 'suspended':
                        statusText = 'â¸ï¸ éŸ³é¢‘å·²æš‚åœ';
                        break;
                    case 'closed':
                        statusText = 'âŒ éŸ³é¢‘å·²å…³é—­';
                        break;
                    default:
                        statusText = 'ğŸ”§ éŸ³é¢‘çŠ¶æ€æœªçŸ¥';
                }
            } else {
                statusText = soundEnabled ? 'âœ… éŸ³é¢‘å·²å‡†å¤‡' : 'ğŸ”§ ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ¿€æ´»';
            }
            
            deviceStatusElement.textContent = statusText;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, duration = 3000) {
            if (!statusBar) return;
            
            statusBar.textContent = message;
            statusBar.classList.add('show');
            
            if (duration > 0) {
                setTimeout(() => {
                    statusBar.classList.remove('show');
                }, duration);
            }
        }
        
        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(message, type = 'info', module = 'ç³»ç»Ÿ') {
            if (!logContent) return;
            
            const now = new Date();
            const timestamp = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-module">${module}</span>
                ${message}
            `;
            
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            
            console.log(`[${timestamp}] [${module}] ${message}`);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            if (logContent) {
                logContent.innerHTML = '';
                addLogEntry('æ—¥å¿—å·²æ¸…ç©º', 'info', 'ç³»ç»Ÿ');
            }
        }
        
        // åˆ‡æ¢æ—¥å¿—å¯è§æ€§
        function toggleLogVisibility() {
            if (logContent) {
                isLogVisible = !isLogVisible;
                logContent.style.display = isLogVisible ? 'block' : 'none';
                if (toggleLogBtn) {
                    toggleLogBtn.textContent = isLogVisible ? 'éšè—æ—¥å¿—' : 'æ˜¾ç¤ºæ—¥å¿—';
                }
                addLogEntry(`æ—¥å¿—å·²${isLogVisible ? 'æ˜¾ç¤º' : 'éšè—'}`, 'info', 'ç³»ç»Ÿ');
            }
        }
        
        // æµ‹è¯•å£°éŸ³
        async function testSound() {
            addLogEntry('æµ‹è¯•å£°éŸ³æ’­æ”¾', 'info', 'éŸ³é¢‘');
            
            if (!window.userInteracted) {
                showStatus('è¯·å…ˆç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®æ¿€æ´»éŸ³é¢‘', 3000);
                addLogEntry('éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾å£°éŸ³', 'warning', 'éŸ³é¢‘');
                return;
            }
            
            try {
                const audioSuccess = await playSound(currentSoundType);
                if (audioSuccess) {
                    showStatus('âœ… å£°éŸ³æµ‹è¯•æˆåŠŸ', 2000);
                } else {
                    showStatus('âŒ å£°éŸ³æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘è®¾ç½®', 3000);
                }
            } catch (error) {
                addLogEntry(`å£°éŸ³æµ‹è¯•é”™è¯¯: ${error.message}`, 'error', 'éŸ³é¢‘');
                showStatus('âŒ å£°éŸ³æµ‹è¯•å‡ºé”™', 2000);
            }
        }
        
        // åœæ­¢æ‰€æœ‰å£°éŸ³
        function stopAllSounds() {
            if (audioGenerator) {
                audioGenerator.stopAll();
                addLogEntry('å·²åœæ­¢æ‰€æœ‰å£°éŸ³', 'info', 'éŸ³é¢‘');
                showStatus('ğŸ”‡ å·²åœæ­¢æ‰€æœ‰å£°éŸ³', 2000);
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°ç•ªèŒ„é’Ÿæ˜¾ç¤º
        function updateTimerDisplay(seconds) {
            if (timerDisplay) {
                timerDisplay.textContent = formatTime(seconds);
            }
        }
        
        // æ›´æ–°ç•ªèŒ„é’ŸçŠ¶æ€
        function updatePomodoroStatus() {
            if (!pomodoroStatus) return;
            
            let status = '';
            if (isPomodoroRunning) {
                if (isPomodoroBreak) {
                    status = 'â˜• ä¼‘æ¯ä¸­';
                    timerDisplay && timerDisplay.classList.add('pulse');
                } else {
                    status = 'ğŸ¯ ä¸“æ³¨ä¸­';
                    timerDisplay && timerDisplay.classList.remove('pulse');
                }
            } else {
                if (isPomodoroBreak) {
                    status = 'â¸ï¸ ä¼‘æ¯æš‚åœ';
                } else {
                    status = 'ğŸ¯ å‡†å¤‡å¼€å§‹ä¸“æ³¨';
                }
                timerDisplay && timerDisplay.classList.remove('pulse');
            }
            
            pomodoroStatus.textContent = status;
        }
        
        // å¼€å§‹ç•ªèŒ„é’Ÿ
        async function startPomodoro() {
            if (isPomodoroRunning) return;
            
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                isPomodoroRunning = true;
                updatePomodoroStatus();
                
                if (startBtn) startBtn.disabled = true;
                if (pauseBtn) pauseBtn.disabled = false;
                
                pomodoroInterval = setInterval(() => {
                    pomodoroSeconds--;
                    updateTimerDisplay(pomodoroSeconds);
                    
                    if (pomodoroSeconds <= 0) {
                        finishPomodoro();
                    }
                }, 1000);
                
                addLogEntry(`å¼€å§‹${isPomodoroBreak ? 'ä¼‘æ¯' : 'ä¸“æ³¨'}è®¡æ—¶`, 'success', 'ç•ªèŒ„é’Ÿ');
                showStatus(`âœ… ${isPomodoroBreak ? 'ä¼‘æ¯' : 'ä¸“æ³¨'}è®¡æ—¶å¼€å§‹`, 2000);
                
            } catch (error) {
                addLogEntry(`å¼€å§‹ç•ªèŒ„é’Ÿå¤±è´¥: ${error.message}`, 'error', 'ç•ªèŒ„é’Ÿ');
                isPomodoroRunning = false;
                updatePomodoroStatus();
                if (startBtn) startBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
            }
        }
        
        // æš‚åœç•ªèŒ„é’Ÿ
        async function pausePomodoro() {
            if (!isPomodoroRunning) return;
            
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                isPomodoroRunning = false;
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                
                updatePomodoroStatus();
                if (startBtn) startBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
                
                addLogEntry(`${isPomodoroBreak ? 'ä¼‘æ¯' : 'ä¸“æ³¨'}å·²æš‚åœ`, 'info', 'ç•ªèŒ„é’Ÿ');
                showStatus('â¸ï¸ å·²æš‚åœ', 2000);
                
            } catch (error) {
                addLogEntry(`æš‚åœç•ªèŒ„é’Ÿå¤±è´¥: ${error.message}`, 'error', 'ç•ªèŒ„é’Ÿ');
            }
        }
        
        // å®Œæˆç•ªèŒ„é’Ÿ
        async function finishPomodoro() {
            try {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                isPomodoroRunning = false;
                
                const isFocusFinished = !isPomodoroBreak;
                const currentTime = new Date().toLocaleTimeString('zh-CN');
                
                if (isFocusFinished) {
                    addLogEntry('ä¸“æ³¨æ—¶é—´åˆ°ï¼', 'success', 'ç•ªèŒ„é’Ÿ');
                    showStatus('ğŸ‰ ä¸“æ³¨æ—¶é—´åˆ°ï¼Œè¯·å¼€å§‹ä¼‘æ¯ï¼', 5000);
                    
                    await playSound('bell');
                    vibrate([200, 100, 200, 100, 200]);
                    
                    todayCompleted++;
                    totalCompleted++;
                    const focusTimeMinutes = parseInt(focusTimeInput ? focusTimeInput.value : 25);
                    totalFocusTime += focusTimeMinutes / 60;
                    
                    pomodoroRecords.unshift({
                        time: currentTime,
                        duration: `${focusTimeMinutes}åˆ†é’Ÿ`,
                        type: 'focus',
                        date: new Date().toISOString().split('T')[0]
                    });
                    
                    saveRecords();
                    updateRecordsDisplay();
                    
                    isPomodoroBreak = true;
                    pomodoroSeconds = (breakTimeInput ? parseInt(breakTimeInput.value) : 5) * 60;
                } else {
                    addLogEntry('ä¼‘æ¯æ—¶é—´åˆ°ï¼', 'info', 'ç•ªèŒ„é’Ÿ');
                    showStatus('ğŸ”” ä¼‘æ¯æ—¶é—´åˆ°ï¼Œè¯·ç»§ç»­ä¸“æ³¨ï¼', 3000);
                    
                    await playSound('beep');
                    vibrate([300, 100, 300]);
                    
                    pomodoroRecords.unshift({
                        time: currentTime,
                        duration: `${breakTimeInput ? parseInt(breakTimeInput.value) : 5}åˆ†é’Ÿ`,
                        type: 'break',
                        date: new Date().toISOString().split('T')[0]
                    });
                    
                    saveRecords();
                    updateRecordsDisplay();
                    
                    isPomodoroBreak = false;
                    pomodoroSeconds = (focusTimeInput ? parseInt(focusTimeInput.value) : 25) * 60;
                }
                
                updateTimerDisplay(pomodoroSeconds);
                updatePomodoroStatus();
                
                if (startBtn) startBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
                
            } catch (error) {
                addLogEntry(`å®Œæˆç•ªèŒ„é’Ÿå¤±è´¥: ${error.message}`, 'error', 'ç•ªèŒ„é’Ÿ');
            }
        }
        
        // é‡ç½®ç•ªèŒ„é’Ÿ
        async function resetPomodoro() {
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                isPomodoroRunning = false;
                isPomodoroBreak = false;
                
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                
                const focusMinutes = focusTimeInput ? parseInt(focusTimeInput.value) : 25;
                pomodoroSeconds = focusMinutes * 60;
                
                updateTimerDisplay(pomodoroSeconds);
                updatePomodoroStatus();
                
                if (startBtn) startBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
                
                addLogEntry('ç•ªèŒ„é’Ÿå·²é‡ç½®', 'info', 'ç•ªèŒ„é’Ÿ');
                showStatus('ğŸ”„ ç•ªèŒ„é’Ÿå·²é‡ç½®', 2000);
                
            } catch (error) {
                addLogEntry(`é‡ç½®ç•ªèŒ„é’Ÿå¤±è´¥: ${error.message}`, 'error', 'ç•ªèŒ„é’Ÿ');
            }
        }
        
        // å¼€å§‹ä¸­æ–­è®¡æ—¶
        async function startInterrupt() {
            if (isInterruptRunning || isPomodoroRunning) return;
            
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                const minutes = interruptMinutesInput ? parseInt(interruptMinutesInput.value) || 0 : 0;
                const seconds = interruptSecondsInput ? parseInt(interruptSecondsInput.value) || 0 : 0;
                const reason = interruptReasonInput ? interruptReasonInput.value.trim() : '';
                
                if (minutes === 0 && seconds === 0) {
                    showStatus('âš ï¸ è¯·è®¾ç½®ä¸­æ–­æ—¶é—´', 2000);
                    addLogEntry('ä¸­æ–­æ—¶é—´æœªè®¾ç½®', 'warning', 'ä¸­æ–­');
                    return;
                }
                
                interruptSeconds = minutes * 60 + seconds;
                isInterruptRunning = true;
                
                if (interruptTimerDisplay) {
                    interruptTimerDisplay.textContent = formatTime(interruptSeconds);
                    interruptTimerDisplay.classList.add('show');
                }
                
                if (startInterruptBtn) startInterruptBtn.style.display = 'none';
                if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'inline-block';
                
                interruptInterval = setInterval(() => {
                    interruptSeconds--;
                    if (interruptTimerDisplay) {
                        interruptTimerDisplay.textContent = formatTime(interruptSeconds);
                    }
                    
                    if (interruptSeconds <= 0) {
                        finishInterrupt(reason);
                    }
                }, 1000);
                
                addLogEntry(`å¼€å§‹ä¸­æ–­è®¡æ—¶: ${minutes}åˆ†${seconds}ç§’${reason ? `, åŸå› : ${reason}` : ''}`, 'info', 'ä¸­æ–­');
                showStatus('â±ï¸ ä¸­æ–­è®¡æ—¶å¼€å§‹', 2000);
                
            } catch (error) {
                addLogEntry(`å¼€å§‹ä¸­æ–­å¤±è´¥: ${error.message}`, 'error', 'ä¸­æ–­');
                isInterruptRunning = false;
                if (interruptTimerDisplay) interruptTimerDisplay.classList.remove('show');
                if (startInterruptBtn) startInterruptBtn.style.display = 'inline-block';
                if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'none';
            }
        }
        
        // å®Œæˆä¸­æ–­è®¡æ—¶
        async function finishInterrupt(reason = '') {
            try {
                clearInterval(interruptInterval);
                interruptInterval = null;
                isInterruptRunning = false;
                
                if (interruptTimerDisplay) {
                    interruptTimerDisplay.classList.remove('show');
                }
                if (startInterruptBtn) startInterruptBtn.style.display = 'inline-block';
                if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'none';
                
                const duration = `${Math.floor((interruptSecondsInput ? parseInt(interruptSecondsInput.value) : 0) + (interruptMinutesInput ? parseInt(interruptMinutesInput.value) : 0) * 60)}ç§’`;
                
                currentSessionHistory.unshift({
                    time: new Date().toLocaleTimeString('zh-CN'),
                    duration: duration,
                    reason: reason || 'æ— åŸå› ',
                    seconds: interruptSeconds
                });
                
                if (currentSessionHistory.length > 10) {
                    currentSessionHistory = currentSessionHistory.slice(0, 10);
                }
                
                updateHistoryDisplay();
                saveHistory();
                
                await playSound('chord');
                vibrate([100, 50, 100, 50, 100, 50, 100]);
                
                addLogEntry('ä¸­æ–­æ—¶é—´åˆ°ï¼', 'success', 'ä¸­æ–­');
                showStatus('ğŸ”” ä¸­æ–­æ—¶é—´åˆ°ï¼', 5000);
                
            } catch (error) {
                addLogEntry(`å®Œæˆä¸­æ–­å¤±è´¥: ${error.message}`, 'error', 'ä¸­æ–­');
            }
        }
        
        // å–æ¶ˆä¸­æ–­
        async function cancelInterrupt() {
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                clearInterval(interruptInterval);
                interruptInterval = null;
                isInterruptRunning = false;
                
                if (interruptTimerDisplay) {
                    interruptTimerDisplay.classList.remove('show');
                }
                if (startInterruptBtn) startInterruptBtn.style.display = 'inline-block';
                if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'none';
                
                addLogEntry('ä¸­æ–­å·²å–æ¶ˆ', 'info', 'ä¸­æ–­');
                showStatus('âŒ ä¸­æ–­å·²å–æ¶ˆ', 2000);
                
            } catch (error) {
                addLogEntry(`å–æ¶ˆä¸­æ–­å¤±è´¥: ${error.message}`, 'error', 'ä¸­æ–­');
            }
        }
        // å¿«é€Ÿæµ‹è¯•ä¸­æ–­
        async function quickTestInterrupt(seconds) {
            try {
                if (clickSoundEnabled) {
                    await playClickSound('normal');
                }
                
                interruptSeconds = seconds;
                isInterruptRunning = true;
                
                if (interruptTimerDisplay) {
                    interruptTimerDisplay.textContent = formatTime(interruptSeconds);
                    interruptTimerDisplay.classList.add('show');
                }
                
                if (startInterruptBtn) startInterruptBtn.style.display = 'none';
                if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'inline-block';
                
                interruptInterval = setInterval(() => {
                    interruptSeconds--;
                    if (interruptTimerDisplay) {
                        interruptTimerDisplay.textContent = formatTime(interruptSeconds);
                    }
                    
                    if (interruptSeconds <= 0) {
                        clearInterval(interruptInterval);
                        interruptInterval = null;
                        isInterruptRunning = false;
                        
                        if (interruptTimerDisplay) {
                            interruptTimerDisplay.classList.remove('show');
                        }
                        if (startInterruptBtn) startInterruptBtn.style.display = 'inline-block';
                        if (cancelInterruptBtn) cancelInterruptBtn.style.display = 'none';
                        
                        playSound('chord');
                        vibrate([100, 50, 100, 50, 100, 50, 100]);
                        
                        addLogEntry(`å¿«é€Ÿæµ‹è¯•ä¸­æ–­å®Œæˆ: ${seconds}ç§’`, 'info', 'ä¸­æ–­');
                        showStatus(`âœ… ${seconds}ç§’æµ‹è¯•å®Œæˆ`, 2000);
                    }
                }, 1000);
                
                addLogEntry(`å¿«é€Ÿæµ‹è¯•ä¸­æ–­å¼€å§‹: ${seconds}ç§’`, 'info', 'ä¸­æ–­');
                showStatus(`â±ï¸ ${seconds}ç§’æµ‹è¯•å¼€å§‹`, 2000);
                
            } catch (error) {
                addLogEntry(`å¿«é€Ÿæµ‹è¯•ä¸­æ–­å¤±è´¥: ${error.message}`, 'error', 'ä¸­æ–­');
            }
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!historyList) return;
            
            if (currentSessionHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš‚æ— ä¸­æ–­è®°å½•</div>';
                return;
            }
            
            let html = '';
            currentSessionHistory.forEach(item => {
                html += `
                    <div class="history-item">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #2c3e50;">${item.time}</div>
                            <div style="font-size: 0.9rem; color: #666;">${item.reason}</div>
                        </div>
                        <div style="font-weight: bold; color: #e74c3c;">${item.duration}</div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        // ä¿å­˜å†å²è®°å½•
        function saveHistory() {
            try {
                const allHistory = JSON.parse(localStorage.getItem('pomodoroInterruptHistory') || '[]');
                const newEntry = {
                    timestamp: new Date().toISOString(),
                    duration: `${Math.floor((interruptSecondsInput ? parseInt(interruptSecondsInput.value) : 0) + (interruptMinutesInput ? parseInt(interruptMinutesInput.value) : 0) * 60)}ç§’`,
                    reason: interruptReasonInput ? interruptReasonInput.value.trim() || 'æ— åŸå› ' : 'æ— åŸå› ',
                    seconds: interruptSeconds
                };
                
                allHistory.unshift(newEntry);
                if (allHistory.length > 50) {
                    allHistory.length = 50;
                }
                
                localStorage.setItem('pomodoroInterruptHistory', JSON.stringify(allHistory));
                addLogEntry('ä¸­æ–­å†å²å·²ä¿å­˜', 'success', 'å­˜å‚¨');
            } catch (error) {
                addLogEntry(`ä¿å­˜ä¸­æ–­å†å²å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // åŠ è½½ç•ªèŒ„é’Ÿè®°å½•
        function loadRecords() {
            try {
                const savedRecords = localStorage.getItem('pomodoroRecords');
                if (savedRecords) {
                    pomodoroRecords = JSON.parse(savedRecords);
                    
                    const today = new Date().toISOString().split('T')[0];
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    
                    todayCompleted = pomodoroRecords.filter(record => 
                        record.date === today && record.type === 'focus'
                    ).length;
                    
                    totalCompleted = pomodoroRecords.filter(record => 
                        record.type === 'focus'
                    ).length;
                    
                    totalFocusTime = pomodoroRecords
                        .filter(record => record.type === 'focus')
                        .reduce((sum, record) => {
                            const minutes = parseInt(record.duration) || 25;
                            return sum + (minutes / 60);
                        }, 0);
                    
                    updateRecordsDisplay();
                    addLogEntry('åŠ è½½ç•ªèŒ„é’Ÿè®°å½•æˆåŠŸ', 'success', 'å­˜å‚¨');
                } else {
                    addLogEntry('æ— ç•ªèŒ„é’Ÿè®°å½•', 'info', 'å­˜å‚¨');
                }
            } catch (error) {
                addLogEntry(`åŠ è½½ç•ªèŒ„é’Ÿè®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // ä¿å­˜ç•ªèŒ„é’Ÿè®°å½•
        function saveRecords() {
            try {
                localStorage.setItem('pomodoroRecords', JSON.stringify(pomodoroRecords));
                
                if (todayCompletedEl) todayCompletedEl.textContent = todayCompleted;
                if (totalCompletedEl) totalCompletedEl.textContent = totalCompleted;
                if (totalFocusTimeEl) totalFocusTimeEl.textContent = totalFocusTime.toFixed(1);
                
                addLogEntry('ç•ªèŒ„é’Ÿè®°å½•å·²ä¿å­˜', 'success', 'å­˜å‚¨');
            } catch (error) {
                addLogEntry(`ä¿å­˜ç•ªèŒ„é’Ÿè®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // æ›´æ–°è®°å½•æ˜¾ç¤º
        function updateRecordsDisplay() {
            if (!recordList) return;
            
            if (pomodoroRecords.length === 0) {
                recordList.innerHTML = '<div class="no-records">æš‚æ— è®°å½•ï¼Œå¼€å§‹æ‚¨çš„ç¬¬ä¸€ä¸ªç•ªèŒ„é’Ÿå§ï¼</div>';
                return;
            }
            
            let html = '';
            pomodoroRecords.slice(0, 10).forEach((record, index) => {
                const isFocus = record.type === 'focus';
                html += `
                    <div class="record-item ${record.type}">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: ${isFocus ? '#3498db' : '#2ecc71'};">${record.time} - ${record.duration}</div>
                            <div style="font-size: 0.9rem; color: #666;">${record.date}</div>
                        </div>
                        <div style="font-weight: bold; color: ${isFocus ? '#3498db' : '#2ecc71'};">${isFocus ? 'ä¸“æ³¨' : 'ä¼‘æ¯'}</div>
                    </div>
                `;
            });
            
            recordList.innerHTML = html;
        }
        
        // æ¸…ç©ºè®°å½•
        function clearRecords() {
            try {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    pomodoroRecords = [];
                    currentSessionHistory = [];
                    todayCompleted = 0;
                    totalCompleted = 0;
                    totalFocusTime = 0;
                    
                    localStorage.removeItem('pomodoroRecords');
                    localStorage.removeItem('pomodoroInterruptHistory');
                    
                    updateRecordsDisplay();
                    updateHistoryDisplay();
                    saveRecords();
                    
                    addLogEntry('æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 'warning', 'å­˜å‚¨');
                    showStatus('ğŸ—‘ï¸ æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 3000);
                }
            } catch (error) {
                addLogEntry(`æ¸…ç©ºè®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            try {
                const dataStr = JSON.stringify({
                    pomodoroRecords: pomodoroRecords,
                    interruptHistory: currentSessionHistory,
                    statistics: {
                        todayCompleted,
                        totalCompleted,
                        totalFocusTime,
                        exportDate: new Date().toISOString()
                    }
                }, null, 2);
                
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `pomodoro-export-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                addLogEntry('è®°å½•å·²å¯¼å‡º', 'success', 'å­˜å‚¨');
                showStatus('ğŸ“¤ è®°å½•å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶', 3000);
            } catch (error) {
                addLogEntry(`å¯¼å‡ºè®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // åº”ç”¨è‡ªå®šä¹‰æ—¶é—´
        function applyCustomTime() {
            try {
                if (!customMinutesInput) return;
                
                const minutes = parseInt(customMinutesInput.value) || 25;
                if (minutes < 1 || minutes > 120) {
                    showStatus('âš ï¸ è¯·è¾“å…¥1-120åˆ†é’Ÿ', 2000);
                    return;
                }
                
                if (!isPomodoroRunning) {
                    pomodoroSeconds = minutes * 60;
                    updateTimerDisplay(pomodoroSeconds);
                    
                    if (focusTimeInput) {
                        focusTimeInput.value = minutes;
                    }
                    
                    addLogEntry(`è‡ªå®šä¹‰æ—¶é—´è®¾ç½®: ${minutes}åˆ†é’Ÿ`, 'success', 'è®¾ç½®');
                    showStatus(`âœ… å·²è®¾ç½®ä¸º${minutes}åˆ†é’Ÿ`, 2000);
                    
                    if (clickSoundEnabled) {
                        playClickSound('normal');
                    }
                } else {
                    showStatus('â¸ï¸ è¯·å…ˆæš‚åœè®¡æ—¶å™¨å†ä¿®æ”¹æ—¶é—´', 3000);
                }
            } catch (error) {
                addLogEntry(`è®¾ç½®è‡ªå®šä¹‰æ—¶é—´å¤±è´¥: ${error.message}`, 'error', 'è®¾ç½®');
            }
        }
        
        // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€
        function checkAudioContextStatus() {
            if (!audioGenerator) return;
            
            const ctx = audioGenerator.getAudioContext();
            if (!ctx) {
                addLogEntry('AudioContextæœªåˆ›å»º', 'warning', 'éŸ³é¢‘');
                return;
            }
            
            addLogEntry(`AudioContextçŠ¶æ€: ${ctx.state}`, ctx.state === 'running' ? 'success' : 'warning', 'éŸ³é¢‘');
            
            if (ctx.state !== 'running') {
                showStatus('ğŸ”§ éŸ³é¢‘æœªæ¿€æ´»ï¼Œè¯·ç‚¹å‡»ä»»æ„ä½ç½®æ¿€æ´»', 0);
            }
        }
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            addLogEntry('å¼€å§‹åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...', 'info', 'ç³»ç»Ÿ');
            
            // ç•ªèŒ„é’Ÿæ§åˆ¶æŒ‰é’®
            if (startBtn) {
                startBtn.addEventListener('click', startPomodoro);
                addLogEntry('å¼€å§‹æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¼€å§‹æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', pausePomodoro);
                addLogEntry('æš‚åœæŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æš‚åœæŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', resetPomodoro);
                addLogEntry('é‡ç½®æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('é‡ç½®æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // é¢„è®¾æ—¶é—´æŒ‰é’®
            if (presetTimeButtons && presetTimeButtons.length > 0) {
                presetTimeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const minutes = parseInt(this.dataset.minutes) || 25;
                        if (!isPomodoroRunning && focusTimeInput) {
                            focusTimeInput.value = minutes;
                            pomodoroSeconds = minutes * 60;
                            updateTimerDisplay(pomodoroSeconds);
                            addLogEntry(`é¢„è®¾æ—¶é—´: ${minutes}åˆ†é’Ÿ`, 'info', 'è®¾ç½®');
                        }
                    });
                });
                addLogEntry('é¢„è®¾æ—¶é—´æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('é¢„è®¾æ—¶é—´æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // ä¸­æ–­æ§åˆ¶æŒ‰é’®
            if (startInterruptBtn) {
                startInterruptBtn.addEventListener('click', startInterrupt);
                addLogEntry('å¼€å§‹ä¸­æ–­æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¼€å§‹ä¸­æ–­æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (cancelInterruptBtn) {
                cancelInterruptBtn.addEventListener('click', cancelInterrupt);
                addLogEntry('å–æ¶ˆä¸­æ–­æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å–æ¶ˆä¸­æ–­æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å£°éŸ³æ§åˆ¶
            if (volumeControl) {
                volumeControl.addEventListener('input', function() {
                    volume = parseInt(this.value) / 100;
                    if (volumeValue) {
                        volumeValue.textContent = this.value + '%';
                    }
                    addLogEntry(`éŸ³é‡è®¾ç½®: ${this.value}%`, 'info', 'éŸ³é¢‘');
                });
                addLogEntry('éŸ³é‡æ§åˆ¶ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            if (vibrationToggle) {
                vibrationToggle.addEventListener('change', function() {
                    vibrationEnabled = this.checked;
                    addLogEntry(`éœ‡åŠ¨${vibrationEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info', 'è®¾å¤‡');
                });
                addLogEntry('éœ‡åŠ¨å¼€å…³ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            if (clickSoundToggle) {
                clickSoundToggle.addEventListener('change', function() {
                    clickSoundEnabled = this.checked;
                    addLogEntry(`ç‚¹å‡»éŸ³æ•ˆ${clickSoundEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info', 'éŸ³é¢‘');
                });
                addLogEntry('ç‚¹å‡»éŸ³æ•ˆå¼€å…³ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            // å£°éŸ³ç±»å‹é€‰æ‹©
            if (soundOptions && soundOptions.length > 0) {
                soundOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        soundOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        currentSoundType = this.dataset.sound;
                        addLogEntry(`å£°éŸ³ç±»å‹åˆ‡æ¢: ${currentSoundType}`, 'info', 'éŸ³é¢‘');
                    });
                });
                addLogEntry('å£°éŸ³ç±»å‹é€‰æ‹©ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            // æµ‹è¯•å£°éŸ³æŒ‰é’®
            if (testSoundBtn) {
                testSoundBtn.addEventListener('click', testSound);
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®1ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®1å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (testSoundBtn2) {
                testSoundBtn2.addEventListener('click', async function() {
                    addLogEntry('æµ‹è¯•å£°éŸ³2æ’­æ”¾', 'info', 'éŸ³é¢‘');
                    if (clickSoundEnabled) {
                        await playClickSound('test');
                    }
                    const success = await playSound(currentSoundType);
                    if (success) {
                        showStatus('âœ… å£°éŸ³æµ‹è¯•æˆåŠŸ', 2000);
                    } else {
                        showStatus('âŒ å£°éŸ³æµ‹è¯•å¤±è´¥', 2000);
                    }
                });
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®2ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®2å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (stopSoundBtn) {
                stopSoundBtn.addEventListener('click', stopAllSounds);
                addLogEntry('åœæ­¢å£°éŸ³æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('åœæ­¢å£°éŸ³æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // è®°å½•æ§åˆ¶
            if (exportRecordsBtn) {
                exportRecordsBtn.addEventListener('click', exportRecords);
                addLogEntry('å¯¼å‡ºè®°å½•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¯¼å‡ºè®°å½•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (clearRecordsBtn) {
                clearRecordsBtn.addEventListener('click', clearRecords);
                addLogEntry('æ¸…ç©ºè®°å½•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æ¸…ç©ºè®°å½•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // æ—¶é—´è¾“å…¥å˜æ›´
            if (focusTimeInput) {
                focusTimeInput.addEventListener('change', function() {
                    const minutes = parseInt(this.value) || 25;
                    if (minutes < 1) this.value = 1;
                    if (minutes > 120) this.value = 120;
                    if (!isPomodoroRunning) {
                        pomodoroSeconds = minutes * 60;
                        updateTimerDisplay(pomodoroSeconds);
                    }
                    addLogEntry(`ä¸“æ³¨æ—¶é—´è®¾ç½®: ${minutes}åˆ†é’Ÿ`, 'info', 'è®¾ç½®');
                });
                addLogEntry('ä¸“æ³¨æ—¶é—´è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            if (breakTimeInput) {
                breakTimeInput.addEventListener('change', function() {
                    const minutes = parseInt(this.value) || 5;
                    if (minutes < 1) this.value = 1;
                    if (minutes > 60) this.value = 60;
                    addLogEntry(`ä¼‘æ¯æ—¶é—´è®¾ç½®: ${minutes}åˆ†é’Ÿ`, 'info', 'è®¾ç½®');
                });
                addLogEntry('ä¼‘æ¯æ—¶é—´è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            // è‡ªå®šä¹‰æ—¶é—´è®¾ç½®
            if (setCustomTimeBtn) {
                setCustomTimeBtn.addEventListener('click', applyCustomTime);
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å¿«é€Ÿæµ‹è¯•ä¸­æ–­æŒ‰é’®
            if (quickTestButtons && quickTestButtons.length > 0) {
                quickTestButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const seconds = parseInt(this.dataset.seconds) || 5;
                        quickTestInterrupt(seconds);
                    });
                });
                addLogEntry('å¿«é€Ÿæµ‹è¯•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¿«é€Ÿæµ‹è¯•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // æ—¥å¿—æ§åˆ¶æŒ‰é’®
            if (clearLogBtn) {
                clearLogBtn.addEventListener('click', clearLogs);
                addLogEntry('æ¸…ç©ºæ—¥å¿—æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æ¸…ç©ºæ—¥å¿—æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (toggleLogBtn) {
                toggleLogBtn.addEventListener('click', toggleLogVisibility);
                addLogEntry('åˆ‡æ¢æ—¥å¿—æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('åˆ‡æ¢æ—¥å¿—æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // è¾“å…¥éªŒè¯
            const timeInputs = [focusTimeInput, breakTimeInput, interruptMinutesInput, interruptSecondsInput];
            timeInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        let value = parseInt(this.value) || 0;
                        
                        if (this === focusTimeInput || this === breakTimeInput) {
                            if (value < 1) this.value = 1;
                            if (value > 120) this.value = 120;
                        } else if (this === interruptMinutesInput) {
                            if (value < 0) this.value = 0;
                            if (value > 120) this.value = 120;
                        } else if (this === interruptSecondsInput) {
                            if (value < 0) this.value = 0;
                            if (value > 59) this.value = 59;
                        }
                    });
                    addLogEntry(`è¾“å…¥éªŒè¯ç›‘å¬å™¨å·²ç»‘å®š: ${input.id}`, 'success', 'äº‹ä»¶');
                }
            });
            
            // è‡ªå®šä¹‰æ—¶é—´è¾“å…¥
            if (customMinutesInput) {
                customMinutesInput.addEventListener('input', function() {
                    let value = parseInt(this.value) || 1;
                    if (value < 1) this.value = 1;
                    if (value > 120) this.value = 120;
                    addLogEntry(`è‡ªå®šä¹‰æ—¶é—´è¾“å…¥: ${value}åˆ†é’Ÿ`, 'info', 'è¾“å…¥');
                });
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            // ä¸­æ–­åŸå› è¾“å…¥
            if (interruptReasonInput) {
                interruptReasonInput.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        addLogEntry(`ä¸­æ–­åŸå› è¾“å…¥: ${this.value}`, 'info', 'è¾“å…¥');
                    }
                });
                addLogEntry('ä¸­æ–­åŸå› è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            addLogEntry('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ', 'success', 'ç³»ç»Ÿ');
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('pomodoroInterruptHistory');
                if (savedHistory) {
                    const allHistory = JSON.parse(savedHistory);
                    currentSessionHistory = allHistory.slice(0, 10).map(item => ({
                        time: new Date(item.timestamp).toLocaleTimeString('zh-CN', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }),
                        duration: item.duration,
                        reason: item.reason,
                        seconds: item.seconds
                    }));
                    updateHistoryDisplay();
                    addLogEntry('åŠ è½½ä¸­æ–­å†å²æˆåŠŸ', 'success', 'å­˜å‚¨');
                } else {
                    addLogEntry('æ— ä¸­æ–­å†å²è®°å½•', 'info', 'å­˜å‚¨');
                }
            } catch (error) {
                addLogEntry(`åŠ è½½ä¸­æ–­å†å²è®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§
        function checkDeviceCompatibility() {
            const compatibilityDiv = document.createElement('div');
            compatibilityDiv.id = 'compatibilityStatus';
            compatibilityDiv.className = 'compatibility-warning hidden';
            
            let warnings = [];
            
            // æ£€æŸ¥Web Audio API
            if (!window.AudioContext && !window.webkitAudioContext) {
                warnings.push('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Audio APIï¼Œå£°éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥Vibration API
            if (!navigator.vibrate) {
                warnings.push('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒéœ‡åŠ¨APIï¼Œéœ‡åŠ¨åŠŸèƒ½å°†ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                warnings.push('LocalStorageä¸å¯ç”¨ï¼Œè®°å½•å°†æ— æ³•ä¿å­˜');
            }
            
            if (warnings.length > 0) {
                compatibilityDiv.classList.remove('hidden');
                compatibilityDiv.classList.add('warning');
                
                let warningHTML = '<strong>âš ï¸ å…¼å®¹æ€§è­¦å‘Šï¼š</strong><ul>';
                warnings.forEach(warning => {
                    warningHTML += `<li>${warning}</li>`;
                });
                warningHTML += '</ul>';
                
                compatibilityDiv.innerHTML = warningHTML;
                document.querySelector('.container').insertBefore(compatibilityDiv, document.querySelector('.container').firstChild);
                
                warnings.forEach(warning => {
                    addLogEntry(`å…¼å®¹æ€§è­¦å‘Š: ${warning}`, 'warning', 'ç³»ç»Ÿ');
                });
            } else {
                compatibilityDiv.classList.remove('hidden');
                compatibilityDiv.classList.add('success');
                compatibilityDiv.textContent = 'âœ… è®¾å¤‡å…¼å®¹æ€§æ£€æµ‹é€šè¿‡';
                document.querySelector('.container').insertBefore(compatibilityDiv, document.querySelector('.container').firstChild);
                addLogEntry('è®¾å¤‡å…¼å®¹æ€§æ£€æµ‹é€šè¿‡', 'success', 'ç³»ç»Ÿ');
            }
        }
        
        // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶å¤„ç†éŸ³é¢‘æ¿€æ´»
        document.addEventListener('click', async function(event) {
            if (window.userInteracted) return;
            
            if (event.target.tagName !== 'INPUT' && 
                event.target.tagName !== 'TEXTAREA' &&
                event.target.tagName !== 'SELECT') {
                
                addLogEntry('ç”¨æˆ·ç‚¹å‡»ï¼Œå°è¯•æ¿€æ´»éŸ³é¢‘', 'info', 'éŸ³é¢‘');
                
                try {
                    const success = await audioGenerator?.ensureRunning();
                    if (success) {
                        window.userInteracted = true;
                        soundEnabled = true;
                        updateDeviceStatus();
                        addLogEntry('éŸ³é¢‘å·²æ¿€æ´»', 'success', 'éŸ³é¢‘');
                        showStatus('âœ… éŸ³é¢‘å·²æ¿€æ´»ï¼', 2000);
                        await playSound('beep');
                    }
                } catch (error) {
                    addLogEntry(`éŸ³é¢‘æ¿€æ´»å¼‚å¸¸: ${error.message}`, 'error', 'éŸ³é¢‘');
                }
            }
            
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            if (clickSoundEnabled && window.userInteracted && audioGenerator &&
                event.target.tagName === 'BUTTON' && 
                event.target.id !== 'testSoundBtn' &&
                event.target.id !== 'testSoundBtn2' &&
                event.target.id !== 'stopSoundBtn') {
                
                if (event.target._lastClick && (Date.now() - event.target._lastClick) < 300) {
                    return;
                }
                event.target._lastClick = Date.now();
                
                try {
                    await playClickSound('normal');
                } catch (error) {
                    console.error('ç‚¹å‡»éŸ³æ•ˆå¤±è´¥:', error);
                }
            }
        });
        
        // å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', async function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.code) {
                case 'Space':
                case 'Enter':
                    event.preventDefault();
                    addLogEntry(`é”®ç›˜å¿«æ·é”®: ${event.code}`, 'info', 'é”®ç›˜');
                    if (isPomodoroRunning) {
                        await pausePomodoro();
                    } else {
                        await startPomodoro();
                    }
                    break;
                case 'KeyR':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Ctrl+R', 'info', 'é”®ç›˜');
                        await resetPomodoro();
                    }
                    break;
                case 'KeyI':
                    if (!isInterruptRunning) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: I', 'info', 'é”®ç›˜');
                        await startInterrupt();
                    }
                    break;
                case 'Escape':
                    if (isInterruptRunning) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Escape', 'info', 'é”®ç›˜');
                        await cancelInterrupt();
                    }
                    break;
                case 'KeyL':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Ctrl+L', 'info', 'é”®ç›˜');
                        toggleLogVisibility();
                    }
                    break;
            }
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                addLogEntry('åˆå§‹åŒ–ç•ªèŒ„é’Ÿåº”ç”¨ v6.2.0', 'info', 'ç³»ç»Ÿ');
                addLogEntry(`ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`, 'info', 'ç³»ç»Ÿ');
                addLogEntry(`å¹³å°: ${navigator.platform}`, 'info', 'ç³»ç»Ÿ');
                
                // åˆå§‹åŒ–éŸ³é¢‘
                await initAudioSystem();
                
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                initEventListeners();
                
                // åŠ è½½å†å²è®°å½•
                loadHistory();
                
                // åŠ è½½ç•ªèŒ„é’Ÿè®°å½•
                loadRecords();
                
                // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€
                checkAudioContextStatus();
                
                // æ›´æ–°åˆå§‹çŠ¶æ€
                const focusMinutes = focusTimeInput ? parseInt(focusTimeInput.value) || 25 : 25;
                pomodoroSeconds = focusMinutes * 60;
                updateTimerDisplay(pomodoroSeconds);
                updatePomodoroStatus();
                
                // æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§
                checkDeviceCompatibility();
                
                // åˆå§‹åŒ–å®Œæˆ
                addLogEntry('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success', 'ç³»ç»Ÿ');
                showStatus('ç•ªèŒ„é’Ÿv6.2.0å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ï¼', 3000);
                
            } catch (error) {
                addLogEntry(`åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error', 'ç³»ç»Ÿ');
                showStatus('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 5000);
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('DOMå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...', 'info', 'ç³»ç»Ÿ');
            
            // æ£€æŸ¥å…³é”®å…ƒç´ 
            const requiredElements = {
                'startBtn': startBtn,
                'pauseBtn': pauseBtn,
                'resetBtn': resetBtn,
                'timerDisplay': timerDisplay,
                'statusBar': statusBar,
                'focusTimeInput': focusTimeInput,
                'breakTimeInput': breakTimeInput
            };
            
            Object.entries(requiredElements).forEach(([name, element]) => {
                if (element) {
                    addLogEntry(`âœ… ${name} å…ƒç´ å­˜åœ¨`, 'success', 'ç³»ç»Ÿ');
                } else {
                    addLogEntry(`âŒ ${name} å…ƒç´ ä¸å­˜åœ¨`, 'error', 'ç³»ç»Ÿ');
                }
            });
            
            // åˆå§‹åŒ–åº”ç”¨
            initApp();
            
            // è®¾ç½®ç”¨æˆ·æ¿€æ´»æ£€æŸ¥
            setTimeout(() => {
                if (!window.userInteracted) {
                    addLogEntry('ç­‰å¾…ç”¨æˆ·äº¤äº’æ¿€æ´»éŸ³é¢‘', 'warning', 'éŸ³é¢‘');
                    showStatus('è¯·ç‚¹å‡»ä»»æ„ä½ç½®æ¿€æ´»å£°éŸ³åŠŸèƒ½', 0);
                }
            }, 2000);
            
            // æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
            setTimeout(() => {
                addLogEntry('æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:', 'info', 'ç³»ç»Ÿ');
                
                const ctx = audioGenerator ? audioGenerator.getAudioContext() : null;
                if (ctx && ctx.state) {
                    addLogEntry(`AudioContextçŠ¶æ€: ${ctx.state}`, ctx.state === 'running' ? 'success' : 'warning', 'éŸ³é¢‘');
                } else {
                    addLogEntry('AudioContext: æœªåˆ›å»ºæˆ–ä¸å¯ç”¨', 'warning', 'éŸ³é¢‘');
                }
                
                addLogEntry(`éŸ³é¢‘çŠ¶æ€: ${soundEnabled ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`, soundEnabled ? 'success' : 'warning', 'éŸ³é¢‘');
                addLogEntry(`ç•ªèŒ„é’ŸçŠ¶æ€: ${isPomodoroRunning ? 'è¿è¡Œä¸­' : 'åœæ­¢'}`, 'info', 'ç•ªèŒ„é’Ÿ');
                addLogEntry(`ç”¨æˆ·äº¤äº’: ${window.userInteracted ? 'æ˜¯' : 'å¦'}`, window.userInteracted ? 'success' : 'warning', 'ç³»ç»Ÿ');
                addLogEntry(`ç‚¹å‡»éŸ³æ•ˆ: ${clickSoundEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info', 'éŸ³é¢‘');
                addLogEntry(`è®°å½•æ¡æ•°: ${pomodoroRecords.length}`, 'info', 'è®°å½•');
                addLogEntry(`ä»Šæ—¥å®Œæˆ: ${todayCompleted}`, 'info', 'ç»Ÿè®¡');
                addLogEntry(`æ€»å®Œæˆ: ${totalCompleted}`, 'info', 'ç»Ÿè®¡');
            }, 3000);
            
            // å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', (event) => {
                addLogEntry(`å…¨å±€JavaScripté”™è¯¯: ${event.message}`, 'error', 'ç³»ç»Ÿ');
                console.error("ğŸš¨ å…¨å±€JavaScripté”™è¯¯:", event.error);
            });
            
            // æœªå¤„ç†çš„Promiseæ‹’ç»
            window.addEventListener('unhandledrejection', (event) => {
                addLogEntry(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error', 'ç³»ç»Ÿ');
                console.error("ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:", event.reason);
            });
            
            addLogEntry('ğŸ¯ ç•ªèŒ„é’Ÿv6.2.0 å®Œå…¨åŠ è½½å®Œæˆï¼', 'success', 'ç³»ç»Ÿ');
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                addLogEntry('é¡µé¢éšè—', 'info', 'ç³»ç»Ÿ');
            } else {
                addLogEntry('é¡µé¢å¯è§', 'info', 'ç³»ç»Ÿ');
            }
        });
        
        // é¡µé¢å¸è½½å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', () => {
            saveRecords();
            addLogEntry('é¡µé¢å¸è½½ï¼Œä¿å­˜æ•°æ®', 'info', 'ç³»ç»Ÿ');
        });
        
        // è§¦æ‘¸åé¦ˆ
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || 
                e.target.classList.contains('preset-time')) {
                e.target.classList.add('touch-feedback');
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || 
                e.target.classList.contains('preset-time')) {
                setTimeout(() => {
                    e.target.classList.remove('touch-feedback');
                }, 150);
            }
        }, { passive: true });
        
        // åˆå§‹åŒ–å…¨å±€å˜é‡
        window.userInteracted = false;
        window.audioGenerator = audioGenerator;
    </script>
</body>
</html>
