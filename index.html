<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•ªèŒ„é’Ÿ v6.2.0 - æ—¶é—´ç®¡ç†ä¸ä¸“æ³¨å·¥å…·</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1e293b;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (min-width: 768px) {
            .container {
                grid-template-columns: 2fr 1fr;
            }
            
            .timer-card {
                grid-column: 1;
            }
            
            .settings-card, .interrupt-card, .records-card {
                grid-column: 2;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 2fr 1fr 1fr;
            }
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .main-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* è®¡æ—¶å™¨å¡ç‰‡ */
        .timer-card {
            text-align: center;
        }
        
        .timer-display {
            font-size: 5rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            color: #0f172a;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 30px 0;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .button {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .button:active {
            transform: scale(0.95);
        }
        
        .button.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .button.secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .button.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }
        
        .input-row {
            margin: 16px 0;
        }
        
        .input-row label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 500;
        }
        
        .input-with-unit {
            position: relative;
        }
        
        .input-with-unit input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .input-with-unit input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .unit {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        /* é¢„è®¾æ—¶é—´ */
        .preset-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .preset-time {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-time:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .preset-time.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* å£°éŸ³æµ‹è¯• */
        .sound-test {
            background: #fef3c7;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .sound-test p {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        /* å…¼å®¹æ€§è­¦å‘Š */
        .compatibility-warning {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .compatibility-warning.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .compatibility-warning.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .compatibility-warning.hidden {
            display: none;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* è®¾å¤‡çŠ¶æ€ */
        .device-status {
            padding: 12px;
            background: #f1f5f9;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #475569;
            margin-top: 20px;
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            text-align: center;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .status-bar.show {
            transform: translateY(0);
        }
        
        /* ä¸­æ–­è®¡æ—¶å™¨ */
        .interrupt-timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .interrupt-timer.show {
            transform: translateX(0);
        }
        
        /* ä¸­æ–­æ§åˆ¶ */
        .interrupt-controls {
            margin: 20px 0;
        }
        
        .seconds-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .seconds-input {
            position: relative;
        }
        
        .seconds-input input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
        }
        
        .seconds-label {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }
        
        .interrupt-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
        }
        
        /* å¿«é€Ÿæµ‹è¯•æŒ‰é’® */
        .quick-test-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        /* ä¸­æ–­å†å² */
        .interrupt-history {
            margin-top: 20px;
        }
        
        .history-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .history-time {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .history-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .empty-history {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        /* å£°éŸ³æ§åˆ¶ */
        .sound-controls {
            margin: 20px 0;
        }
        
        .sound-options {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }
        
        .sound-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #f1f5f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sound-option.active {
            background: #3b82f6;
            color: white;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
        }
        
        .volume-control input[type="range"] {
            flex: 1;
        }
        
        /* è‡ªå®šä¹‰æ—¶é—´ */
        .custom-time {
            margin: 20px 0;
        }
        
        .custom-time label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
        }
        
        .custom-time-input {
            display: flex;
            gap: 8px;
        }
        
        .custom-time-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        
        /* ç•ªèŒ„é’ŸçŠ¶æ€ */
        .pomodoro-status {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #3b82f6;
            margin: 10px 0;
        }
        
        /* ç•ªèŒ„é’Ÿè®°å½•æ ·å¼ */
        .records-card {
            margin-top: 20px;
        }
        
        .record-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        .record-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .record-info {
            flex: 1;
        }
        
        .record-time {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .record-duration {
            font-size: 0.9rem;
            color: #0f172a;
            font-weight: 500;
        }
        
        .record-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .record-type.focus {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .record-type.break {
            background: #f0f9ff;
            color: #0c4a6e;
        }
        
        .no-records {
            text-align: center;
            color: #94a3b8;
            padding: 40px 20px;
            font-style: italic;
        }
        
        .record-controls {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }
        
        /* æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ */
        .log-container {
            margin-top: 20px;
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .log-header h3 {
            color: #f1f5f9;
            font-size: 1rem;
        }
        
        .log-controls {
            display: flex;
            gap: 8px;
        }
        
        .log-content {
            color: #cbd5e1;
            line-height: 1.4;
        }
        
        .log-item {
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-timestamp {
            color: #94a3b8;
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        .log-level-info { color: #60a5fa; }
        .log-level-success { color: #34d399; }
        .log-level-warning { color: #fbbf24; }
        .log-level-error { color: #f87171; }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 767px) {
            .timer-display {
                font-size: 3.5rem;
            }
            
            .button {
                padding: 14px 20px;
                font-size: 0.9rem;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
            
            .preset-times {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-test-buttons {
                grid-template-columns: 1fr;
            }
            
            .record-stats {
                grid-template-columns: 1fr;
            }
            
            .record-controls {
                flex-direction: column;
            }
            
            .interrupt-timer {
                font-size: 1.2rem;
                padding: 12px 16px;
            }
        }
        
        /* åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease;
        }
        
        /* è§¦æ‘¸åé¦ˆ */
        .touch-feedback:active {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div id="deviceStatus" class="device-status">ğŸ”§ åˆå§‹åŒ–ä¸­...</div>
    
    <div class="container">
        <!-- ä¸»è®¡æ—¶å™¨å¡ç‰‡ -->
        <div class="main-card timer-card">
            <div class="card-title">ğŸ… ç•ªèŒ„é’Ÿè®¡æ—¶å™¨</div>
            
            <div class="pomodoro-status" id="pomodoroStatus">ğŸ¯ å‡†å¤‡å¼€å§‹ä¸“æ³¨</div>
            
            <div class="timer-display" id="timer">25:00</div>
            
            <div class="timer-controls">
                <button id="startBtn" class="button primary">â–¶ï¸ å¼€å§‹</button>
                <button id="pauseBtn" class="button secondary" disabled>â¸ï¸ æš‚åœ</button>
                <button id="resetBtn" class="button danger">ğŸ”„ é‡ç½®</button>
            </div>
            
            <div class="input-group">
                <div class="input-row">
                    <label for="focusTime">ä¸“æ³¨æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <div class="input-with-unit">
                        <input type="number" id="focusTime" min="1" max="120" value="25">
                        <span class="unit">åˆ†é’Ÿ</span>
                    </div>
                </div>
                
                <div class="input-row">
                    <label for="breakTime">ä¼‘æ¯æ—¶é—´ (åˆ†é’Ÿ)</label>
                    <div class="input-with-unit">
                        <input type="number" id="breakTime" min="1" max="60" value="5">
                        <span class="unit">åˆ†é’Ÿ</span>
                    </div>
                </div>
            </div>
            
            <!-- å£°éŸ³æ§åˆ¶æŒ‰é’® -->
            <div class="sound-control-buttons">
                <button id="testSoundBtn" class="button secondary">ğŸ”Š æµ‹è¯•å£°éŸ³</button>
                <button id="stopSoundBtn" class="button danger">ğŸ”‡ åœæ­¢å£°éŸ³</button>
            </div>
        </div>
        
        <!-- è®¾ç½®ä¸è®°å½•å¡ç‰‡ -->
        <div class="main-card settings-card">
            <div class="card-title">âš™ï¸ è®¾ç½®ä¸è®°å½•</div>
            
            <!-- é¢„è®¾æ—¶é—´ -->
            <div class="preset-section">
                <div class="input-row">
                    <label>é¢„è®¾ä¸“æ³¨æ—¶é—´</label>
                </div>
                <div class="preset-times">
                    <div class="preset-time active" data-minutes="15">15åˆ†é’Ÿ</div>
                    <div class="preset-time" data-minutes="25">25åˆ†é’Ÿ</div>
                    <div class="preset-time" data-minutes="30">30åˆ†é’Ÿ</div>
                    <div class="preset-time" data-minutes="45">45åˆ†é’Ÿ</div>
                    <div class="preset-time" data-minutes="50">50åˆ†é’Ÿ</div>
                    <div class="preset-time" data-minutes="60">60åˆ†é’Ÿ</div>
                </div>
            </div>
            
            <!-- ç•ªèŒ„é’Ÿè®°å½• -->
            <div class="record-stats">
                <div class="stat-item">
                    <div class="stat-value" id="todayPomodoros">0</div>
                    <div class="stat-label">ä»Šæ—¥å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalPomodoros">0</div>
                    <div class="stat-label">æ€»ç•ªèŒ„é’Ÿ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalMinutes">0</div>
                    <div class="stat-label">æ€»åˆ†é’Ÿæ•°</div>
                </div>
            </div>
            
            <div class="record-controls">
                <button id="exportRecordsBtn" class="button secondary">ğŸ“¤ å¯¼å‡ºè®°å½•</button>
                <button id="clearRecordsBtn" class="button danger">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
            </div>
            
            <div class="record-list" id="recordList">
                <div class="no-records">æš‚æ— è®°å½•ï¼Œå¼€å§‹ä½¿ç”¨ç•ªèŒ„é’Ÿå§ï¼</div>
            </div>
        </div>
        
        <!-- ä¸­æ–­åŠŸèƒ½å¡ç‰‡ -->
        <div class="main-card interrupt-card">
            <div class="card-title">â¸ï¸ ä¸´æ—¶ä¸­æ–­</div>
            
            <div class="interrupt-controls">
                <div class="seconds-input-group">
                    <div class="seconds-input">
                        <input type="number" id="interruptMinutes" placeholder="åˆ†é’Ÿ" min="0" max="120" value="0">
                        <div class="seconds-label">åˆ†</div>
                    </div>
                    <div class="seconds-input">
                        <input type="number" id="interruptSeconds" placeholder="ç§’æ•°" min="0" max="59" value="5">
                        <div class="seconds-label">ç§’</div>
                    </div>
                </div>
                
                <div class="input-row">
                    <input type="text" id="interruptReason" placeholder="ä¸­æ–­åŸå› ï¼ˆå¯é€‰ï¼‰" class="tooltip" title="è®°å½•ä¸­æ–­åŸå› ä¾¿äºè¿½è¸ªåˆ†æ">
                </div>
                
                <button id="startInterruptBtn" class="interrupt-button">â±ï¸ å¼€å§‹ç§’çº§ä¸­æ–­</button>
                <button id="cancelInterruptBtn" class="button danger" style="display: none;">å–æ¶ˆä¸­æ–­</button>
                
                <!-- å¿«é€Ÿæµ‹è¯•æŒ‰é’® -->
                <div class="quick-test-buttons">
                    <button class="button primary quick-test-btn" data-seconds="5">5ç§’æµ‹è¯•</button>
                    <button class="button primary quick-test-btn" data-seconds="10">10ç§’æµ‹è¯•</button>
                    <button class="button primary quick-test-btn" data-seconds="30">30ç§’æµ‹è¯•</button>
                </div>
            </div>
            
            <div class="interrupt-history">
                <div class="history-title">
                    <span>æœ€è¿‘ä¸­æ–­</span>
                    <button id="clearHistoryBtn" class="clear-history">æ¸…ç©º</button>
                </div>
                <div class="history-list" id="historyList">
                    <div class="history-item empty-history">
                        æš‚æ— ä¸­æ–­è®°å½•
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸­æ–­è®¡æ—¶å™¨æ‚¬æµ®çª— -->
    <div class="interrupt-timer" id="interruptTimer">
        <div>ä¸­æ–­å‰©ä½™æ—¶é—´</div>
        <div id="interruptTime">00:00</div>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar" id="statusBar">
        <span id="statusText">å‡†å¤‡å¼€å§‹</span>
    </div>
    
    <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="log-container">
        <div class="log-header">
            <h3>ğŸ“Š ç³»ç»Ÿæ—¥å¿—</h3>
            <div class="log-controls">
                <button id="clearLogBtn" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem;">æ¸…ç©ºæ—¥å¿—</button>
                <button id="toggleLogBtn" class="button secondary" style="padding: 4px 8px; font-size: 0.8rem;">éšè—</button>
            </div>
        </div>
        <div class="log-content" id="logContent">
            <!-- æ—¥å¿—ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
    </div>
    
    <script>
        // ============================================
        // ç•ªèŒ„é’Ÿ v6.2.0 - æ—¥å¿—ä¸æ»šåŠ¨ä¼˜åŒ–ç‰ˆ
        // ä¸»è¦æ›´æ–°ï¼šæ·»åŠ æ—¥å¿—ç³»ç»Ÿï¼Œä¿®å¤æ»šåŠ¨é—®é¢˜
        // ============================================
        
        // å…¨å±€çŠ¶æ€å˜é‡
        let pomodoroTimer = null;
        let pomodoroSeconds = 25 * 60;
        let interruptDuration = 0;
        let remainingSeconds = 0;
        let isPomodoroRunning = false;
        let isFocusTime = true;
        let isInterruptRunning = false;
        let currentSessionHistory = [];
        
        // è®°å½•ç›¸å…³å˜é‡
        let pomodoroRecords = [];
        let todayCompleted = 0;
        let totalCompleted = 0;
        let totalMinutesCompleted = 0;
        
        // é«˜ç²¾åº¦è®¡æ—¶å˜é‡
        let interruptStartTime = 0;
        let interruptAnimationFrame = null;
        
        // å£°éŸ³æ§åˆ¶å˜é‡
        let currentSoundType = 'beep';
        let volume = 0.7;
        let soundInterval = null;
        let soundEnabled = false;
        let isTestingSound = false;
        let vibrationEnabled = true;
        let clickSoundEnabled = true;
        
        // æ—¥å¿—ç³»ç»Ÿ
        let systemLogs = [];
        const MAX_LOG_ENTRIES = 50;
        let isLogVisible = true;
        
        // iOSå…¼å®¹æ€§
        window.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        window.userInteracted = false;
        
        // æ”¹è¿›çš„éŸ³é¢‘ç”Ÿæˆå™¨
        class AudioGenerator {
            constructor() {
                this.audioContext = null;
                this.sounds = {
                    beep: { frequency: 600, duration: 0.3, type: 'sine' },
                    bell: { frequency: 1200, duration: 0.8, type: 'sine' },
                    chord: { frequency: 800, duration: 1.0, type: 'triangle' },
                    click: { frequency: 300, duration: 0.1, type: 'sine' },
                    softClick: { frequency: 400, duration: 0.08, type: 'sine' },
                    buttonClick: { frequency: 500, duration: 0.15, type: 'sine' }
                };
                this.isInitialized = false;
                this.audioNodes = [];
            }
            
            getAudioContext() {
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    return this.audioContext;
                }
                
                if (this.audioContext && this.audioContext.state === 'closed') {
                    this.audioContext = null;
                    this.isInitialized = false;
                }
                
                if (window.AudioContext || window.webkitAudioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContextClass();
                    this.isInitialized = true;
                    
                    this.audioContext.onstatechange = () => {
                        this.log(`AudioContextçŠ¶æ€: ${this.audioContext.state}`);
                    };
                }
                
                return this.audioContext;
            }
            
            async ensureRunning() {
                const ctx = this.getAudioContext();
                if (!ctx) {
                    this.log('æ— æ³•åˆ›å»ºAudioContext', 'error');
                    return false;
                }
                
                if (ctx.state === 'suspended') {
                    try {
                        await ctx.resume();
                        this.log('AudioContextå·²æ¢å¤', 'success');
                        return true;
                    } catch (error) {
                        this.log(`æ¢å¤AudioContextå¤±è´¥: ${error.message}`, 'error');
                        return false;
                    }
                }
                
                return ctx.state === 'running';
            }
            
            createAudioNode(type) {
                const ctx = this.getAudioContext();
                if (!ctx) {
                    this.log('æ— æ³•åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹ï¼šAudioContextä¸å¯ç”¨', 'warning');
                    return null;
                }
                
                try {
                    let node;
                    switch(type) {
                        case 'oscillator':
                            node = ctx.createOscillator();
                            break;
                        case 'gain':
                            node = ctx.createGain();
                            break;
                        default:
                            return null;
                    }
                    
                    this.audioNodes.push(node);
                    return node;
                } catch (error) {
                    this.log(`åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹å¤±è´¥: ${error.message}`, 'error');
                    return null;
                }
            }
            
            cleanupAudioNodes() {
                this.audioNodes.forEach(node => {
                    try {
                        if (node.stop) node.stop();
                        if (node.disconnect) node.disconnect();
                    } catch (e) {}
                });
                this.audioNodes = [];
            }
            
            async play(soundType, customVolume = null) {
                await new Promise(resolve => setTimeout(resolve, 10));
                
                if (!await this.ensureRunning()) {
                    this.log('éŸ³é¢‘ç³»ç»Ÿä¸å¯ç”¨ï¼Œè·³è¿‡æ’­æ”¾', 'warning');
                    return false;
                }
                
                const sound = this.sounds[soundType] || this.sounds.beep;
                const playVolume = customVolume !== null ? customVolume : volume;
                
                try {
                    const oscillator = this.createAudioNode('oscillator');
                    const gainNode = this.createAudioNode('gain');
                    
                    if (!oscillator || !gainNode) {
                        this.log('åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹å¤±è´¥', 'warning');
                        return false;
                    }
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = sound.frequency;
                    oscillator.type = sound.type;
                    
                    const now = this.audioContext.currentTime;
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(playVolume, now + 0.1);
                    gainNode.gain.linearRampToValueAtTime(playVolume, now + sound.duration - 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + sound.duration);
                    
                    oscillator.start(now);
                    
                    setTimeout(() => {
                        try {
                            oscillator.stop();
                        } catch (e) {}
                    }, (stopTime - now) * 1000);
                    
                    this.log(`æ’­æ”¾éŸ³æ•ˆ: ${soundType}`, 'info');
                    return true;
                } catch (error) {
                    this.log(`æ’­æ”¾éŸ³æ•ˆå¤±è´¥: ${error.message}`, 'error');
                    this.cleanupAudioNodes();
                    this.isInitialized = false;
                    this.audioContext = null;
                    return false;
                }
            }
            
            async playClickSound(buttonType = 'normal') {
                if (!clickSoundEnabled) return false;
                
                let clickType = 'click';
                let clickVolume = volume * 0.5;
                
                switch(buttonType) {
                    case 'start':
                        clickType = 'buttonClick';
                        clickVolume = volume * 0.6;
                        break;
                    case 'stop':
                        clickType = 'softClick';
                        clickVolume = volume * 0.3;
                        break;
                    case 'test':
                        clickType = 'chord';
                        clickVolume = volume * 0.4;
                        break;
                }
                
                return await this.play(clickType, clickVolume);
            }
            
            stopAll() {
                this.cleanupAudioNodes();
                
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    try {
                        this.audioContext.suspend();
                    } catch (e) {}
                }
            }
            
            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                console.log(`${timestamp} [${level.toUpperCase()}] ${message}`);
                
                if (level === 'error') {
                    console.error(message);
                } else if (level === 'warning') {
                    console.warn(message);
                }
            }
        }
        
        // åˆ›å»ºéŸ³é¢‘ç”Ÿæˆå™¨å®ä¾‹
        const audioGenerator = new AudioGenerator();
        
        // è·å–DOMå…ƒç´ 
        const timerDisplay = document.getElementById('timer');
        const interruptTimerDisplay = document.getElementById('interruptTimer');
        const interruptTimeDisplay = document.getElementById('interruptTime');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const testSoundBtn = document.getElementById('testSoundBtn');
        const interruptMinutesInput = document.getElementById('interruptMinutes');
        const interruptSecondsInput = document.getElementById('interruptSeconds');
        const interruptReasonInput = document.getElementById('interruptReason');
        const startInterruptBtn = document.getElementById('startInterruptBtn');
        const cancelInterruptBtn = document.getElementById('cancelInterruptBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historyList = document.getElementById('historyList');
        const statusBar = document.getElementById('statusBar');
        const statusText = document.getElementById('statusText');
        const deviceStatusElement = document.getElementById('deviceStatus');
        const logContent = document.getElementById('logContent');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const toggleLogBtn = document.getElementById('toggleLogBtn');
        
        // æ–°å¢æ—¥å¿—åŠŸèƒ½
        function addLogEntry(message, level = 'info', source = 'ç³»ç»Ÿ') {
            const timestamp = new Date();
            const timeStr = timestamp.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            const logEntry = {
                timestamp: timestamp.getTime(),
                timeStr: timeStr,
                message: message,
                level: level,
                source: source
            };
            
            systemLogs.unshift(logEntry);
            
            if (systemLogs.length > MAX_LOG_ENTRIES) {
                systemLogs.pop();
            }
            
            updateLogDisplay();
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            const consoleMessage = `${timeStr} [${level.toUpperCase()}] ${message}`;
            switch(level) {
                case 'error':
                    console.error(consoleMessage);
                    break;
                case 'warning':
                    console.warn(consoleMessage);
                    break;
                case 'success':
                    console.info(consoleMessage);
                    break;
                default:
                    console.log(consoleMessage);
            }
            
            return logEntry;
        }
        
        function updateLogDisplay() {
            if (!logContent) return;
            
            logContent.innerHTML = '';
            
            systemLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'log-timestamp';
                timestampSpan.textContent = log.timeStr;
                
                const levelSpan = document.createElement('span');
                levelSpan.className = `log-level-${log.level}`;
                levelSpan.textContent = `[${log.level.toUpperCase()}] `;
                
                const messageSpan = document.createElement('span');
                messageSpan.textContent = log.message;
                messageSpan.style.color = '#cbd5e1';
                
                logItem.appendChild(timestampSpan);
                logItem.appendChild(levelSpan);
                logItem.appendChild(messageSpan);
                
                logContent.appendChild(logItem);
            });
        }
        
        function clearLogs() {
            systemLogs = [];
            updateLogDisplay();
            addLogEntry('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        function toggleLogVisibility() {
            isLogVisible = !isLogVisible;
            const logContainer = document.querySelector('.log-container');
            if (logContainer) {
                if (isLogVisible) {
                    logContainer.style.display = 'block';
                    toggleLogBtn.textContent = 'éšè—';
                } else {
                    logContainer.style.display = 'none';
                    toggleLogBtn.textContent = 'æ˜¾ç¤º';
                }
            }
        }
        
        // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
        async function initAudioSystem() {
            addLogEntry('åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ...', 'info', 'éŸ³é¢‘');
            
            try {
                if (!window.userInteracted) {
                    deviceStatusElement.textContent = 'â³ ç­‰å¾…ç”¨æˆ·äº¤äº’æ¿€æ´»éŸ³é¢‘...';
                    addLogEntry('ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ¿€æ´»éŸ³é¢‘', 'warning', 'éŸ³é¢‘');
                    return;
                }
                
                const success = await audioGenerator.ensureRunning();
                if (success) {
                    soundEnabled = true;
                    updateDeviceStatus();
                    addLogEntry('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ', 'success', 'éŸ³é¢‘');
                } else {
                    addLogEntry('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥', 'error', 'éŸ³é¢‘');
                }
            } catch (error) {
                addLogEntry(`éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å‡ºé”™: ${error.message}`, 'error', 'éŸ³é¢‘');
                deviceStatusElement.textContent = 'âŒ éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç‚¹å‡»é¡µé¢é‡è¯•';
            }
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        function updateDeviceStatus() {
            const audioStatus = soundEnabled ? 'âœ…' : 'âŒ';
            const audioText = soundEnabled ? 'éŸ³é¢‘å·²æ¿€æ´»' : 'éŸ³é¢‘æœªæ¿€æ´»';
            
            let statusText = `${audioStatus} ${audioText}`;
            
            if (window.isIOS) {
                statusText += ' | ğŸ“± iOS';
            }
            
            if (vibrationEnabled) {
                statusText += ' | ğŸ“³ éœ‡åŠ¨';
            }
            
            deviceStatusElement.textContent = statusText;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, duration = 3000) {
            if (!statusBar || !statusText) return;
            
            addLogEntry(`çŠ¶æ€æ¶ˆæ¯: ${message}`, 'info', 'ç•Œé¢');
            statusText.textContent = message;
            
            clearTimeout(statusBar.hideTimeout);
            statusBar.classList.add('show');
            
            if (duration > 0) {
                statusBar.hideTimeout = setTimeout(() => {
                    statusBar.classList.remove('show');
                }, duration);
            }
        }
        
        // éœ‡åŠ¨åŠŸèƒ½
        function vibrate(pattern) {
            if (!vibrationEnabled || !navigator.vibrate) return;
            
            try {
                navigator.vibrate(pattern);
                addLogEntry(`éœ‡åŠ¨æ¨¡å¼: ${pattern}`, 'info', 'è®¾å¤‡');
            } catch (error) {
                addLogEntry(`éœ‡åŠ¨å¤±è´¥: ${error.message}`, 'warning', 'è®¾å¤‡');
            }
        }
        
        // æ’­æ”¾å£°éŸ³
        async function playSound(type) {
            if (!soundEnabled || isTestingSound) return false;
            
            try {
                const result = await audioGenerator.play(type);
                if (result) {
                    addLogEntry(`æ’­æ”¾å£°éŸ³: ${type}`, 'info', 'éŸ³é¢‘');
                }
                return result;
            } catch (error) {
                addLogEntry(`æ’­æ”¾å£°éŸ³å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
                return false;
            }
        }
        
        // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
        async function playClickSound(type = 'normal') {
            if (!clickSoundEnabled || !soundEnabled) return false;
            
            try {
                const result = await audioGenerator.playClickSound(type);
                if (result) {
                    addLogEntry(`æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ: ${type}`, 'info', 'éŸ³é¢‘');
                }
                return result;
            } catch (error) {
                addLogEntry(`æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆå¤±è´¥: ${error.message}`, 'warning', 'éŸ³é¢‘');
                return false;
            }
        }
        
        // æ›´æ–°ç•ªèŒ„é’Ÿæ˜¾ç¤º
        function updateTimerDisplay(seconds) {
            if (!timerDisplay) return;
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            
            if (seconds <= 60 && isFocusTime && seconds > 0) {
                timerDisplay.style.color = '#ef4444';
            } else if (seconds <= 300 && isFocusTime && seconds > 60) {
                timerDisplay.style.color = '#f59e0b';
            } else {
                timerDisplay.style.color = '';
            }
        }
        
        // æ›´æ–°ä¸­æ–­è®¡æ—¶å™¨æ˜¾ç¤º
        function updateInterruptTimerDisplay(seconds) {
            if (!interruptTimeDisplay) return;
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            interruptTimeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            
            if (seconds <= 10 && seconds > 3) {
                interruptTimeDisplay.style.color = '#f59e0b';
            } else if (seconds <= 3) {
                interruptTimeDisplay.style.color = '#ef4444';
            } else {
                interruptTimeDisplay.style.color = '#f59e0b';
            }
        }
        
        // æ·»åŠ ç•ªèŒ„é’Ÿè®°å½•
        async function addPomodoroRecord(type, durationMinutes, completed = true) {
            const now = new Date();
            const record = {
                id: Date.now(),
                type: type,
                duration: durationMinutes,
                completed: completed,
                startTime: completed ? new Date(now.getTime() - durationMinutes * 60000) : new Date(),
                endTime: now,
                timestamp: now.getTime()
            };
            
            pomodoroRecords.unshift(record);
            addLogEntry(`æ·»åŠ ${type === 'focus' ? 'ä¸“æ³¨' : 'ä¼‘æ¯'}è®°å½•: ${durationMinutes}åˆ†é’Ÿ`, 'info', 'è®°å½•');
            
            if (completed) {
                updatePomodoroStats(record);
                saveRecords();
            }
            
            updateRecordDisplay();
            updateStatisticsDisplay();
        }
        
        // æ›´æ–°ç•ªèŒ„é’Ÿç»Ÿè®¡
        function updatePomodoroStats(record) {
            if (!record.completed) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (today.getTime() !== (window.lastStatDate || 0)) {
                todayCompleted = 0;
                window.lastStatDate = today.getTime();
                addLogEntry('é‡ç½®ä»Šæ—¥ç»Ÿè®¡', 'info', 'ç»Ÿè®¡');
            }
            
            if (record.type === 'focus') {
                totalCompleted++;
                totalMinutesCompleted += record.duration;
                
                if (record.startTime >= today) {
                    todayCompleted++;
                }
                
                addLogEntry(`ç•ªèŒ„é’Ÿå®Œæˆç»Ÿè®¡æ›´æ–°: ä»Šæ—¥${todayCompleted}ä¸ª, æ€»è®¡${totalCompleted}ä¸ª, æ€»æ—¶é•¿${totalMinutesCompleted}åˆ†é’Ÿ`, 'success', 'ç»Ÿè®¡');
            }
        }
        
        // æ›´æ–°è®°å½•æ˜¾ç¤º
        function updateRecordDisplay() {
            if (!recordListElement) return;
            
            recordListElement.innerHTML = '';
            
            if (pomodoroRecords.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'no-records';
                emptyItem.textContent = 'æš‚æ— è®°å½•ï¼Œå¼€å§‹ä½¿ç”¨ç•ªèŒ„é’Ÿå§ï¼';
                recordListElement.appendChild(emptyItem);
                return;
            }
            
            const displayRecords = pomodoroRecords.slice(0, 20);
            
            displayRecords.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const time = new Date(record.timestamp);
                const timeStr = time.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateStr = time.toLocaleDateString('zh-CN');
                
                const recordInfo = document.createElement('div');
                recordInfo.className = 'record-info';
                
                const timeSpan = document.createElement('div');
                timeSpan.className = 'record-time';
                timeSpan.textContent = `${dateStr} ${timeStr}`;
                
                const durationSpan = document.createElement('div');
                durationSpan.className = 'record-duration';
                durationSpan.textContent = `${record.type === 'focus' ? 'ä¸“æ³¨' : 'ä¼‘æ¯'} ${record.duration}åˆ†é’Ÿ`;
                
                const typeSpan = document.createElement('span');
                typeSpan.className = `record-type ${record.type}`;
                typeSpan.textContent = record.completed ? (record.type === 'focus' ? 'å®Œæˆ' : 'ä¼‘æ¯') : (record.type === 'focus' ? 'ä¸“æ³¨ä¸­' : 'ä¼‘æ¯ä¸­');
                
                recordInfo.appendChild(timeSpan);
                recordInfo.appendChild(durationSpan);
                
                recordItem.appendChild(recordInfo);
                recordItem.appendChild(typeSpan);
                
                recordListElement.appendChild(recordItem);
            });
            
            addLogEntry(`æ›´æ–°è®°å½•æ˜¾ç¤º: ${displayRecords.length}æ¡è®°å½•`, 'info', 'ç•Œé¢');
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatisticsDisplay() {
            if (todayPomodorosElement) {
                todayPomodorosElement.textContent = todayCompleted;
            }
            
            if (totalPomodorosElement) {
                totalPomodorosElement.textContent = totalCompleted;
            }
            
            if (totalMinutesElement) {
                totalMinutesElement.textContent = totalMinutesCompleted;
            }
        }
        
        // ä¿å­˜è®°å½•åˆ°localStorage
        function saveRecords() {
            try {
                const data = {
                    records: pomodoroRecords,
                    stats: {
                        totalCompleted: totalCompleted,
                        totalMinutesCompleted: totalMinutesCompleted,
                        lastStatDate: window.lastStatDate
                    },
                    logs: systemLogs.slice(0, 20) // ä¿å­˜æœ€è¿‘çš„20æ¡æ—¥å¿—
                };
                localStorage.setItem('pomodoroRecords', JSON.stringify(data));
                addLogEntry('è®°å½•ä¿å­˜æˆåŠŸ', 'success', 'å­˜å‚¨');
            } catch (error) {
                addLogEntry(`ä¿å­˜è®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // ä»localStorageåŠ è½½è®°å½•
        function loadRecords() {
            try {
                const savedData = localStorage.getItem('pomodoroRecords');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    pomodoroRecords = data.records || [];
                    totalCompleted = data.stats?.totalCompleted || 0;
                    totalMinutesCompleted = data.stats?.totalMinutesCompleted || 0;
                    
                    // åŠ è½½æ—¥å¿—
                    if (data.logs && Array.isArray(data.logs)) {
                        systemLogs = data.logs;
                        updateLogDisplay();
                        addLogEntry('ä»å­˜å‚¨åŠ è½½æ—¥å¿—', 'info', 'å­˜å‚¨');
                    }
                    
                    // è®¡ç®—ä»Šæ—¥å®Œæˆæ¬¡æ•°
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    todayCompleted = 0;
                    
                    pomodoroRecords.forEach(record => {
                        if (record.completed && record.type === 'focus') {
                            const recordDate = new Date(record.timestamp);
                            if (recordDate >= today) {
                                todayCompleted++;
                            }
                        }
                    });
                    
                    updateRecordDisplay();
                    updateStatisticsDisplay();
                    
                    addLogEntry(`è®°å½•åŠ è½½æˆåŠŸ: æ€»è®¡${totalCompleted}ä¸ª, ä»Šæ—¥${todayCompleted}ä¸ª, ${totalMinutesCompleted}åˆ†é’Ÿ`, 'success', 'å­˜å‚¨');
                }
            } catch (error) {
                addLogEntry(`åŠ è½½è®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        // æ¸…ç©ºæ‰€æœ‰è®°å½•
        async function clearAllRecords() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç•ªèŒ„é’Ÿè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                await playClickSound('stop');
                pomodoroRecords = [];
                todayCompleted = 0;
                totalCompleted = 0;
                totalMinutesCompleted = 0;
                
                localStorage.removeItem('pomodoroRecords');
                
                updateRecordDisplay();
                updateStatisticsDisplay();
                
                addLogEntry('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', 'warning', 'è®°å½•');
                showStatus('æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 3000);
            } catch (error) {
                addLogEntry(`æ¸…ç©ºè®°å½•å¤±è´¥: ${error.message}`, 'error', 'è®°å½•');
                showStatus('æ¸…ç©ºè®°å½•å¤±è´¥', 3000);
            }
        }
        
        // å¯¼å‡ºè®°å½•
        async function exportRecords() {
            try {
                await playClickSound('click');
                
                if (pomodoroRecords.length === 0) {
                    showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•', 2000);
                    addLogEntry('å¯¼å‡ºè®°å½•å¤±è´¥: è®°å½•ä¸ºç©º', 'warning', 'è®°å½•');
                    return;
                }
                
                const data = {
                    version: '6.2.0',
                    exportTime: new Date().toISOString(),
                    records: pomodoroRecords,
                    stats: {
                        totalCompleted: totalCompleted,
                        totalMinutesCompleted: totalMinutesCompleted,
                        todayCompleted: todayCompleted
                    }
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `pomodoro-records-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                addLogEntry(`è®°å½•å¯¼å‡ºæˆåŠŸ: ${pomodoroRecords.length}æ¡è®°å½•`, 'success', 'å¯¼å‡º');
                showStatus('è®°å½•å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶', 3000);
            } catch (error) {
                addLogEntry(`å¯¼å‡ºè®°å½•å¤±è´¥: ${error.message}`, 'error', 'å¯¼å‡º');
                showStatus('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 3000);
            }
        }
        
        // æµ‹è¯•å£°éŸ³åŠŸèƒ½
        async function testSound() {
            try {
                isTestingSound = true;
                
                if (!soundEnabled && !window.userInteracted) {
                    addLogEntry('æµ‹è¯•å£°éŸ³å¤±è´¥: éŸ³é¢‘æœªæ¿€æ´»', 'warning', 'éŸ³é¢‘');
                    showStatus('è¯·å…ˆç‚¹å‡»é¡µé¢æ¿€æ´»éŸ³é¢‘', 3000);
                    isTestingSound = false;
                    return;
                }
                
                await playClickSound('test');
                
                for (let i = 0; i < 3; i++) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const soundTypes = ['beep', 'bell', 'chord'];
                    const result = await playSound(soundTypes[i % soundTypes.length]);
                    
                    if (!result) {
                        addLogEntry(`å£°éŸ³æµ‹è¯•å¤±è´¥: ${soundTypes[i]}`, 'warning', 'éŸ³é¢‘');
                        break;
                    }
                }
                
                if (vibrationEnabled) {
                    vibrate([100, 50, 100]);
                }
                
                addLogEntry('å£°éŸ³æµ‹è¯•å®Œæˆ', 'success', 'éŸ³é¢‘');
                showStatus('å£°éŸ³æµ‹è¯•å®Œæˆ', 2000);
            } catch (error) {
                addLogEntry(`å£°éŸ³æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error', 'éŸ³é¢‘');
            } finally {
                isTestingSound = false;
            }
        }
        
        // åœæ­¢æ‰€æœ‰å£°éŸ³
        async function stopAllSounds() {
            try {
                audioGenerator.stopAll();
                
                if (soundInterval) {
                    clearInterval(soundInterval);
                    soundInterval = null;
                }
                
                await playClickSound('stop');
                addLogEntry('å·²åœæ­¢æ‰€æœ‰å£°éŸ³', 'info', 'éŸ³é¢‘');
                showStatus('æ‰€æœ‰å£°éŸ³å·²åœæ­¢', 2000);
            } catch (error) {
                addLogEntry(`åœæ­¢å£°éŸ³å¤±è´¥: ${error.message}`, 'error', 'éŸ³é¢‘');
            }
        }
        
        // å¼€å§‹ç•ªèŒ„é’Ÿ
        async function startPomodoro() {
            if (isPomodoroRunning) {
                addLogEntry('ç•ªèŒ„é’Ÿå·²åœ¨è¿è¡Œä¸­', 'warning', 'ç•ªèŒ„é’Ÿ');
                return;
            }
            
            await playClickSound('start');
            
            isPomodoroRunning = true;
            isFocusTime = true;
            
            const focusMinutes = parseInt(focusTimeInput.value) || 25;
            pomodoroSeconds = focusMinutes * 60;
            
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            focusTimeInput.disabled = true;
            breakTimeInput.disabled = true;
            
            addLogEntry(`å¼€å§‹ç•ªèŒ„é’Ÿ: ä¸“æ³¨${focusMinutes}åˆ†é’Ÿ`, 'success', 'ç•ªèŒ„é’Ÿ');
            showStatus(`ç•ªèŒ„é’Ÿå¼€å§‹: ${focusMinutes}åˆ†é’Ÿä¸“æ³¨æ—¶é—´`, 2000);
            
            updatePomodoroStatus();
            
            pomodoroTimer = setInterval(updatePomodoro, 1000);
            
            const recordStartTime = new Date();
            pomodoroRecords.unshift({
                id: Date.now(),
                type: 'focus',
                duration: focusMinutes,
                completed: false,
                startTime: recordStartTime,
                endTime: null,
                timestamp: recordStartTime.getTime()
            });
            
            updateRecordDisplay();
        }
        
        // æš‚åœç•ªèŒ„é’Ÿ
        async function pausePomodoro() {
            if (!isPomodoroRunning) {
                addLogEntry('ç•ªèŒ„é’Ÿæœªè¿è¡Œ', 'warning', 'ç•ªèŒ„é’Ÿ');
                return;
            }
            
            await playClickSound('stop');
            
            clearInterval(pomodoroTimer);
            isPomodoroRunning = false;
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            focusTimeInput.disabled = false;
            breakTimeInput.disabled = false;
            
            addLogEntry('ç•ªèŒ„é’Ÿå·²æš‚åœ', 'info', 'ç•ªèŒ„é’Ÿ');
            showStatus('ç•ªèŒ„é’Ÿå·²æš‚åœ', 2000);
            updatePomodoroStatus();
        }
        
        // é‡ç½®ç•ªèŒ„é’Ÿ
        async function resetPomodoro() {
            try {
                if (isPomodoroRunning) {
                    clearInterval(pomodoroTimer);
                }
                
                await playClickSound('test');
                
                isPomodoroRunning = false;
                isFocusTime = true;
                
                const focusMinutes = parseInt(focusTimeInput.value) || 25;
                pomodoroSeconds = focusMinutes * 60;
                
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                focusTimeInput.disabled = false;
                breakTimeInput.disabled = false;
                
                updateTimerDisplay(pomodoroSeconds);
                addLogEntry(`ç•ªèŒ„é’Ÿå·²é‡ç½®: ${focusMinutes}åˆ†é’Ÿ`, 'info', 'ç•ªèŒ„é’Ÿ');
                showStatus('ç•ªèŒ„é’Ÿå·²é‡ç½®', 2000);
                updatePomodoroStatus();
            } catch (error) {
                addLogEntry(`é‡ç½®ç•ªèŒ„é’Ÿå¤±è´¥: ${error.message}`, 'error', 'ç•ªèŒ„é’Ÿ');
            }
        }
        
        // æ›´æ–°ç•ªèŒ„é’Ÿ
        function updatePomodoro() {
            pomodoroSeconds--;
            updateTimerDisplay(pomodoroSeconds);
            
            if (pomodoroSeconds <= 0) {
                clearInterval(pomodoroTimer);
                
                if (isFocusTime) {
                    completeFocusSession();
                } else {
                    completeBreakSession();
                }
            } else if (pomodoroSeconds <= 60 && isFocusTime) {
                updateTimerDisplay(pomodoroSeconds);
                if (pomodoroSeconds <= 10) {
                    playSound(currentSoundType);
                    vibrate([100, 50, 100]);
                }
            }
        }
        
        // å®Œæˆä¸“æ³¨ä¼šè¯
        async function completeFocusSession() {
            const focusMinutes = parseInt(focusTimeInput.value) || 25;
            
            addLogEntry(`ä¸“æ³¨æ—¶é—´ç»“æŸ`, 'success', 'ç•ªèŒ„é’Ÿ');
            showStatus('ä¸“æ³¨æ—¶é—´ç»“æŸï¼å¼€å§‹ä¼‘æ¯', 5000);
            
            await playSound('bell');
            vibrate([200, 100, 200, 100, 200]);
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    playSound('bell');
                }, i * 1000);
            }
            
            pomodoroRecords[0].completed = true;
            pomodoroRecords[0].endTime = new Date();
            updatePomodoroStats(pomodoroRecords[0]);
            saveRecords();
            updateRecordDisplay();
            
            isFocusTime = false;
            const breakMinutes = parseInt(breakTimeInput.value) || 5;
            pomodoroSeconds = breakMinutes * 60;
            
            addPomodoroRecord('focus', focusMinutes, true);
            
            updatePomodoroStatus();
            
            pomodoroTimer = setInterval(updatePomodoro, 1000);
        }
        
        // å®Œæˆä¼‘æ¯ä¼šè¯
        async function completeBreakSession() {
            const breakMinutes = parseInt(breakTimeInput.value) || 5;
            
            addLogEntry(`ä¼‘æ¯æ—¶é—´ç»“æŸ`, 'info', 'ç•ªèŒ„é’Ÿ');
            showStatus('ä¼‘æ¯ç»“æŸï¼å¼€å§‹ä¸‹ä¸€ä¸ªä¸“æ³¨', 5000);
            
            await playSound('bell');
            vibrate([100, 50, 100, 50, 100]);
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    playSound('bell');
                }, i * 1000);
            }
            
            addPomodoroRecord('break', breakMinutes, true);
            
            isFocusTime = true;
            const focusMinutes = parseInt(focusTimeInput.value) || 25;
            pomodoroSeconds = focusMinutes * 60;
            
            updatePomodoroStatus();
            addPomodoroRecord('focus', focusMinutes, false);
            
            pomodoroTimer = setInterval(updatePomodoro, 1000);
        }
        
        // å¼€å§‹ä¸­æ–­
        async function startInterrupt() {
            if (isInterruptRunning) {
                addLogEntry('ä¸­æ–­å·²åœ¨è¿è¡Œä¸­', 'warning', 'ä¸­æ–­');
                return;
            }
            
            if (isPomodoroRunning) {
                addLogEntry('æ— æ³•ä¸­æ–­: ç•ªèŒ„é’Ÿè¿è¡Œä¸­', 'warning', 'ä¸­æ–­');
                showStatus('è¯·å…ˆæš‚åœç•ªèŒ„é’Ÿå†ä½¿ç”¨ä¸­æ–­åŠŸèƒ½', 3000);
                return;
            }
            
            await playClickSound('start');
            
            const minutes = parseInt(interruptMinutesInput.value) || 0;
            const seconds = parseInt(interruptSecondsInput.value) || 0;
            const reason = interruptReasonInput.value.trim() || 'æ— åŸå› ';
            
            if (minutes === 0 && seconds === 0) {
                addLogEntry('ä¸­æ–­å¤±è´¥: æ—¶é—´ä¸èƒ½ä¸º0', 'warning', 'ä¸­æ–­');
                showStatus('è¯·è®¾ç½®ä¸­æ–­æ—¶é—´', 2000);
                return;
            }
            
            interruptDuration = minutes * 60 + seconds;
            remainingSeconds = interruptDuration;
            
            if (interruptDuration <= 0) {
                addLogEntry('ä¸­æ–­å¤±è´¥: æ— æ•ˆæ—¶é—´', 'error', 'ä¸­æ–­');
                return;
            }
            
            isInterruptRunning = true;
            startInterruptBtn.disabled = true;
            cancelInterruptBtn.style.display = 'inline-block';
            
            interruptStartTime = Date.now();
            
            interruptTimerDisplay.classList.add('show');
            updateInterruptTimerDisplay(remainingSeconds);
            
            addLogEntry(`å¼€å§‹ä¸­æ–­: ${minutes}åˆ†${seconds}ç§’, åŸå› : ${reason}`, 'info', 'ä¸­æ–­');
            showStatus(`ä¸­æ–­å¼€å§‹: ${minutes}åˆ†${seconds}ç§’`, 2000);
            
            updateHistoryDisplay();
            
            updateInterrupt();
        }
        
        // æ›´æ–°ä¸­æ–­
        function updateInterrupt() {
            if (!isInterruptRunning) return;
            
            const elapsed = Math.floor((Date.now() - interruptStartTime) / 1000);
            remainingSeconds = Math.max(0, interruptDuration - elapsed);
            
            updateInterruptTimerDisplay(remainingSeconds);
            
            if (remainingSeconds <= 0) {
                completeInterrupt();
                return;
            }
            
            if (remainingSeconds <= 5) {
                updateInterruptTimerDisplay(remainingSeconds);
                
                if (remainingSeconds <= 3) {
                    playSound('bell');
                    vibrate([200]);
                }
            }
            
            interruptAnimationFrame = requestAnimationFrame(updateInterrupt);
        }
        
        // å®Œæˆä¸­æ–­
        async function completeInterrupt() {
            isInterruptRunning = false;
            
            cancelAnimationFrame(interruptAnimationFrame);
            interruptTimerDisplay.classList.remove('show');
            startInterruptBtn.disabled = false;
            cancelInterruptBtn.style.display = 'none';
            
            const minutes = parseInt(interruptMinutesInput.value) || 0;
            const seconds = parseInt(interruptSecondsInput.value) || 0;
            const reason = interruptReasonInput.value.trim() || 'æ— åŸå› ';
            
            await playSound('bell');
            vibrate([100, 50, 100, 50, 100]);
            
            const now = new Date();
            const interruptData = {
                timestamp: now.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                }),
                duration: `${minutes}åˆ†${seconds}ç§’`,
                reason: reason,
                seconds: minutes * 60 + seconds
            };
            
            currentSessionHistory.unshift(interruptData);
            
            if (currentSessionHistory.length > 10) {
                currentSessionHistory = currentSessionHistory.slice(0, 10);
            }
            
            try {
                const savedHistory = JSON.parse(localStorage.getItem('pomodoroInterruptHistory') || '[]');
                savedHistory.unshift({
                    timestamp: now.getTime(),
                    duration: interruptData.duration,
                    reason: interruptData.reason,
                    seconds: interruptData.seconds
                });
                
                if (savedHistory.length > 50) {
                    savedHistory.splice(50);
                }
                
                localStorage.setItem('pomodoroInterruptHistory', JSON.stringify(savedHistory));
            } catch (error) {
                addLogEntry(`ä¿å­˜ä¸­æ–­å†å²å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
            
            updateHistoryDisplay();
            addLogEntry(`ä¸­æ–­ç»“æŸ: ${minutes}åˆ†${seconds}ç§’, åŸå› : ${reason}`, 'success', 'ä¸­æ–­');
            showStatus(`ä¸­æ–­ç»“æŸ`, 3000);
            
            interruptReasonInput.value = '';
        }
        
        // å–æ¶ˆä¸­æ–­
        async function cancelInterrupt() {
            if (!isInterruptRunning) {
                addLogEntry('ä¸­æ–­æœªè¿è¡Œ', 'warning', 'ä¸­æ–­');
                return;
            }
            
            await playClickSound('stop');
            
            isInterruptRunning = false;
            
            cancelAnimationFrame(interruptAnimationFrame);
            interruptTimerDisplay.classList.remove('show');
            startInterruptBtn.disabled = false;
            cancelInterruptBtn.style.display = 'none';
            
            addLogEntry('ä¸­æ–­å·²å–æ¶ˆ', 'info', 'ä¸­æ–­');
            showStatus('ä¸­æ–­å·²å–æ¶ˆ', 2000);
        }
        
        // å¿«é€Ÿæµ‹è¯•ä¸­æ–­
        async function quickTestInterrupt(seconds) {
            if (isInterruptRunning) {
                addLogEntry('æ— æ³•æµ‹è¯•: ä¸­æ–­è¿è¡Œä¸­', 'warning', 'ä¸­æ–­');
                return;
            }
            
            await playClickSound('test');
            
            interruptMinutesInput.value = 0;
            interruptSecondsInput.value = seconds;
            interruptReasonInput.value = 'å¿«é€Ÿæµ‹è¯•';
            
            await startInterrupt();
            
            addLogEntry(`å¿«é€Ÿæµ‹è¯•ä¸­æ–­: ${seconds}ç§’`, 'info', 'ä¸­æ–­');
        }
        
        // æ›´æ–°ä¸­æ–­å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (currentSessionHistory.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'history-item empty-history';
                emptyItem.textContent = 'æš‚æ— ä¸­æ–­è®°å½•';
                historyList.appendChild(emptyItem);
                return;
            }
            
            currentSessionHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const timeElement = document.createElement('div');
                timeElement.className = 'history-time';
                timeElement.textContent = item.timestamp;
                
                const detailsElement = document.createElement('div');
                detailsElement.className = 'history-details';
                
                const durationSpan = document.createElement('span');
                durationSpan.textContent = `æ—¶é•¿: ${item.duration}`;
                
                const reasonSpan = document.createElement('span');
                reasonSpan.textContent = `åŸå› : ${item.reason}`;
                
                detailsElement.appendChild(durationSpan);
                detailsElement.appendChild(reasonSpan);
                
                historyItem.appendChild(timeElement);
                historyItem.appendChild(detailsElement);
                
                historyList.appendChild(historyItem);
            });
            
            addLogEntry(`æ›´æ–°ä¸­æ–­å†å²æ˜¾ç¤º: ${currentSessionHistory.length}æ¡è®°å½•`, 'info', 'ç•Œé¢');
        }
        
        // æ¸…é™¤å†å²
        async function clearHistory() {
            if (currentSessionHistory.length === 0) {
                addLogEntry('å†å²è®°å½•å·²ä¸ºç©º', 'warning', 'ä¸­æ–­');
                showStatus('å†å²è®°å½•å·²ä¸ºç©º', 2000);
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºä¸­æ–­å†å²è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            await playClickSound('stop');
            
            currentSessionHistory = [];
            
            try {
                localStorage.removeItem('pomodoroInterruptHistory');
            } catch (error) {
                addLogEntry(`æ¸…é™¤å†å²è®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
            
            updateHistoryDisplay();
            addLogEntry('ä¸­æ–­å†å²å·²æ¸…ç©º', 'info', 'ä¸­æ–­');
            showStatus('ä¸­æ–­å†å²å·²æ¸…ç©º', 2000);
        }
        
        // åº”ç”¨é¢„è®¾æ—¶é—´
        async function applyPresetTime(minutes) {
            if (isPomodoroRunning) {
                addLogEntry('æ— æ³•æ›´æ”¹æ—¶é—´: ç•ªèŒ„é’Ÿè¿è¡Œä¸­', 'warning', 'è®¾ç½®');
                showStatus('è¯·å…ˆæš‚åœç•ªèŒ„é’Ÿå†æ›´æ”¹æ—¶é—´', 2000);
                return;
            }
            
            await playClickSound('test');
            
            focusTimeInput.value = minutes;
            
            const presetTimeButtons = document.querySelectorAll('.preset-time');
            presetTimeButtons.forEach(button => {
                button.classList.remove('active');
                if (parseInt(button.dataset.minutes) === minutes) {
                    button.classList.add('active');
                }
            });
            
            resetPomodoro();
            addLogEntry(`åº”ç”¨é¢„è®¾æ—¶é—´: ${minutes}åˆ†é’Ÿ`, 'info', 'è®¾ç½®');
            showStatus(`ä¸“æ³¨æ—¶é—´è®¾ç½®ä¸º${minutes}åˆ†é’Ÿ`, 2000);
        }
        
        // åº”ç”¨è‡ªå®šä¹‰æ—¶é—´
        async function applyCustomTime() {
            const minutes = parseInt(customMinutesInput.value);
            
            if (isNaN(minutes) || minutes < 1 || minutes > 120) {
                addLogEntry('æ— æ•ˆçš„è‡ªå®šä¹‰æ—¶é—´', 'warning', 'è®¾ç½®');
                showStatus('è¯·è¾“å…¥1-120ä¹‹é—´çš„æ•°å­—', 2000);
                return;
            }
            
            if (isPomodoroRunning) {
                addLogEntry('æ— æ³•æ›´æ”¹æ—¶é—´: ç•ªèŒ„é’Ÿè¿è¡Œä¸­', 'warning', 'è®¾ç½®');
                showStatus('è¯·å…ˆæš‚åœç•ªèŒ„é’Ÿå†æ›´æ”¹æ—¶é—´', 2000);
                return;
            }
            
            await playClickSound('test');
            focusTimeInput.value = minutes;
            resetPomodoro();
            
            addLogEntry(`åº”ç”¨è‡ªå®šä¹‰æ—¶é—´: ${minutes}åˆ†é’Ÿ`, 'info', 'è®¾ç½®');
            showStatus(`ä¸“æ³¨æ—¶é—´è®¾ç½®ä¸º${minutes}åˆ†é’Ÿ`, 2000);
        }
        
        // æ›´æ–°ç•ªèŒ„é’ŸçŠ¶æ€æ˜¾ç¤º
        function updatePomodoroStatus() {
            const pomodoroStatus = document.getElementById('pomodoroStatus');
            if (!pomodoroStatus) return;
            
            if (isPomodoroRunning) {
                pomodoroStatus.textContent = isFocusTime ? 'â³ ä¸“æ³¨ä¸­...' : 'â˜•ï¸ ä¼‘æ¯ä¸­...';
            } else {
                pomodoroStatus.textContent = 'ğŸ¯ å‡†å¤‡å¼€å§‹ä¸“æ³¨';
            }
            
            addLogEntry(`çŠ¶æ€æ›´æ–°: ${pomodoroStatus.textContent}`, 'info', 'ç•ªèŒ„é’Ÿ');
        }
        
        // è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo(message) {
            console.log('ğŸ”§ DEBUG:', message);
        }
        
        // è·å–DOMå…ƒç´ å¼•ç”¨
        const focusTimeInput = document.getElementById('focusTime');
        const breakTimeInput = document.getElementById('breakTime');
        const volumeControl = document.getElementById('volumeControl');
        const volumeValue = document.getElementById('volumeValue');
        const soundOptions = document.querySelectorAll('.sound-option');
        const vibrationToggle = document.getElementById('vibrationToggle');
        const clickSoundToggle = document.getElementById('clickSoundToggle');
        const testSoundBtn2 = document.getElementById('testSoundBtn2');
        const stopSoundBtn = document.getElementById('stopSoundBtn');
        const presetTimeButtons = document.querySelectorAll('.preset-time');
        const customMinutesInput = document.getElementById('customMinutes');
        const setCustomTimeBtn = document.getElementById('setCustomTimeBtn');
        const quickTestButtons = document.querySelectorAll('.quick-test-btn');
        const recordListElement = document.getElementById('recordList');
        const todayPomodorosElement = document.getElementById('todayPomodoros');
        const totalPomodorosElement = document.getElementById('totalPomodoros');
        const totalMinutesElement = document.getElementById('totalMinutes');
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            addLogEntry('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...', 'info', 'ç³»ç»Ÿ');
            
            // ç•ªèŒ„é’Ÿæ§åˆ¶æŒ‰é’®
            if (startBtn) {
                startBtn.addEventListener('click', startPomodoro);
                addLogEntry('å¼€å§‹æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¼€å§‹æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', pausePomodoro);
                addLogEntry('æš‚åœæŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æš‚åœæŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', resetPomodoro);
                addLogEntry('é‡ç½®æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('é‡ç½®æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // è®°å½•æ§åˆ¶æŒ‰é’®
            if (exportRecordsBtn) {
                exportRecordsBtn.addEventListener('click', exportRecords);
                addLogEntry('å¯¼å‡ºè®°å½•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¯¼å‡ºè®°å½•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (clearRecordsBtn) {
                clearRecordsBtn.addEventListener('click', clearAllRecords);
                addLogEntry('æ¸…ç©ºè®°å½•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æ¸…ç©ºè®°å½•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å£°éŸ³æ§åˆ¶æŒ‰é’®
            if (stopSoundBtn) {
                stopSoundBtn.addEventListener('click', stopAllSounds);
                addLogEntry('åœæ­¢å£°éŸ³æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('åœæ­¢å£°éŸ³æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (testSoundBtn) {
                testSoundBtn.addEventListener('click', testSound);
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®1ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®1å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (testSoundBtn2) {
                testSoundBtn2.addEventListener('click', testSound);
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®2ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æµ‹è¯•å£°éŸ³æŒ‰é’®2å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // ä¸­æ–­æ§åˆ¶
            if (startInterruptBtn) {
                startInterruptBtn.addEventListener('click', startInterrupt);
                addLogEntry('å¼€å§‹ä¸­æ–­æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¼€å§‹ä¸­æ–­æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (cancelInterruptBtn) {
                cancelInterruptBtn.addEventListener('click', cancelInterrupt);
                addLogEntry('å–æ¶ˆä¸­æ–­æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å–æ¶ˆä¸­æ–­æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
                addLogEntry('æ¸…ç©ºå†å²æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æ¸…ç©ºå†å²æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å£°éŸ³è®¾ç½®
            if (volumeControl) {
                volumeControl.addEventListener('input', function() {
                    volume = this.value / 100;
                    if (volumeValue) {
                        volumeValue.textContent = this.value + '%';
                    }
                    
                    addLogEntry(`éŸ³é‡è®¾ç½®ä¸º: ${this.value}%`, 'info', 'éŸ³é¢‘');
                    
                    if (volume > 0) {
                        playClickSound('test');
                    }
                });
                addLogEntry('éŸ³é‡æ§åˆ¶ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('éŸ³é‡æ§åˆ¶å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å£°éŸ³ç±»å‹é€‰æ‹©
            if (soundOptions && soundOptions.length > 0) {
                soundOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        soundOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        currentSoundType = this.dataset.sound;
                        
                        addLogEntry(`å£°éŸ³ç±»å‹åˆ‡æ¢ä¸º: ${currentSoundType}`, 'info', 'éŸ³é¢‘');
                        
                        if (soundEnabled) {
                            playSound(currentSoundType);
                        }
                    });
                });
                addLogEntry('å£°éŸ³é€‰é¡¹ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å£°éŸ³é€‰é¡¹å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // éœ‡åŠ¨æ§åˆ¶
            if (vibrationToggle) {
                vibrationToggle.addEventListener('change', function() {
                    vibrationEnabled = this.checked;
                    if (vibrationEnabled) {
                        vibrate(50);
                    }
                    
                    addLogEntry(`éœ‡åŠ¨åŠŸèƒ½: ${vibrationEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info', 'è®¾å¤‡');
                });
                addLogEntry('éœ‡åŠ¨æ§åˆ¶ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('éœ‡åŠ¨æ§åˆ¶å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // ç‚¹å‡»éŸ³æ•ˆæ§åˆ¶
            if (clickSoundToggle) {
                clickSoundToggle.addEventListener('change', function() {
                    clickSoundEnabled = this.checked;
                    addLogEntry(`ç‚¹å‡»éŸ³æ•ˆ: ${clickSoundEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info', 'éŸ³é¢‘');
                    
                    if (clickSoundEnabled) {
                        playClickSound('test');
                    }
                });
                addLogEntry('ç‚¹å‡»éŸ³æ•ˆæ§åˆ¶ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('ç‚¹å‡»éŸ³æ•ˆæ§åˆ¶å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // é¢„è®¾æ—¶é—´æŒ‰é’®
            if (presetTimeButtons && presetTimeButtons.length > 0) {
                presetTimeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const minutes = parseInt(this.dataset.minutes);
                        applyPresetTime(minutes);
                    });
                });
                addLogEntry('é¢„è®¾æ—¶é—´æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('é¢„è®¾æ—¶é—´æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // è‡ªå®šä¹‰æ—¶é—´è®¾ç½®
            if (setCustomTimeBtn) {
                setCustomTimeBtn.addEventListener('click', applyCustomTime);
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // å¿«é€Ÿæµ‹è¯•ä¸­æ–­æŒ‰é’®
            if (quickTestButtons && quickTestButtons.length > 0) {
                quickTestButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const seconds = parseInt(this.dataset.seconds);
                        quickTestInterrupt(seconds);
                    });
                });
                addLogEntry('å¿«é€Ÿæµ‹è¯•æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('å¿«é€Ÿæµ‹è¯•æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // æ—¥å¿—æ§åˆ¶æŒ‰é’®
            if (clearLogBtn) {
                clearLogBtn.addEventListener('click', clearLogs);
                addLogEntry('æ¸…ç©ºæ—¥å¿—æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('æ¸…ç©ºæ—¥å¿—æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            if (toggleLogBtn) {
                toggleLogBtn.addEventListener('click', toggleLogVisibility);
                addLogEntry('åˆ‡æ¢æ—¥å¿—æŒ‰é’®ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            } else {
                addLogEntry('åˆ‡æ¢æ—¥å¿—æŒ‰é’®å…ƒç´ ä¸å­˜åœ¨', 'error', 'ç³»ç»Ÿ');
            }
            
            // è¾“å…¥éªŒè¯
            const timeInputs = [focusTimeInput, breakTimeInput, interruptMinutesInput, interruptSecondsInput];
            timeInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        let value = parseInt(this.value) || 0;
                        
                        if (this === focusTimeInput || this === breakTimeInput) {
                            if (value < 1) this.value = 1;
                            if (value > 120) this.value = 120;
                        } else if (this === interruptMinutesInput) {
                            if (value < 0) this.value = 0;
                            if (value > 120) this.value = 120;
                        } else if (this === interruptSecondsInput) {
                            if (value < 0) this.value = 0;
                            if (value > 59) this.value = 59;
                        }
                    });
                    
                    addLogEntry(`è¾“å…¥éªŒè¯ç›‘å¬å™¨å·²ç»‘å®š: ${input.id}`, 'success', 'äº‹ä»¶');
                }
            });
            
            // æ·»åŠ ç„¦ç‚¹è¾“å…¥æ¡†
            if (customMinutesInput) {
                customMinutesInput.addEventListener('input', function() {
                    let value = parseInt(this.value) || 1;
                    if (value < 1) this.value = 1;
                    if (value > 120) this.value = 120;
                    
                    addLogEntry(`è‡ªå®šä¹‰æ—¶é—´è¾“å…¥: ${value}åˆ†é’Ÿ`, 'info', 'è¾“å…¥');
                });
                addLogEntry('è‡ªå®šä¹‰æ—¶é—´è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            // æ·»åŠ ä¸­æ–­åŸå› è¾“å…¥ç›‘å¬
            if (interruptReasonInput) {
                interruptReasonInput.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        addLogEntry(`ä¸­æ–­åŸå› è¾“å…¥: ${this.value}`, 'info', 'è¾“å…¥');
                    }
                });
                addLogEntry('ä¸­æ–­åŸå› è¾“å…¥ç›‘å¬å™¨å·²ç»‘å®š', 'success', 'äº‹ä»¶');
            }
            
            addLogEntry('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ', 'success', 'ç³»ç»Ÿ');
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('pomodoroInterruptHistory');
                if (savedHistory) {
                    const allHistory = JSON.parse(savedHistory);
                    currentSessionHistory = allHistory.slice(0, 10).map(item => ({
                        time: new Date(item.timestamp).toLocaleTimeString('zh-CN', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }),
                        duration: item.duration,
                        reason: item.reason,
                        seconds: item.seconds
                    }));
                    updateHistoryDisplay();
                    addLogEntry('åŠ è½½ä¸­æ–­å†å²æˆåŠŸ', 'success', 'å­˜å‚¨');
                } else {
                    addLogEntry('æ— ä¸­æ–­å†å²è®°å½•', 'info', 'å­˜å‚¨');
                }
            } catch (error) {
                addLogEntry(`åŠ è½½ä¸­æ–­å†å²è®°å½•å¤±è´¥: ${error.message}`, 'error', 'å­˜å‚¨');
            }
        }
        
        // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€
        function checkAudioContextStatus() {
            if (!audioGenerator.getAudioContext()) {
                addLogEntry('AudioContextæœªåˆå§‹åŒ–', 'warning', 'éŸ³é¢‘');
                deviceStatusElement.textContent = 'ğŸ”§ éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–ä¸­...';
            } else {
                const ctx = audioGenerator.getAudioContext();
                addLogEntry(`AudioContextçŠ¶æ€: ${ctx.state}`, 'info', 'éŸ³é¢‘');
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            addLogEntry('åˆå§‹åŒ–ç•ªèŒ„é’Ÿåº”ç”¨ v6.2.0', 'info', 'ç³»ç»Ÿ');
            addLogEntry(`ç”¨æˆ·ä»£ç†: ${navigator.userAgent}`, 'info', 'ç³»ç»Ÿ');
            addLogEntry(`å¹³å°: ${navigator.platform}`, 'info', 'ç³»ç»Ÿ');
            addLogEntry(`è®¾å¤‡æ£€æµ‹: ${window.isIOS ? 'iOSè®¾å¤‡' : 'éiOSè®¾å¤‡'}`, 'info', 'ç³»ç»Ÿ');
            
            // åˆå§‹åŒ–éŸ³é¢‘
            await initAudioSystem();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            initEventListeners();
            
            // åŠ è½½å†å²è®°å½•
            loadHistory();
            
            // åŠ è½½ç•ªèŒ„é’Ÿè®°å½•
            loadRecords();
            
            // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€
            checkAudioContextStatus();
            
            // æ›´æ–°åˆå§‹çŠ¶æ€
            const focusMinutes = parseInt(focusTimeInput.value) || 25;
            pomodoroSeconds = focusMinutes * 60;
            updateTimerDisplay(pomodoroSeconds);
            updatePomodoroStatus();
            
            // æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§
            checkDeviceCompatibility();
            
            // åˆå§‹åŒ–å®Œæˆ
            addLogEntry('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success', 'ç³»ç»Ÿ');
            showStatus('ç•ªèŒ„é’Ÿv6.2.0å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ï¼', 3000);
        }
        
        // æ£€æŸ¥è®¾å¤‡å…¼å®¹æ€§
        function checkDeviceCompatibility() {
            const compatibilityDiv = document.createElement('div');
            compatibilityDiv.id = 'compatibilityStatus';
            compatibilityDiv.className = 'compatibility-warning hidden';
            
            let warnings = [];
            
            // æ£€æŸ¥Web Audio API
            if (!window.AudioContext && !window.webkitAudioContext) {
                warnings.push('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Audio APIï¼Œå£°éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥Vibration API
            if (!navigator.vibrate) {
                warnings.push('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒéœ‡åŠ¨APIï¼Œéœ‡åŠ¨åŠŸèƒ½å°†ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                warnings.push('LocalStorageä¸å¯ç”¨ï¼Œè®°å½•å°†æ— æ³•ä¿å­˜');
            }
            
            // æ£€æŸ¥è§¦æ‘¸æ”¯æŒ
            if (!('ontouchstart' in window) && !navigator.maxTouchPoints) {
                warnings.push('æœªæ£€æµ‹åˆ°è§¦æ‘¸æ”¯æŒï¼Œå¯èƒ½ä¸æ˜¯ç§»åŠ¨è®¾å¤‡');
            }
            
            if (warnings.length > 0) {
                compatibilityDiv.classList.remove('hidden');
                compatibilityDiv.classList.add('warning');
                
                let warningHTML = '<strong>âš ï¸ å…¼å®¹æ€§è­¦å‘Šï¼š</strong><ul>';
                warnings.forEach(warning => {
                    warningHTML += `<li>${warning}</li>`;
                });
                warningHTML += '</ul>';
                
                compatibilityDiv.innerHTML = warningHTML;
                document.querySelector('.container').insertBefore(compatibilityDiv, document.querySelector('.container').firstChild);
                
                warnings.forEach(warning => {
                    addLogEntry(`å…¼å®¹æ€§è­¦å‘Š: ${warning}`, 'warning', 'ç³»ç»Ÿ');
                });
            } else {
                compatibilityDiv.classList.remove('hidden');
                compatibilityDiv.classList.add('success');
                compatibilityDiv.textContent = 'âœ… è®¾å¤‡å…¼å®¹æ€§æ£€æµ‹é€šè¿‡';
                document.querySelector('.container').insertBefore(compatibilityDiv, document.querySelector('.container').firstChild);
                addLogEntry('è®¾å¤‡å…¼å®¹æ€§æ£€æµ‹é€šè¿‡', 'success', 'ç³»ç»Ÿ');
            }
        }
        
        // æ·»åŠ ç”¨æˆ·äº¤äº’æ¿€æ´»
        function setupUserActivation() {
            let activationAttempts = 0;
            const maxAttempts = 3;
            
            function tryActivateAudio() {
                activationAttempts++;
                addLogEntry(`å°è¯•æ¿€æ´»éŸ³é¢‘ (å°è¯• ${activationAttempts}/${maxAttempts})`, 'info', 'éŸ³é¢‘');
                
                if (activationAttempts >= maxAttempts) {
                    addLogEntry('éŸ³é¢‘æ¿€æ´»å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error', 'éŸ³é¢‘');
                    showStatus('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 5000);
                    return;
                }
                
                if (!soundEnabled && !window.userInteracted) {
                    addLogEntry('ç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ¿€æ´»éŸ³é¢‘åŠŸèƒ½', 'warning', 'éŸ³é¢‘');
                    showStatus('è¯·ç‚¹å‡»ä»»æ„ä½ç½®æ¿€æ´»éŸ³é¢‘åŠŸèƒ½', 3000);
                }
            }
            
            // é¡µé¢åŠ è½½åæ£€æŸ¥éŸ³é¢‘çŠ¶æ€
            setTimeout(tryActivateAudio, 2000);
            setTimeout(tryActivateAudio, 5000);
            setTimeout(tryActivateAudio, 10000);
        }
        
        // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶å¤„ç†
        document.addEventListener('click', async function(event) {
            // é¿å…é‡å¤å¤„ç†
            if (event._handledByAudioActivation) return;
            event._handledByAudioActivation = true;
            
            if (!window.userInteracted && 
                event.target.tagName !== 'INPUT' && 
                event.target.tagName !== 'TEXTAREA' &&
                event.target.tagName !== 'SELECT') {
                
                addLogEntry('ç”¨æˆ·ç‚¹å‡»ï¼Œå°è¯•æ¿€æ´»éŸ³é¢‘', 'info', 'éŸ³é¢‘');
                
                try {
                    // ç¡®ä¿éŸ³é¢‘ç”Ÿæˆå™¨å·²åˆå§‹åŒ–
                    if (!audioGenerator) {
                        addLogEntry('éŸ³é¢‘ç”Ÿæˆå™¨æœªåˆå§‹åŒ–', 'error', 'éŸ³é¢‘');
                        return;
                    }
                    
                    // æ¿€æ´»éŸ³é¢‘
                    const success = await audioGenerator.ensureRunning();
                    if (success) {
                        window.userInteracted = true;
                        soundEnabled = true;
                        
                        updateDeviceStatus();
                        addLogEntry('éŸ³é¢‘å·²æ¿€æ´»', 'success', 'éŸ³é¢‘');
                        showStatus('âœ… éŸ³é¢‘å·²æ¿€æ´»ï¼', 2000);
                        
                        // æ’­æ”¾ç¡®è®¤éŸ³
                        playSound('beep');
                        
                        // ç§»é™¤å…¨å±€ç‚¹å‡»äº‹ä»¶
                        this.removeEventListener('click', arguments.callee);
                    } else {
                        addLogEntry('éŸ³é¢‘æ¿€æ´»å¤±è´¥', 'error', 'éŸ³é¢‘');
                        showStatus('âš ï¸ éŸ³é¢‘æ¿€æ´»å¤±è´¥ï¼Œè¯·é‡è¯•', 2000);
                    }
                } catch (error) {
                    addLogEntry(`éŸ³é¢‘æ¿€æ´»å¼‚å¸¸: ${error.message}`, 'error', 'éŸ³é¢‘');
                    showStatus('âŒ éŸ³é¢‘æ¿€æ´»å‡ºé”™', 2000);
                }
            }
            
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            if (clickSoundEnabled && 
                audioGenerator &&
                event.target.tagName === 'BUTTON' && 
                event.target.id !== 'testSoundBtn' &&
                event.target.id !== 'testSoundBtn2' &&
                event.target.id !== 'stopSoundBtn') {
                
                // é¿å…å¿«é€Ÿè¿ç»­ç‚¹å‡»
                if (event.target._lastClick && (Date.now() - event.target._lastClick) < 300) {
                    return;
                }
                event.target._lastClick = Date.now();
                
                try {
                    await playClickSound('normal');
                } catch (error) {
                    addLogEntry(`ç‚¹å‡»éŸ³æ•ˆå¤±è´¥: ${error.message}`, 'warning', 'éŸ³é¢‘');
                }
            }
        });
        
        // å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', async function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.code) {
                case 'Space':
                case 'Enter':
                    event.preventDefault();
                    addLogEntry(`é”®ç›˜å¿«æ·é”®: ${event.code}`, 'info', 'é”®ç›˜');
                    if (isPomodoroRunning) {
                        await pausePomodoro();
                    } else {
                        await startPomodoro();
                    }
                    break;
                case 'KeyR':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Ctrl+R', 'info', 'é”®ç›˜');
                        await resetPomodoro();
                    }
                    break;
                case 'KeyI':
                    if (!isInterruptRunning) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: I', 'info', 'é”®ç›˜');
                        await startInterrupt();
                    }
                    break;
                case 'Escape':
                    if (isInterruptRunning) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Escape', 'info', 'é”®ç›˜');
                        await cancelInterrupt();
                    }
                    break;
                case 'KeyL':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Ctrl+L', 'info', 'é”®ç›˜');
                        toggleLogVisibility();
                    }
                    break;
                case 'KeyC':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        addLogEntry('é”®ç›˜å¿«æ·é”®: Ctrl+C', 'info', 'é”®ç›˜');
                        if (event.shiftKey) {
                            clearLogs();
                        }
                    }
                    break;
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('DOMå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...', 'info', 'ç³»ç»Ÿ');
            
            // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            const requiredElements = {
                'startBtn': startBtn,
                'pauseBtn': pauseBtn,
                'resetBtn': resetBtn,
                'timerDisplay': timerDisplay,
                'statusBar': statusBar,
                'focusTimeInput': focusTimeInput,
                'breakTimeInput': breakTimeInput
            };
            
            Object.entries(requiredElements).forEach(([name, element]) => {
                if (element) {
                    addLogEntry(`âœ… ${name} å…ƒç´ å­˜åœ¨`, 'success', 'ç³»ç»Ÿ');
                } else {
                    addLogEntry(`âŒ ${name} å…ƒç´ ä¸å­˜åœ¨`, 'error', 'ç³»ç»Ÿ');
                }
            });
            
            // åˆå§‹åŒ–åº”ç”¨
            initApp();
            
            // è®¾ç½®ç”¨æˆ·æ¿€æ´»
            setupUserActivation();
            
            // æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
            setTimeout(() => {
                addLogEntry('æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:', 'info', 'ç³»ç»Ÿ');
                
                const ctx = audioGenerator.getAudioContext();
                addLogEntry(`AudioContextçŠ¶æ€: ${ctx ? ctx.state : 'æœªåˆ›å»º'}`, 
                    ctx && ctx.state === 'running' ? 'success' : 'warning', 'éŸ³é¢‘');
                addLogEntry(`éŸ³é¢‘çŠ¶æ€: ${soundEnabled ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`,
                    soundEnabled ? 'success' : 'warning', 'éŸ³é¢‘');
                addLogEntry(`ç•ªèŒ„é’ŸçŠ¶æ€: ${isPomodoroRunning ? 'è¿è¡Œä¸­' : 'åœæ­¢'}`,
                    'info', 'ç•ªèŒ„é’Ÿ');
                addLogEntry(`ç”¨æˆ·äº¤äº’: ${window.userInteracted ? 'æ˜¯' : 'å¦'}`,
                    window.userInteracted ? 'success' : 'warning', 'ç³»ç»Ÿ');
                addLogEntry(`ç‚¹å‡»éŸ³æ•ˆ: ${clickSoundEnabled ? 'å¼€å¯' : 'å…³é—­'}`,
                    'info', 'éŸ³é¢‘');
                addLogEntry(`è®°å½•æ¡æ•°: ${pomodoroRecords.length}`, 'info', 'è®°å½•');
                addLogEntry(`ä»Šæ—¥å®Œæˆ: ${todayCompleted}`, 'info', 'ç»Ÿè®¡');
                addLogEntry(`æ€»å®Œæˆ: ${totalCompleted}`, 'info', 'ç»Ÿè®¡');
                
                if (!window.userInteracted) {
                    addLogEntry('ç­‰å¾…ç”¨æˆ·äº¤äº’æ¿€æ´»éŸ³é¢‘', 'warning', 'éŸ³é¢‘');
                    showStatus('è¯·ç‚¹å‡»ä»»æ„ä½ç½®æ¿€æ´»å£°éŸ³åŠŸèƒ½', 0);
                }
            }, 2000);
            
            // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', (event) => {
                addLogEntry(`å…¨å±€JavaScripté”™è¯¯: ${event.message}`, 'error', 'ç³»ç»Ÿ');
                addLogEntry(`æ–‡ä»¶: ${event.filename}, è¡Œ: ${event.lineno}, åˆ—: ${event.colno}`, 
                    'error', 'ç³»ç»Ÿ');
                console.error("ğŸš¨ å…¨å±€JavaScripté”™è¯¯:", event.error);
                
                // å°è¯•ä»é”™è¯¯ä¸­æ¢å¤
                if (event.message && (event.message.includes('AudioContext') || 
                    event.message.includes('audio'))) {
                    addLogEntry('æ£€æµ‹åˆ°éŸ³é¢‘é”™è¯¯ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...', 'warning', 'éŸ³é¢‘');
                    try {
                        audioGenerator.stopAll();
                        soundEnabled = false;
                        window.userInteracted = false;
                        initAudioSystem();
                        showStatus('éŸ³é¢‘ç³»ç»Ÿå·²é‡ç½®ï¼Œè¯·é‡æ–°ç‚¹å‡»é¡µé¢', 3000);
                    } catch (e) {
                        addLogEntry(`éŸ³é¢‘ç³»ç»Ÿé‡ç½®å¤±è´¥: ${e.message}`, 'error', 'éŸ³é¢‘');
                    }
                }
            });
            
            // æœªå¤„ç†çš„Promiseæ‹’ç»
            window.addEventListener('unhandledrejection', (event) => {
                addLogEntry(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error', 'ç³»ç»Ÿ');
                console.error("ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:", event.reason);
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    addLogEntry('é¡µé¢éšè—', 'info', 'ç³»ç»Ÿ');
                } else {
                    addLogEntry('é¡µé¢å¯è§', 'info', 'ç³»ç»Ÿ');
                }
            });
            
            // é¡µé¢å¸è½½å‰ä¿å­˜æ•°æ®
            window.addEventListener('beforeunload', () => {
                saveRecords();
                addLogEntry('é¡µé¢å¸è½½ï¼Œä¿å­˜æ•°æ®', 'info', 'ç³»ç»Ÿ');
            });
            
            addLogEntry('ğŸ¯ ç•ªèŒ„é’Ÿv6.2.0 å®Œå…¨åŠ è½½å®Œæˆï¼', 'success', 'ç³»ç»Ÿ');
        });
        
        // é˜²æ­¢é¡µé¢æ»šåŠ¨æ—¶çš„å¹²æ‰°
        let isScrolling = false;
        window.addEventListener('scroll', () => {
            if (!isScrolling) {
                isScrolling = true;
                setTimeout(() => {
                    isScrolling = false;
                }, 100);
            }
        }, { passive: true });
        
        // æ·»åŠ è§¦æ‘¸äº‹ä»¶å¤„ç†é˜²æ­¢æ„å¤–æ»šåŠ¨
        let startY = 0;
        document.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            // å…è®¸æ­£å¸¸çš„å‚ç›´æ»šåŠ¨ï¼Œä½†é˜²æ­¢æ°´å¹³æ»šåŠ¨
            if (Math.abs(e.touches[0].clientY - startY) < Math.abs(e.touches[0].clientX - startX)) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // ç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æœ‰é€‚å½“çš„è§¦æ‘¸åé¦ˆ
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || 
                e.target.classList.contains('preset-time')) {
                e.target.classList.add('touch-feedback');
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || 
                e.target.classList.contains('preset-time')) {
                setTimeout(() => {
                    e.target.classList.remove('touch-feedback');
                }, 150);
            }
        }, { passive: true });
    </script>
</body>
</html>
