<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟计时器 | Pomodoro Timer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff6b6b;
            --primary-dark: #ff4757;
            --secondary-color: #1e90ff;
            --secondary-dark: #3742fa;
            --break-color: #2ed573;
            --break-dark: #1dd1a1;
            --dark-bg: #2c3e50;
            --darker-bg: #1e272e;
            --light-text: #f5f6fa;
            --medium-text: #dcdde1;
            --dark-text: #2f3640;
            --success-color: #44bd32;
            --warning-color: #e1b12c;
            --danger-color: #c23616;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .main-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .mode-indicator {
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .mode-indicator.work {
            color: var(--primary-color);
        }

        .mode-indicator.break {
            color: var(--break-color);
        }

        .pomodoro-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .time-display {
            font-size: 8rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .timer-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            min-width: 140px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light-text);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #3fa82a;
            transform: translateY(-2px);
        }

        .progress-ring {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto 30px;
        }

        .progress-ring-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        .progress-ring-circle.work {
            stroke: var(--primary-color);
        }

        .progress-ring-circle.break {
            stroke: var(--break-color);
        }

        .timer-settings {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .setting-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 20px;
            border-radius: 50px;
        }

        .time-input input {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.5rem;
            width: 60px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .time-input input:focus {
            outline: none;
        }

        .time-input button {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .time-input button:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-card, .tasks-card, .history-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--light-text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: var(--transition);
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: var(--transition);
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .task-checkbox.checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .task-checkbox.checked:after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-name {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .task-pomodoros {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-btn {
            background: none;
            border: none;
            color: var(--light-text);
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .task-btn:hover {
            opacity: 1;
        }

        .add-task {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .add-task input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50px;
            color: var(--light-text);
            font-size: 1rem;
        }

        .add-task input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-task {
            font-weight: 600;
        }

        .history-time {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .history-duration {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.info {
            background: var(--secondary-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--dark-bg);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--light-text);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .audio-activation-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: white;
            padding: 12px 20px;
            text-align: center;
            z-index: 9999;
            font-size: 0.9rem;
            animation: pulse 2s infinite;
        }

        .audio-activation-notice.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .notification-icon {
            animation: pulse 1.5s infinite;
        }

        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: none;
        }

        .settings-btn:hover {
            transform: rotate(30deg) scale(1.1);
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 80px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 140px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .time-input-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .time-input-controls button {
            width: 25px;
            height: 25px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .time-display {
                font-size: 5rem;
            }
            
            .progress-ring {
                width: 250px;
                height: 250px;
            }
            
            .btn {
                padding: 12px 20px;
                min-width: 120px;
                font-size: 1rem;
            }
            
            .timer-settings {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-card,
            .tasks-card,
            .history-card {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .time-display {
                font-size: 4rem;
            }
            
            .progress-ring {
                width: 200px;
                height: 200px;
            }
            
            .timer-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
            
            .settings-btn,
            .fullscreen-btn,
            .theme-toggle {
                width: 40px;
                height: 40px;
                bottom: 10px;
            }
            
            .fullscreen-btn {
                right: 60px;
            }
            
            .theme-toggle {
                right: 110px;
            }
        }

        /* 动画类 */
        .pulse {
            animation: pulse 2s infinite;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .zoom {
            animation: zoom 0.3s ease-out;
        }

        @keyframes zoom {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 音频激活提示 -->
    <div id="audio-activation-notice" class="audio-activation-notice">
        <span><i class="fas fa-volume-mute"></i> 点击任意位置启用音频提示</span>
    </div>

    <div class="container">
        <!-- 主计时器区域 -->
        <main class="main-content">
            <div class="timer-display">
                <div class="mode-indicator" id="modeIndicator">专注时间</div>
                <h1 class="pomodoro-name" id="pomodoroName">专注工作</h1>
                
                <div class="progress-ring">
                    <svg class="progress-ring-svg" viewBox="0 0 100 100">
                        <circle class="progress-ring-circle-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="progress-ring-circle" id="progressCircle" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="time-display" id="timeDisplay">25:00</div>
                </div>
                
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-primary">
                        <i class="fas fa-play"></i> 开始
                    </button>
                    <button id="pauseBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                    <button id="skipBtn" class="btn btn-secondary">
                        <i class="fas fa-forward"></i> 跳过
                    </button>
                </div>
                
                <div class="timer-settings">
                    <div class="setting-group">
                        <div class="setting-label">专注时间</div>
                        <div class="time-input">
                            <button id="decreaseWorkTime">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="text" id="workTimeInput" value="25" maxlength="3" readonly>
                            <button id="increaseWorkTime">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-label">休息时间</div>
                        <div class="time-input">
                            <button id="decreaseBreakTime">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="text" id="breakTimeInput" value="5" maxlength="3" readonly>
                            <button id="increaseBreakTime">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-label">长休息</div>
                        <div class="time-input">
                            <button id="decreaseLongBreakTime">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="text" id="longBreakTimeInput" value="15" maxlength="3" readonly>
                            <button id="increaseLongBreakTime">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 侧边栏 -->
        <aside class="sidebar">
            <!-- 统计卡片 -->
            <div class="stats-card">
                <div class="card-header">
                    <h2 class="card-title">今日统计</h2>
                    <button id="resetStatsBtn" class="btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="pomodorosCompleted">0</div>
                        <div class="stat-label">完成的番茄</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="focusTime">0h 0m</div>
                        <div class="stat-label">专注时长</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tasksCompleted">0</div>
                        <div class="stat-label">完成的任务</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalTime">0h 0m</div>
                        <div class="stat-label">总工作时长</div>
                    </div>
                </div>
            </div>

            <!-- 任务卡片 -->
            <div class="tasks-card">
                <div class="card-header">
                    <h2 class="card-title">任务列表</h2>
                    <button id="addTaskBtn" class="btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                        <i class="fas fa-plus"></i> 添加
                    </button>
                </div>
                <div class="task-list" id="taskList">
                    <!-- 任务项会动态添加 -->
                </div>
                <div class="add-task">
                    <input type="text" id="newTaskInput" placeholder="输入新任务...">
                    <button id="confirmAddTask" class="btn-success" style="padding: 12px 20px;">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- 历史记录卡片 -->
            <div class="history-card">
                <div class="card-header">
                    <h2 class="card-title">历史记录</h2>
                    <button id="clearHistoryBtn" class="btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
                <div class="history-list" id="historyList">
                    <!-- 历史记录会动态添加 -->
                </div>
            </div>
        </aside>
    </div>

    <!-- 通知区域 -->
    <div class="notifications" id="notifications"></div>

    <!-- 番茄钟命名模态框 -->
    <div id="pomodoroNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">命名番茄钟</h2>
                <button class="modal-close" id="closeNameModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="pomodoroNameInput">番茄钟名称</label>
                <input type="text" id="pomodoroNameInput" placeholder="请输入番茄钟名称..." maxlength="50">
            </div>
            <div class="form-group">
                <label for="pomodoroCategory">分类</label>
                <select id="pomodoroCategory">
                    <option value="work">工作</option>
                    <option value="study">学习</option>
                    <option value="reading">阅读</option>
                    <option value="project">项目</option>
                    <option value="exercise">运动</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="form-actions">
                <button id="cancelNameBtn" class="btn btn-secondary">取消</button>
                <button id="saveNameBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 设置按钮 -->
    <button class="settings-btn" id="settingsBtn" title="设置">
        <i class="fas fa-cog"></i>
    </button>

    <!-- 全屏按钮 -->
    <button class="fullscreen-btn" id="fullscreenBtn" title="全屏">
        <i class="fas fa-expand"></i>
    </button>

    <!-- 主题切换按钮 -->
    <button class="theme-toggle" id="themeToggle" title="切换主题">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        // 番茄钟计时器主应用程序
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[系统] 番茄钟计时器初始化中...');
            console.log('[系统] 版本: 6.3.0 | 支持番茄钟命名功能');
            
            // 检查存储权限
            if (typeof Storage === 'undefined') {
                console.error('[系统] 此浏览器不支持Web存储');
                showNotification('此浏览器不支持本地存储功能，部分功能可能无法正常使用。', 'warning');
            }
            
            // 初始化存储
            initStorage();
            
            // 设置音频解锁
            setupAudioUnlock();
            
            // 检查设备兼容性
            checkCompatibility();
            
            // 初始化音频系统
            window.audioManager = new AudioManager();
            
            // 初始化应用
            initApp();
        });

        // 存储初始化函数
        async function initStorage() {
            try {
                // 尝试访问localStorage
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                console.log('[存储] 存储访问正常');
                return true;
            } catch (e) {
                console.warn('[存储] 浏览器隐私设置阻止了存储访问，将使用内存存储');
                // 回退到内存存储
                window.fallbackStorage = new Map();
                showNotification('浏览器隐私设置阻止了本地存储，历史记录和设置将在当前会话中保存。', 'warning');
                return false;
            }
        }

        // 检查设备兼容性
        function checkCompatibility() {
            const compatibility = {
                audio: 'AudioContext' in window || 'webkitAudioContext' in window,
                storage: typeof Storage !== 'undefined',
                notifications: 'Notification' in window,
                serviceWorker: 'serviceWorker' in navigator
            };
            
            console.log('[系统] 设备兼容性检查:', compatibility);
            
            if (!compatibility.audio) {
                console.warn('[系统] 音频API不支持，声音提示将不可用');
            }
            
            if (!compatibility.storage) {
                console.warn('[系统] 本地存储不支持，将使用会话存储');
            }
            
            return compatibility;
        }

        // 设置音频解锁
        function setupAudioUnlock() {
            const audioNotice = document.getElementById('audio-activation-notice');
            const unlockEvents = ['click', 'touchstart', 'keydown'];
            
            const unlockAudio = () => {
                if (window.audioManager) {
                    window.audioManager.unlockAudio();
                }
                if (audioNotice) {
                    audioNotice.classList.remove('show');
                }
                console.log('[音频] 音频系统已激活');
                
                // 播放测试声音
                if (window.audioManager && window.audioManager.unlocked) {
                    setTimeout(() => window.audioManager.playTest(), 100);
                }
                
                // 移除监听器
                unlockEvents.forEach(event => {
                    document.removeEventListener(event, unlockAudio);
                });
            };
            
            // 如果音频上下文需要用户交互，显示提示
            setTimeout(() => {
                if (window.audioManager && !window.audioManager.unlocked) {
                    audioNotice.classList.add('show');
                }
            }, 2000);
            
            unlockEvents.forEach(event => {
                document.addEventListener(event, unlockAudio, { once: true });
            });
        }

        // 音频管理器类
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.unlocked = false;
                this.audioElements = new Map();
                this.initAudio();
            }
            
            initAudio() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    
                    // 创建音频元素
                    this.createAudioElements();
                    
                    console.log('[音频] 音频系统初始化成功');
                } catch (error) {
                    console.error('[音频] 音频上下文创建失败:', error);
                }
            }
            
            createAudioElements() {
                const sounds = {
                    start: { frequency: 800, duration: 0.5 },
                    pause: { frequency: 600, duration: 0.3 },
                    complete: { frequency: 1000, duration: 1 },
                    alert: { frequency: 1200, duration: 0.2, type: 'square' },
                    notification: { frequency: 900, duration: 0.1, type: 'sine' }
                };
                
                Object.keys(sounds).forEach(key => {
                    this.createTone(sounds[key]);
                });
            }
            
            createTone(config) {
                if (!this.audioContext) return null;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = config.type || 'sine';
                    oscillator.frequency.value = config.frequency;
                    
                    gainNode.gain.value = 0.1;
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + config.duration);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    this.audioElements.set(config.frequency, { oscillator, gainNode, duration: config.duration });
                } catch (error) {
                    console.error('[音频] 创建音调失败:', error);
                }
            }
            
            unlockAudio() {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume().then(() => {
                        this.unlocked = true;
                        console.log('[音频] 音频上下文已解锁');
                    }).catch(error => {
                        console.error('[音频] 音频解锁失败:', error);
                    });
                } else {
                    this.unlocked = true;
                }
            }
            
            async playSound(type) {
                if (!this.unlocked) {
                    console.warn('[音频] 需要用户交互后才能播放声音');
                    return;
                }
                
                if (!this.audioContext) {
                    this.initAudio();
                    if (!this.audioContext) return;
                }
                
                try {
                    const configs = {
                        start: { frequency: 800, duration: 0.5 },
                        pause: { frequency: 600, duration: 0.3 },
                        complete: { frequency: 1000, duration: 1 },
                        alert: { frequency: 1200, duration: 0.2, type: 'square' },
                        notification: { frequency: 900, duration: 0.1, type: 'sine' }
                    };
                    
                    const config = configs[type];
                    if (!config) return;
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = config.type || 'sine';
                    oscillator.frequency.value = config.frequency;
                    
                    gainNode.gain.value = 0.1;
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    const now = this.audioContext.currentTime;
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + config.duration);
                    
                    oscillator.start(now);
                    oscillator.stop(now + config.duration);
                    
                } catch (error) {
                    console.error('[音频] 播放声音失败:', error);
                }
            }
            
            playTest() {
                this.playSound('notification');
            }
        }

        // 初始化应用程序
        function initApp() {
            // 初始化状态
            window.timerState = {
                isRunning: false,
                isPaused: false,
                isWorkTime: true,
                timeLeft: 25 * 60, // 25分钟
                workTime: 25 * 60,
                breakTime: 5 * 60,
                longBreakTime: 15 * 60,
                pomodorosCompleted: 0,
                focusTimeToday: 0,
                tasksCompleted: 0,
                currentTask: null,
                timerInterval: null,
                pomodoroName: '专注工作',
                pomodoroCategory: 'work',
                completedPomodoros: [],
                tasks: []
            };
            
            // 从存储加载数据
            loadFromStorage();
            
            // 更新显示
            updateDisplay();
            updateStats();
            renderTaskList();
            renderHistory();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 初始化通知权限
            initNotifications();
            
            console.log('[系统] 应用程序初始化完成');
        }

        // 从存储加载数据
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem('pomodoroTimerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    Object.assign(window.timerState, data);
                    
                    // 确保时间相关状态正确
                    if (window.timerState.isWorkTime) {
                        window.timerState.timeLeft = window.timerState.workTime;
                    } else {
                        window.timerState.timeLeft = window.timerState.breakTime;
                    }
                    
                    console.log('[存储] 数据加载成功');
                }
            } catch (error) {
                console.error('[存储] 加载数据失败:', error);
            }
        }

        // 保存数据到存储
        function saveToStorage() {
            try {
                localStorage.setItem('pomodoroTimerData', JSON.stringify(window.timerState));
            } catch (error) {
                console.error('[存储] 保存数据失败:', error);
                
                // 尝试使用回退存储
                if (window.fallbackStorage) {
                    window.fallbackStorage.set('pomodoroTimerData', JSON.stringify(window.timerState));
                }
            }
        }

        // 更新显示
        function updateDisplay() {
            const { timeLeft, isWorkTime, pomodoroName } = window.timerState;
            
            // 更新时间显示
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timeDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 更新模式指示器
            const modeIndicator = document.getElementById('modeIndicator');
            modeIndicator.textContent = isWorkTime ? '专注时间' : '休息时间';
            modeIndicator.className = `mode-indicator ${isWorkTime ? 'work' : 'break'}`;
            
            // 更新番茄钟名称
            document.getElementById('pomodoroName').textContent = pomodoroName;
            
            // 更新进度环
            updateProgressRing();
            
            // 更新时间设置输入
            updateTimeInputs();
        }

        // 更新进度环
        function updateProgressRing() {
            const { timeLeft, isWorkTime, workTime, breakTime } = window.timerState;
            const totalTime = isWorkTime ? workTime : breakTime;
            const progress = 1 - (timeLeft / totalTime);
            
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (progress * circumference);
            
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = offset;
            progressCircle.className = `progress-ring-circle ${isWorkTime ? 'work' : 'break'}`;
        }

        // 更新时间设置输入
        function updateTimeInputs() {
            const { workTime, breakTime, longBreakTime } = window.timerState;
            
            document.getElementById('workTimeInput').value = Math.floor(workTime / 60);
            document.getElementById('breakTimeInput').value = Math.floor(breakTime / 60);
            document.getElementById('longBreakTimeInput').value = Math.floor(longBreakTime / 60);
        }

        // 更新统计
        function updateStats() {
            const { pomodorosCompleted, focusTimeToday, tasksCompleted, completedPomodoros } = window.timerState;
            
            // 计算总工作时长
            const totalWorkTime = completedPomodoros.reduce((total, pomodoro) => {
                return total + (pomodoro.workTime || 25 * 60);
            }, 0);
            
            document.getElementById('pomodorosCompleted').textContent = pomodorosCompleted;
            document.getElementById('focusTime').textContent = formatTime(focusTimeToday);
            document.getElementById('tasksCompleted').textContent = tasksCompleted;
            document.getElementById('totalTime').textContent = formatTime(totalWorkTime);
        }

        // 格式化时间
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // 渲染任务列表
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            const { tasks } = window.timerState;
            
            taskList.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                         data-index="${index}"></div>
                    <div class="task-content">
                        <div class="task-name">${task.name}</div>
                        <div class="task-pomodoros">预计: ${task.estimatedPomodoros} 个番茄</div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn edit-task" data-index="${index}" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-btn delete-task" data-index="${index}" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskElement);
            });
            
            // 如果没有任务，显示提示
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="task-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-tasks" style="margin-right: 10px;"></i>
                        暂无任务，点击"添加"创建新任务
                    </div>
                `;
            }
        }

        // 渲染历史记录
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const { completedPomodoros } = window.timerState;
            
            historyList.innerHTML = '';
            
            // 只显示最近10条记录
            const recentHistory = completedPomodoros.slice(-10).reverse();
            
            recentHistory.forEach((pomodoro, index) => {
                const historyElement = document.createElement('div');
                historyElement.className = 'history-item';
                
                const time = new Date(pomodoro.completedAt).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                historyElement.innerHTML = `
                    <div class="history-info">
                        <div class="history-task">${pomodoro.name || '未命名番茄钟'}</div>
                        <div class="history-time">${time}</div>
                    </div>
                    <div class="history-duration">${Math.floor(pomodoro.workTime / 60)}m</div>
                `;
                
                historyList.appendChild(historyElement);
            });
            
            // 如果没有历史记录，显示提示
            if (recentHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                        暂无历史记录
                    </div>
                `;
            }
        }

        // 开始计时器
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            window.timerState.isRunning = true;
            window.timerState.isPaused = false;
            
            // 播放开始声音
            if (window.audioManager) {
                window.audioManager.playSound('start');
            }
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 运行中';
            
            // 设置定时器
            window.timerState.timerInterval = setInterval(() => {
                window.timerState.timeLeft--;
                
                if (window.timerState.timeLeft <= 0) {
                    completeTimer();
                }
                
                updateDisplay();
                
                // 每10秒自动保存一次
                if (window.timerState.timeLeft % 10 === 0) {
                    saveToStorage();
                }
            }, 1000);
            
            console.log('[计时器] 计时器已启动');
        }

        // 暂停计时器
        function pauseTimer() {
            if (!window.timerState.isRunning || window.timerState.isPaused) return;
            
            window.timerState.isPaused = true;
            clearInterval(window.timerState.timerInterval);
            
            // 播放暂停声音
            if (window.audioManager) {
                window.audioManager.playSound('pause');
            }
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 继续';
            
            console.log('[计时器] 计时器已暂停');
        }

        // 重置计时器
        function resetTimer() {
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[计时器] 计时器已重置');
        }

        // 完成计时器
        function completeTimer() {
            clearInterval(window.timerState.timerInterval);
            
            const { isWorkTime, workTime, pomodorosCompleted, focusTimeToday, completedPomodoros } = window.timerState;
            
            if (isWorkTime) {
                // 专注时间结束
                window.timerState.pomodorosCompleted++;
                window.timerState.focusTimeToday += workTime;
                
                // 添加到历史记录
                completedPomodoros.push({
                    name: window.timerState.pomodoroName,
                    workTime: workTime,
                    completedAt: new Date().toISOString(),
                    category: window.timerState.pomodoroCategory
                });
                
                // 检查是否应该进入长休息
                const shouldTakeLongBreak = window.timerState.pomodorosCompleted % 4 === 0;
                
                // 切换到休息时间
                window.timerState.isWorkTime = false;
                window.timerState.timeLeft = shouldTakeLongBreak ? 
                    window.timerState.longBreakTime : 
                    window.timerState.breakTime;
                
                // 播放完成声音
                if (window.audioManager) {
                    window.audioManager.playSound('complete');
                }
                
                // 显示通知
                const message = shouldTakeLongBreak ? 
                    '专注时间结束！现在是长休息时间。' : 
                    '专注时间结束！现在是休息时间。';
                showNotification(message, 'success');
                
                // 发送系统通知
                if (Notification.permission === 'granted') {
                    new Notification('番茄钟完成！', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff6b6b"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
                    });
                }
                
                console.log('[计时器] 专注时间完成，进入休息时间');
            } else {
                // 休息时间结束
                window.timerState.isWorkTime = true;
                window.timerState.timeLeft = window.timerState.workTime;
                
                // 播放提示声音
                if (window.audioManager) {
                    window.audioManager.playSound('alert');
                }
                
                // 显示通知
                showNotification('休息时间结束！开始下一个专注时段。', 'info');
                
                console.log('[计时器] 休息时间结束，开始专注时间');
            }
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            // 更新统计和显示
            updateDisplay();
            updateStats();
            renderHistory();
            saveToStorage();
            
            // 显示番茄钟命名模态框
            if (window.timerState.isWorkTime) {
                setTimeout(() => {
                    showPomodoroNameModal();
                }, 500);
            }
        }

        // 跳过当前时段
        function skipTimer() {
            if (window.timerState.isRunning) {
                if (!confirm('确定要跳过当前时段吗？')) {
                    return;
                }
            }
            
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isWorkTime = !window.timerState.isWorkTime;
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[计时器] 已跳过当前时段');
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} notification-icon"></i>
                <span>${message}</span>
            `;
            
            notifications.appendChild(notification);
            
            // 自动移除通知
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 获取通知图标
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': 
                default: return 'fa-info-circle';
            }
        }

        // 显示番茄钟命名模态框
        function showPomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            const nameInput = document.getElementById('pomodoroNameInput');
            const categorySelect = document.getElementById('pomodoroCategory');
            
            // 设置默认值
            nameInput.value = window.timerState.pomodoroName;
            categorySelect.value = window.timerState.pomodoroCategory;
            
            modal.classList.add('show');
            nameInput.focus();
            
            console.log('[模态框] 显示番茄钟命名模态框');
        }

        // 隐藏番茄钟命名模态框
        function hidePomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            modal.classList.remove('show');
        }

        // 初始化通知权限
        function initNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                // 可以请求权限
                console.log('[通知] 可以请求通知权限');
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 计时器控制按钮
            document.getElementById('startBtn').addEventListener('click', startTimer);
            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('resetBtn').addEventListener('click', resetTimer);
            document.getElementById('skipBtn').addEventListener('click', skipTimer);
            
            // 时间设置按钮
            document.getElementById('increaseWorkTime').addEventListener('click', () => changeWorkTime(1));
            document.getElementById('decreaseWorkTime').addEventListener('click', () => changeWorkTime(-1));
            document.getElementById('increaseBreakTime').addEventListener('click', () => changeBreakTime(1));
            document.getElementById('decreaseBreakTime').addEventListener('click', () => changeBreakTime(-1));
            document.getElementById('increaseLongBreakTime').addEventListener('click', () => changeLongBreakTime(1));
            document.getElementById('decreaseLongBreakTime').addEventListener('click', () => changeLongBreakTime(-1));
            
            // 时间输入框事件
            const timeInputs = ['workTimeInput', 'breakTimeInput', 'longBreakTimeInput'];
            timeInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('blur', function() {
                    const value = parseInt(this.value) || 1;
                    const min = 1;
                    const max = 120;
                    const validatedValue = Math.max(min, Math.min(max, value));
                    
                    this.value = validatedValue;
                    
                    if (id === 'workTimeInput') {
                        window.timerState.workTime = validatedValue * 60;
                        if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.workTime;
                        }
                    } else if (id === 'breakTimeInput') {
                        window.timerState.breakTime = validatedValue * 60;
                        if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.breakTime;
                        }
                    } else if (id === 'longBreakTimeInput') {
                        window.timerState.longBreakTime = validatedValue * 60;
                    }
                    
                    updateDisplay();
                    saveToStorage();
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });
            
            // 统计重置按钮
            document.getElementById('resetStatsBtn').addEventListener('click', function() {
                if (confirm('确定要重置所有统计信息吗？此操作不可撤销。')) {
                    window.timerState.pomodorosCompleted = 0;
                    window.timerState.focusTimeToday = 0;
                    window.timerState.tasksCompleted = 0;
                    window.timerState.completedPomodoros = [];
                    updateStats();
                    renderHistory();
                    saveToStorage();
                    showNotification('统计信息已重置', 'success');
                }
            });
            
            // 任务相关按钮
            document.getElementById('addTaskBtn').addEventListener('click', function() {
                const input = document.getElementById('newTaskInput');
                input.focus();
                input.select();
            });
            
            document.getElementById('confirmAddTask').addEventListener('click', addNewTask);
            document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewTask();
                }
            });
            
            // 历史记录清空按钮
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                if (confirm('确定要清空历史记录吗？此操作不可撤销。')) {
                    window.timerState.completedPomodoros = [];
                    renderHistory();
                    saveToStorage();
                    showNotification('历史记录已清空', 'success');
                }
            });
            
            // 模态框相关按钮
            document.getElementById('closeNameModal').addEventListener('click', hidePomodoroNameModal);
            document.getElementById('cancelNameBtn').addEventListener('click', hidePomodoroNameModal);
            document.getElementById('saveNameBtn').addEventListener('click', function() {
                const name = document.getElementById('pomodoroNameInput').value.trim();
                const category = document.getElementById('pomodoroCategory').value;
                
                if (name) {
                    window.timerState.pomodoroName = name;
                    window.timerState.pomodoroCategory = category;
                    document.getElementById('pomodoroName').textContent = name;
                    hidePomodoroNameModal();
                    saveToStorage();
                    showNotification('番茄钟名称已更新', 'success');
                } else {
                    showNotification('请输入番茄钟名称', 'error');
                }
            });
            
            // 设置按钮
            document.getElementById('settingsBtn').addEventListener('click', function() {
                // TODO: 实现设置功能
                showNotification('设置功能开发中...', 'info');
            });
            
            // 全屏按钮
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // 主题切换按钮
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // 点击任务列表（事件委托）
            document.getElementById('taskList').addEventListener('click', function(e) {
                const target = e.target;
                const taskItem = target.closest('.task-item');
                
                if (!taskItem) return;
                
                const index = parseInt(taskItem.querySelector('.task-checkbox').dataset.index);
                
                if (target.classList.contains('task-checkbox')) {
                    toggleTaskCompletion(index);
                } else if (target.closest('.edit-task')) {
                    editTask(index);
                } else if (target.closest('.delete-task')) {
                    deleteTask(index);
                }
            });
            
            // 点击模态框外部关闭
            document.getElementById('pomodoroNameModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePomodoroNameModal();
                }
            });
            
            // 按键事件
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case ' ':
                    case 'Spacebar':
                        e.preventDefault();
                        if (window.timerState.isRunning) {
                            pauseTimer();
                        } else {
                            startTimer();
                        }
                        break;
                    case 'Escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                        hidePomodoroNameModal();
                        break;
                    case 'r':
                    case 'R':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            resetTimer();
                        }
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            skipTimer();
                        }
                        break;
                }
            });
            
            // 页面可见性变化
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[系统] 页面进入后台');
                } else {
                    console.log('[系统] 页面返回前台');
                }
            });
            
            // 页面卸载前保存
            window.addEventListener('beforeunload', function() {
                saveToStorage();
                console.log('[系统] 页面卸载，数据已保存');
            });
        }

        // 修改专注时间
        function changeWorkTime(delta) {
            const newTime = Math.max(1, Math.min(120, Math.floor(window.timerState.workTime / 60) + delta));
            window.timerState.workTime = newTime * 60;
            
            if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.workTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // 修改休息时间
        function changeBreakTime(delta) {
            const newTime = Math.max(1, Math.min(60, Math.floor(window.timerState.breakTime / 60) + delta));
            window.timerState.breakTime = newTime * 60;
            
            if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.breakTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // 修改长休息时间
        function changeLongBreakTime(delta) {
            const newTime = Math.max(5, Math.min(60, Math.floor(window.timerState.longBreakTime / 60) + delta));
            window.timerState.longBreakTime = newTime * 60;
            updateDisplay();
            saveToStorage();
        }

        // 添加新任务
        function addNewTask() {
            const input = document.getElementById('newTaskInput');
            const name = input.value.trim();
            
            if (!name) {
                showNotification('请输入任务名称', 'error');
                input.focus();
                return;
            }
            
            const task = {
                id: Date.now(),
                name: name,
                completed: false,
                createdAt: new Date().toISOString(),
                estimatedPomodoros: 1
            };
            
            window.timerState.tasks.push(task);
            input.value = '';
            renderTaskList();
            saveToStorage();
            
            showNotification('任务已添加', 'success');
        }

        // 切换任务完成状态
        function toggleTaskCompletion(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                window.timerState.tasks[index].completed = !window.timerState.tasks[index].completed;
                
                if (window.timerState.tasks[index].completed) {
                    window.timerState.tasksCompleted++;
                } else {
                    window.timerState.tasksCompleted--;
                }
                
                renderTaskList();
                updateStats();
                saveToStorage();
                
                const message = window.timerState.tasks[index].completed ? 
                    '任务已完成！' : '任务已取消完成';
                showNotification(message, 'success');
            }
        }

        // 编辑任务
        function editTask(index) {
            const task = window.timerState.tasks[index];
            const newName = prompt('编辑任务名称:', task.name);
            
            if (newName && newName.trim()) {
                task.name = newName.trim();
                renderTaskList();
                saveToStorage();
                showNotification('任务已更新', 'success');
            }
        }

        // 删除任务
        function deleteTask(index) {
            if (confirm('确定要删除这个任务吗？')) {
                const task = window.timerState.tasks[index];
                
                if (task.completed) {
                    window.timerState.tasksCompleted--;
                }
                
                window.timerState.tasks.splice(index, 1);
                renderTaskList();
                updateStats();
                saveToStorage();
                showNotification('任务已删除', 'success');
            }
        }

        // 切换全屏
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('全屏请求失败:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // 切换主题
        function toggleTheme() {
            const isDark = document.body.classList.toggle('light-theme');
            const icon = document.querySelector('#themeToggle i');
            
            if (isDark) {
                icon.className = 'fas fa-sun';
                document.documentElement.style.setProperty('--dark-bg', '#f5f6fa');
                document.documentElement.style.setProperty('--darker-bg', '#dcdde1');
                document.documentElement.style.setProperty('--light-text', '#2f3640');
                document.documentElement.style.setProperty('--medium-text', '#353b48');
                document.documentElement.style.setProperty('--dark-text', '#192a56');
            } else {
                icon.className = 'fas fa-moon';
                document.documentElement.style.setProperty('--dark-bg', '#2c3e50');
                document.documentElement.style.setProperty('--darker-bg', '#1e272e');
                document.documentElement.style.setProperty('--light-text', '#f5f6fa');
                document.documentElement.style.setProperty('--medium-text', '#dcdde1');
                document.documentElement.style.setProperty('--dark-text', '#2f3640');
            }
        }

        // 初始化完成
        console.log('[系统] 番茄钟计时器已准备就绪');
        showNotification('番茄钟计时器已启动！按空格键开始/暂停。', 'info');
    </script>
</body>
</html>
// 页面加载完成后的初始化检查
        window.addEventListener('load', function() {
            // 检查是否是第一次访问
            const isFirstVisit = !localStorage.getItem('pomodoroTimerFirstVisit');
            
            if (isFirstVisit) {
                setTimeout(() => {
                    showNotification('欢迎使用番茄钟计时器！按空格键可以快速开始/暂停计时。', 'info');
                    localStorage.setItem('pomodoroTimerFirstVisit', 'true');
                }, 2000);
            }
            
            // 检查服务工作者支持
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[系统] Service Worker 注册成功，作用域：', registration.scope);
                    })
                    .catch(error => {
                        console.log('[系统] Service Worker 注册失败：', error);
                    });
            }
            
            // 检查离线状态
            window.addEventListener('online', function() {
                showNotification('已恢复网络连接', 'success');
            });
            
            window.addEventListener('offline', function() {
                showNotification('网络连接已断开，但计时器可继续本地工作', 'warning');
            });
            
            // 检查浏览器兼容性警告
            if (!('indexedDB' in window)) {
                console.warn('[系统] IndexedDB 不支持，某些功能可能受限');
            }
            
            if (!('serviceWorker' in navigator)) {
                console.warn('[系统] Service Worker 不支持，无法离线使用');
            }
        });

        // 添加键盘快捷键提示
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: '空格键', action: '开始/暂停计时' },
                { key: 'R', action: '重置计时' },
                { key: 'S', action: '跳过当前时段' },
                { key: 'ESC', action: '退出全屏/关闭模态框' },
                { key: 'F11 或 全屏按钮', action: '切换全屏模式' }
            ];
            
            let message = '键盘快捷键：\n';
            shortcuts.forEach(shortcut => {
                message += `${shortcut.key}: ${shortcut.action}\n`;
            });
            
            alert(message);
        }

        // 添加快捷键帮助菜单
        document.addEventListener('keydown', function(e) {
            // Ctrl + / 显示快捷键帮助
            if (e.key === '?' && e.ctrlKey) {
                e.preventDefault();
                showKeyboardShortcuts();
            }
            
            // Ctrl + S 保存当前状态
            if (e.key === 's' && e.ctrlKey && !e.altKey) {
                e.preventDefault();
                saveToStorage();
                showNotification('数据已保存', 'success');
            }
        });

        // 添加触摸事件支持
        let touchStartY = 0;
        let touchStartX = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndX = e.changedTouches[0].clientX;
            
            const deltaY = touchStartY - touchEndY;
            const deltaX = touchStartX - touchEndX;
            
            // 垂直滑动调整时间
            if (Math.abs(deltaY) > 50 && Math.abs(deltaX) < 30) {
                const timeInputs = document.querySelectorAll('.time-input input');
                const activeElement = document.activeElement;
                
                if (timeInputs.contains(activeElement)) {
                    e.preventDefault();
                    
                    if (deltaY > 0) {
                        // 向上滑动增加
                        if (activeElement.id === 'workTimeInput') changeWorkTime(1);
                        else if (activeElement.id === 'breakTimeInput') changeBreakTime(1);
                        else if (activeElement.id === 'longBreakTimeInput') changeLongBreakTime(1);
                    } else {
                        // 向下滑动减少
                        if (activeElement.id === 'workTimeInput') changeWorkTime(-1);
                        else if (activeElement.id === 'breakTimeInput') changeBreakTime(-1);
                        else if (activeElement.id === 'longBreakTimeInput') changeLongBreakTime(-1);
                    }
                }
            }
        }, { passive: false });

        // 添加振动反馈（如果支持）
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // 修改播放声音函数以包含振动反馈
        async function playSoundWithVibration(type) {
            if (window.audioManager) {
                window.audioManager.playSound(type);
            }
            
            // 根据声音类型添加振动反馈
            const vibrationPatterns = {
                start: [100, 30, 100],
                pause: [50, 20, 50],
                complete: [200, 50, 100, 50, 200],
                alert: [100],
                notification: [50]
            };
            
            if (vibrationPatterns[type]) {
                vibrate(vibrationPatterns[type]);
            }
        }

        // 更新计时器控制函数以使用新的声音函数
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            window.timerState.isRunning = true;
            window.timerState.isPaused = false;
            
            // 播放开始声音和振动
            playSoundWithVibration('start');
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 运行中';
            
            // 设置定时器
            window.timerState.timerInterval = setInterval(() => {
                window.timerState.timeLeft--;
                
                if (window.timerState.timeLeft <= 0) {
                    completeTimer();
                }
                
                updateDisplay();
                
                // 每10秒自动保存一次
                if (window.timerState.timeLeft % 10 === 0) {
                    saveToStorage();
                }
                
                // 倒计时最后一分钟时添加视觉提示
                if (window.timerState.timeLeft === 60) {
                    document.getElementById('timeDisplay').classList.add('pulse');
                }
                
                // 倒计时最后10秒时添加视觉提示
                if (window.timerState.timeLeft === 10) {
                    document.getElementById('timeDisplay').classList.add('shake');
                }
            }, 1000);
            
            console.log('[计时器] 计时器已启动');
        }

        // 添加页面可见性变化的计时器同步
        let hiddenTime = 0;
        let lastUpdateTime = Date.now();
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面进入后台
                hiddenTime = Date.now();
                console.log('[系统] 页面进入后台');
            } else {
                // 页面返回前台
                if (window.timerState.isRunning && !window.timerState.isPaused) {
                    const timeInBackground = Date.now() - hiddenTime;
                    const secondsInBackground = Math.floor(timeInBackground / 1000);
                    
                    if (secondsInBackground > 0) {
                        window.timerState.timeLeft = Math.max(0, window.timerState.timeLeft - secondsInBackground);
                        
                        if (window.timerState.timeLeft <= 0) {
                            completeTimer();
                        } else {
                            updateDisplay();
                        }
                        
                        console.log(`[系统] 后台运行时间: ${secondsInBackground}秒，已同步计时器`);
                    }
                }
                console.log('[系统] 页面返回前台');
            }
        });

        // 添加屏幕常亮功能
        let wakeLock = null;
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('[系统] 屏幕常亮已启用');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('[系统] 屏幕常亮已释放');
                    });
                } catch (err) {
                    console.error('[系统] 屏幕常亮请求失败:', err);
                }
            }
        }
        
        async function releaseWakeLock() {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
            }
        }
        
        // 在计时器启动时请求屏幕常亮
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            // 请求屏幕常亮
            requestWakeLock();
            
            // 原有代码...
        }
        
        // 在计时器暂停或完成时释放屏幕常亮
        function pauseTimer() {
            if (!window.timerState.isRunning || window.timerState.isPaused) return;
            
            // 释放屏幕常亮
            releaseWakeLock();
            
            // 原有代码...
        }
        
        function completeTimer() {
            // 释放屏幕常亮
            releaseWakeLock();
            
            // 原有代码...
        }
        
        function resetTimer() {
            // 释放屏幕常亮
            releaseWakeLock();
            
            // 原有代码...
        }
        
        function skipTimer() {
            // 释放屏幕常亮
            releaseWakeLock();
            
            // 原有代码...
        }

        // 添加数据导出功能
        function exportData() {
            const data = {
                timerState: window.timerState,
                exportDate: new Date().toISOString(),
                version: '6.3.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `pomodoro-timer-backup-${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('数据已导出为JSON文件', 'success');
        }

        // 添加数据导入功能
        function importData(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (importedData.timerState && importedData.version) {
                        if (confirm('确定要导入备份数据吗？当前数据将被覆盖。')) {
                            window.timerState = importedData.timerState;
                            updateDisplay();
                            updateStats();
                            renderTaskList();
                            renderHistory();
                            saveToStorage();
                            showNotification('数据导入成功', 'success');
                        }
                    } else {
                        showNotification('导入的文件格式不正确', 'error');
                    }
                } catch (error) {
                    showNotification('导入失败：文件格式错误', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // 添加快捷键触发数据导出/导入
        document.addEventListener('keydown', function(e) {
            // Ctrl + E 导出数据
            if (e.key === 'e' && e.ctrlKey && !e.altKey) {
                e.preventDefault();
                exportData();
            }
            
            // Ctrl + I 触发数据导入
            if (e.key === 'i' && e.ctrlKey && !e.altKey) {
                e.preventDefault();
                document.getElementById('importFileInput').click();
            }
        });

        // 添加上传文件输入
        const importInput = document.createElement('input');
        importInput.type = 'file';
        importInput.id = 'importFileInput';
        importInput.accept = '.json';
        importInput.style.display = 'none';
        importInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                importData(this.files[0]);
                this.value = '';
            }
        });
        document.body.appendChild(importInput);

        // 添加主题系统
        const themes = {
            dark: {
                '--dark-bg': '#2c3e50',
                '--darker-bg': '#1e272e',
                '--light-text': '#f5f6fa',
                '--medium-text': '#dcdde1',
                '--dark-text': '#2f3640',
                '--primary-color': '#ff6b6b',
                '--primary-dark': '#ff4757',
                '--secondary-color': '#1e90ff',
                '--secondary-dark': '#3742fa',
                '--break-color': '#2ed573',
                '--break-dark': '#1dd1a1',
                '--shadow': '0 10px 20px rgba(0, 0, 0, 0.2)'
            },
            light: {
                '--dark-bg': '#f5f6fa',
                '--darker-bg': '#dcdde1',
                '--light-text': '#2f3640',
                '--medium-text': '#353b48',
                '--dark-text': '#192a56',
                '--primary-color': '#ff6b6b',
                '--primary-dark': '#ff4757',
                '--secondary-color': '#1e90ff',
                '--secondary-dark': '#3742fa',
                '--break-color': '#2ed573',
                '--break-dark': '#1dd1a1',
                '--shadow': '0 10px 20px rgba(0, 0, 0, 0.1)'
            },
            blue: {
                '--dark-bg': '#1a237e',
                '--darker-bg': '#0d1452',
                '--light-text': '#e8eaf6',
                '--medium-text': '#c5cae9',
                '--dark-text': '#283593',
                '--primary-color': '#5c6bc0',
                '--primary-dark': '#3949ab',
                '--secondary-color': '#29b6f6',
                '--secondary-dark': '#0288d1',
                '--break-color': '#66bb6a',
                '--break-dark': '#388e3c',
                '--shadow': '0 10px 20px rgba(0, 0, 0, 0.3)'
            },
            green: {
                '--dark-bg': '#1b5e20',
                '--darker-bg': '#0d3c0f',
                '--light-text': '#e8f5e9',
                '--medium-text': '#c8e6c9',
                '--dark-text': '#2e7d32',
                '--primary-color': '#4caf50',
                '--primary-dark': '#388e3c',
                '--secondary-color': '#00bcd4',
                '--secondary-dark': '#0097a7',
                '--break-color': '#ff9800',
                '--break-dark': '#f57c00',
                '--shadow': '0 10px 20px rgba(0, 0, 0, 0.3)'
            }
        };

        let currentTheme = 'dark';

        function setTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            currentTheme = themeName;
            
            Object.entries(theme).forEach(([property, value]) => {
                document.documentElement.style.setProperty(property, value);
            });
            
            // 更新主题图标
            const themeIcons = {
                dark: 'moon',
                light: 'sun',
                blue: 'tint',
                green: 'leaf'
            };
            
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = `fas fa-${themeIcons[themeName]}`;
            }
            
            // 保存主题设置
            localStorage.setItem('pomodoroTimerTheme', themeName);
        }

        // 修改主题切换功能
        document.getElementById('themeToggle').addEventListener('click', function() {
            const themeOrder = ['dark', 'light', 'blue', 'green'];
            const currentIndex = themeOrder.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themeOrder.length;
            setTheme(themeOrder[nextIndex]);
        });

        // 页面加载时应用保存的主题
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('pomodoroTimerTheme');
            if (savedTheme && themes[savedTheme]) {
                setTheme(savedTheme);
            }
        });

        // 添加性能优化
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 1000; // 1秒更新一次
        
        function optimizedUpdate() {
            const now = Date.now();
            if (now - lastUpdateTime >= UPDATE_INTERVAL) {
                updateDisplay();
                lastUpdateTime = now;
            }
        }

        // 修改定时器循环
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            window.timerState.isRunning = true;
            window.timerState.isPaused = false;
            
            // 播放开始声音和振动
            playSoundWithVibration('start');
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 运行中';
            
            // 使用requestAnimationFrame优化
            let lastTime = performance.now();
            
            function timerLoop(currentTime) {
                if (!window.timerState.isRunning || window.timerState.isPaused) return;
                
                const delta = currentTime - lastTime;
                
                if (delta >= 1000) {
                    window.timerState.timeLeft--;
                    lastTime = currentTime - (delta % 1000);
                    
                    if (window.timerState.timeLeft <= 0) {
                        completeTimer();
                        return;
                    }
                    
                    optimizedUpdate();
                    
                    // 每10秒自动保存一次
                    if (window.timerState.timeLeft % 10 === 0) {
                        saveToStorage();
                    }
                }
                
                if (window.timerState.isRunning && !window.timerState.isPaused) {
                    requestAnimationFrame(timerLoop);
                }
            }
            
            requestAnimationFrame(timerLoop);
            console.log('[计时器] 计时器已启动');
        }

        // 添加错误边界处理
        window.addEventListener('error', function(event) {
            console.error('[错误] 未捕获的错误:', event.error);
            showNotification('应用程序发生错误，请刷新页面重试', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('[错误] 未处理的Promise拒绝:', event.reason);
            showNotification('应用程序发生错误，请刷新页面重试', 'error');
        });

        // 添加离线检测
        function checkConnection() {
            if (!navigator.onLine) {
                showNotification('您当前处于离线状态，但应用程序仍可正常使用', 'warning');
            }
        }

        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);

        // 页面加载时检查
        window.addEventListener('load', checkConnection);

        // 添加快捷键帮助菜单到设置按钮
        document.getElementById('settingsBtn').addEventListener('click', function() {
            const shortcuts = [
                { key: '空格键', action: '开始/暂停计时' },
                { key: 'R', action: '重置计时' },
                { key: 'S', action: '跳过当前时段' },
                { key: 'ESC', action: '退出全屏/关闭模态框' },
                { key: 'F11', action: '切换全屏模式' },
                { key: 'Ctrl+S', action: '保存数据' },
                { key: 'Ctrl+E', action: '导出数据' },
                { key: 'Ctrl+I', action: '导入数据' },
                { key: 'Ctrl+?', action: '显示此帮助' }
            ];
            
            let message = '<strong>键盘快捷键：</strong><br><br>';
            shortcuts.forEach(shortcut => {
                message += `<strong>${shortcut.key}:</strong> ${shortcut.action}<br>`;
            });
            
            showNotification(message, 'info', 5000);
        });

        // 修改通知函数以支持HTML和更长时间
        function showNotification(message, type = 'info', duration = 3000) {
            const notifications = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} notification-icon"></i>
                <span>${message}</span>
            `;
            
            notifications.appendChild(notification);
            
            // 自动移除通知
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duration);
        }

        // 添加PWA安装提示
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // 显示安装提示
            setTimeout(() => {
                showNotification('想将番茄钟添加到主屏幕吗？点击这里安装应用。', 'info', 10000);
                
                const installNotification = document.querySelector('.notification:last-child');
                if (installNotification) {
                    installNotification.style.cursor = 'pointer';
                    installNotification.addEventListener('click', async () => {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            showNotification('应用已成功安装！', 'success');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 10000);
        });

        // 添加分享功能
        function shareProgress() {
            const { pomodorosCompleted, focusTimeToday } = window.timerState;
            const hours = Math.floor(focusTimeToday / 3600);
            const minutes = Math.floor((focusTimeToday % 3600) / 60);
            
            const text = `我今天使用番茄钟完成了 ${pomodorosCompleted} 个番茄，专注了 ${hours > 0 ? `${hours}小时` : ''}${minutes}分钟！`;
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: '番茄钟进度',
                    text: text,
                    url: url
                }).then(() => {
                    showNotification('分享成功！', 'success');
                }).catch(error => {
                    console.log('分享失败:', error);
                });
            } else {
                // 回退方案
                navigator.clipboard.writeText(`${text} ${url}`).then(() => {
                    showNotification('分享文本已复制到剪贴板！', 'success');
                }).catch(err => {
                    const shareUrl = `${text} ${url}`;
                    prompt('复制以下链接分享：', shareUrl);
                });
            }
        }

        // 添加快捷键分享
        document.addEventListener('keydown', function(e) {
            // Ctrl + P 分享进度
            if (e.key === 'p' && e.ctrlKey && !e.altKey) {
                e.preventDefault();
                shareProgress();
            }
        });

        // 添加数据备份提醒
        function setupBackupReminder() {
            const lastBackup = localStorage.getItem('pomodoroTimerLastBackup');
            const now = Date.now();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            
            if (!lastBackup || (now - parseInt(lastBackup) > oneWeek)) {
                setTimeout(() => {
                    if (confirm('已经一周没有备份数据了，是否要导出备份？')) {
                        exportData();
                        localStorage.setItem('pomodoroTimerLastBackup', now.toString());
                    }
                }, 5000);
            }
        }

        // 页面加载时设置备份提醒
        window.addEventListener('load', function() {
            setTimeout(setupBackupReminder, 30000); // 30秒后检查
        });

        // 添加自动保存功能
        const AUTOSAVE_INTERVAL = 30000; // 30秒
        
        setInterval(() => {
            if (window.timerState.isRunning) {
                saveToStorage();
                console.log('[系统] 自动保存完成');
            }
        }, AUTOSAVE_INTERVAL);

        // 添加触摸长按支持
        let longPressTimer;
        const LONG_PRESS_DURATION = 1000; // 1秒
        
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('time-input')) {
                longPressTimer = setTimeout(() => {
                    e.target.style.transform = 'scale(0.95)';
                    vibrate([50]);
                    
                    // 显示快速调整菜单
                    const rect = e.target.getBoundingClientRect();
                    showQuickAdjustMenu(e.target.id, rect.left, rect.top);
                }, LONG_PRESS_DURATION);
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
            if (e.target.classList.contains('time-input')) {
                e.target.style.transform = '';
            }
        });
        
        document.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
        }, { passive: true });

        function showQuickAdjustMenu(inputId, x, y) {
            const menu = document.createElement('div');
            menu.className = 'quick-adjust-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y - 100}px;
                background: var(--dark-bg);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 10px;
                box-shadow: var(--shadow);
                z-index: 10000;
                display: flex;
                gap: 5px;
            `;
            
            const increments = [1, 5, 10, 15, 30];
            
            increments.forEach(inc => {
                const btn = document.createElement('button');
                btn.textContent = `+${inc}`;
                btn.style.cssText = `
                    padding: 8px 12px;
                    background: var(--primary-color);
                    border: none;
                    border-radius: 5px;
                    color: white;
                    cursor: pointer;
                `;
                btn.addEventListener('click', () => {
                    if (inputId.includes('Work')) changeWorkTime(inc);
                    else if (inputId.includes('Break')) changeBreakTime(inc);
                    else if (inputId.includes('Long')) changeLongBreakTime(inc);
                    menu.remove();
                });
                menu.appendChild(btn);
            });
            
            document.body.appendChild(menu);
            
            // 点击其他地方关闭菜单
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }

        // 添加最终初始化检查
        window.addEventListener('load', function() {
            // 检查所有功能是否正常
            const checks = {
                audio: !!window.audioManager,
                storage: typeof Storage !== 'undefined',
                notifications: 'Notification' in window,
                serviceWorker: 'serviceWorker' in navigator,
                vibration: 'vibrate' in navigator,
                share: 'share' in navigator,
                wakeLock: 'wakeLock' in navigator
            };
            
            console.log('[系统] 功能检查:', checks);
            
            // 请求通知权限
            if (checks.notifications && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 1000);
            }
        });

        // 添加最终清理
        window.addEventListener('beforeunload', function() {
            // 清理定时器
            if (window.timerState.timerInterval) {
                clearInterval(window.timerState.timerInterval);
            }
            
            // 释放屏幕常亮
            if (wakeLock) {
                wakeLock.release();
            }
            
            // 保存数据
            saveToStorage();
            
            console.log('[系统] 应用程序正在关闭，已清理资源');
        });

        // 添加最终状态日志
        console.log('[系统] 应用程序初始化完成，所有功能已就绪');
        console.log('[系统] 番茄钟计时器 v6.3.0');
        console.log('[系统] 功能：音频提示、本地存储、离线支持、PWA安装、主题切换、数据导入导出');
    </script>
</body>
</html>
