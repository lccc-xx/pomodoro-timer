<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟计时器 - 高效率的时间管理工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --primary-dark: #ff4757;
            --secondary-color: #1e90ff;
            --secondary-dark: #3742fa;
            --break-color: #2ed573;
            --break-dark: #1dd1a1;
            --dark-bg: #2c3e50;
            --darker-bg: #1e272e;
            --light-text: #f5f6fa;
            --medium-text: #dcdde1;
            --dark-text: #2f3640;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            --card-bg: rgba(255, 255, 255, 0.05);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
            color: var(--light-text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--medium-text);
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .timer-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .timer-display {
            margin-bottom: 40px;
        }

        .pomodoro-name {
            font-size: 1.2rem;
            color: var(--medium-text);
            margin-bottom: 20px;
        }

        .timer-circle {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-background {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-circle.work {
            stroke: var(--primary-color);
        }

        .progress-ring-circle.break {
            stroke: var(--break-color);
        }

        .time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: var(--light-text);
        }

        .mode-indicator {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .mode-indicator.work {
            background: rgba(255, 107, 107, 0.2);
            color: var(--primary-color);
        }

        .mode-indicator.break {
            background: rgba(46, 213, 115, 0.2);
            color: var(--break-color);
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--break-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: var(--break-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ff3838;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #ff2e2e;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .time-settings {
            margin-top: 40px;
        }

        .time-settings h3 {
            margin-bottom: 20px;
            color: var(--medium-text);
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .time-input-group label {
            width: 120px;
            text-align: right;
            color: var(--medium-text);
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .time-input input {
            width: 100px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: var(--light-text);
            text-align: center;
            font-size: 1.1rem;
        }

        .time-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .time-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-card, .tasks-card, .history-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--light-text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--medium-text);
            font-size: 0.9rem;
        }

        .task-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--medium-text);
            border-radius: 4px;
            margin-right: 12px;
            cursor: pointer;
            position: relative;
        }

        .task-checkbox.checked {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .task-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .task-pomodoros {
            font-size: 0.85rem;
            color: var(--medium-text);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .task-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .add-task {
            display: flex;
            gap: 10px;
        }

        .add-task input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--light-text);
        }

        .add-task input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .history-task {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--medium-text);
        }

        .history-duration {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background: var(--darker-bg);
            border-left: 4px solid var(--primary-color);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-color: var(--break-color);
        }

        .notification.error {
            border-color: #ff3838;
        }

        .notification.warning {
            border-color: #ff9f1a;
        }

        .notification-icon {
            margin-right: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--dark-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--light-text);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--medium-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--medium-text);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--light-text);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .settings-btn, .fullscreen-btn, .theme-toggle {
            position: fixed;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
            z-index: 100;
        }

        .settings-btn {
            bottom: 20px;
            right: 20px;
        }

        .fullscreen-btn {
            bottom: 80px;
            right: 20px;
        }

        .theme-toggle {
            bottom: 140px;
            right: 20px;
        }

        .settings-btn:hover, .fullscreen-btn:hover, .theme-toggle:hover {
            transform: scale(1.1);
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 音频激活提示 */
        .audio-activation-notice {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-dark);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 3000;
        }

        .audio-activation-notice.show {
            display: flex;
            animation: fadeInDown 0.5s ease;
        }

        .audio-activation-notice i {
            font-size: 1.2rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .timer-circle {
                width: 250px;
                height: 250px;
            }
            
            .time-display {
                font-size: 3rem;
            }
            
            .timer-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .timer-card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .time-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .time-input-group label {
                width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <!-- 音频激活提示 -->
    <div class="audio-activation-notice" id="audio-activation-notice">
        <i class="fas fa-volume-up"></i>
        <span>点击任意位置激活音频</span>
    </div>

    <div class="container">
        <!-- 页头 -->
        <header class="header">
            <h1><i class="fas fa-clock"></i> 番茄钟计时器</h1>
            <p>专注工作，高效休息 - 科学的时间管理方法</p>
        </header>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 主计时器卡片 -->
            <div class="timer-card">
                <div class="timer-display">
                    <div class="pomodoro-name" id="pomodoroName">专注工作</div>
                    <div class="mode-indicator work" id="modeIndicator">专注时间</div>
                    
                    <div class="timer-circle">
                        <svg class="progress-ring" width="300" height="300">
                            <circle class="progress-ring-background" cx="150" cy="150" r="145"></circle>
                            <circle class="progress-ring-circle work" id="progressCircle" cx="150" cy="150" r="145" stroke-dasharray="911.06" stroke-dashoffset="0"></circle>
                        </svg>
                        <div class="time-display" id="timeDisplay">25:00</div>
                    </div>
                </div>

                <!-- 计时器控制按钮 -->
                <div class="timer-controls">
                    <button id="startBtn" class="btn btn-primary">
                        <i class="fas fa-play"></i> 开始
                    </button>
                    <button id="pauseBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button id="resetBtn" class="btn btn-danger">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                    <button id="skipBtn" class="btn btn-success">
                        <i class="fas fa-forward"></i> 跳过
                    </button>
                </div>

                <!-- 时间设置 -->
                <div class="time-settings">
                    <h3><i class="fas fa-cog"></i> 时间设置（分钟）</h3>
                    <div class="time-input-group">
                        <label>专注时间:</label>
                        <div class="time-input">
                            <button class="time-btn" id="decreaseWorkTime">-</button>
                            <input type="number" id="workTimeInput" min="1" max="120" value="25">
                            <button class="time-btn" id="increaseWorkTime">+</button>
                        </div>
                    </div>
                    <div class="time-input-group">
                        <label>休息时间:</label>
                        <div class="time-input">
                            <button class="time-btn" id="decreaseBreakTime">-</button>
                            <input type="number" id="breakTimeInput" min="1" max="60" value="5">
                            <button class="time-btn" id="increaseBreakTime">+</button>
                        </div>
                    </div>
                    <div class="time-input-group">
                        <label>长休息时间:</label>
                        <div class="time-input">
                            <button class="time-btn" id="decreaseLongBreakTime">-</button>
                            <input type="number" id="longBreakTimeInput" min="5" max="60" value="15">
                            <button class="time-btn" id="increaseLongBreakTime">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <aside class="sidebar">
                <!-- 统计卡片 -->
                <div class="stats-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> 今日统计</h2>
                        <button id="resetStatsBtn" class="btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-redo"></i> 重置
                        </button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="pomodorosCompleted">0</div>
                            <div class="stat-label">完成的番茄</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="focusTime">0h 0m</div>
                            <div class="stat-label">专注时长</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tasksCompleted">0</div>
                            <div class="stat-label">完成的任务</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalTime">0h 0m</div>
                            <div class="stat-label">总工作时长</div>
                        </div>
                    </div>
                </div>

                <!-- 任务卡片 -->
                <div class="tasks-card">
                    <div class="card-header">
                        <h2 class="card-title">任务列表</h2>
                        <button id="addTaskBtn" class="btn-primary" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                    <div class="task-list" id="taskList">
                        <!-- 任务项会动态添加 -->
                    </div>
                    <div class="add-task">
                        <input type="text" id="newTaskInput" placeholder="输入新任务...">
                        <button id="confirmAddTask" class="btn-success" style="padding: 12px 20px;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>

                <!-- 历史记录卡片 -->
                <div class="history-card">
                    <div class="card-header">
                        <h2 class="card-title">历史记录</h2>
                        <button id="clearHistoryBtn" class="btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- 历史记录会动态添加 -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- 通知区域 -->
    <div class="notifications" id="notifications"></div>

    <!-- 番茄钟命名模态框 -->
    <div id="pomodoroNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">命名番茄钟</h2>
                <button class="modal-close" id="closeNameModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="pomodoroNameInput">番茄钟名称</label>
                <input type="text" id="pomodoroNameInput" placeholder="请输入番茄钟名称..." maxlength="50">
            </div>
            <div class="form-group">
                <label for="pomodoroCategory">分类</label>
                <select id="pomodoroCategory">
                    <option value="work">工作</option>
                    <option value="study">学习</option>
                    <option value="reading">阅读</option>
                    <option value="project">项目</option>
                    <option value="exercise">运动</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="form-actions">
                <button id="cancelNameBtn" class="btn btn-secondary">取消</button>
                <button id="saveNameBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 设置按钮 -->
    <button class="settings-btn" id="settingsBtn" title="设置">
        <i class="fas fa-cog"></i>
    </button>

    <!-- 全屏按钮 -->
    <button class="fullscreen-btn" id="fullscreenBtn" title="全屏">
        <i class="fas fa-expand"></i>
    </button>

    <!-- 主题切换按钮 -->
    <button class="theme-toggle" id="themeToggle" title="切换主题">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        // 修复AudioContext问题的解决方案
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[系统] 番茄钟计时器初始化中...');
            console.log('[系统] 版本: 6.3.1 | 修复了AudioContext问题');
            
            // 显示音频激活提示
            const audioNotice = document.getElementById('audio-activation-notice');
            audioNotice.classList.add('show');
            
            // 设置用户交互监听器
            setupAudioUnlock();
            
            // 初始化存储
            initStorage();
            
            // 检查设备兼容性
            checkCompatibility();
            
            // 初始化应用
            initApp();
        });

        // 修复音频解锁机制
        function setupAudioUnlock() {
            console.log('[音频] 设置音频解锁...');
            
            // 创建音频上下文
            let audioContext = null;
            let audioInitialized = false;
            
            // 用户交互事件列表
            const userInteractionEvents = [
                'click',
                'touchstart',
                'keydown',
                'pointerdown',
                'mousedown',
                'dragstart'
            ];
            
            // 音频解锁函数
            const unlockAudio = () => {
                if (audioInitialized) return;
                
                console.log('[音频] 检测到用户交互，开始初始化音频系统...');
                
                try {
                    // 创建音频上下文
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();
                    
                    // 创建全局音频管理器
                    window.audioManager = {
                        audioContext: audioContext,
                        unlocked: false,
                        
                        // 播放声音
                        playSound: function(type) {
                            if (!this.audioContext || this.audioContext.state === 'suspended') {
                                this.audioContext.resume().then(() => {
                                    this.unlocked = true;
                                    console.log('[音频] 音频上下文已恢复');
                                    this._playSoundNow(type);
                                }).catch(error => {
                                    console.error('[音频] 音频恢复失败:', error);
                                });
                            } else {
                                this._playSoundNow(type);
                            }
                        },
                        
                        // 实际播放声音
                        _playSoundNow: function(type) {
                            try {
                                if (this.audioContext.state !== 'running') {
                                    console.warn('[音频] 音频上下文未运行，跳过播放');
                                    return;
                                }
                                
                                const oscillator = this.audioContext.createOscillator();
                                const gainNode = this.audioContext.createGain();
                                
                                const soundConfigs = {
                                    start: { frequency: 800, duration: 0.5 },
                                    pause: { frequency: 600, duration: 0.3 },
                                    complete: { frequency: 1000, duration: 1 },
                                    alert: { frequency: 1200, duration: 0.2 },
                                    notification: { frequency: 900, duration: 0.1 }
                                };
                                
                                const config = soundConfigs[type] || soundConfigs.start;
                                
                                oscillator.type = 'sine';
                                oscillator.frequency.value = config.frequency;
                                
                                gainNode.gain.value = 0.1;
                                gainNode.gain.exponentialRampToValueAtTime(
                                    0.01, 
                                    this.audioContext.currentTime + config.duration
                                );
                                
                                oscillator.connect(gainNode);
                                gainNode.connect(this.audioContext.destination);
                                
                                oscillator.start(this.audioContext.currentTime);
                                oscillator.stop(this.audioContext.currentTime + config.duration);
                                
                                console.log(`[音频] 播放声音: ${type}`);
                            } catch (error) {
                                console.error('[音频] 播放声音失败:', error);
                            }
                        },
                        
                        // 解锁音频
                        unlock: function() {
                            if (this.audioContext) {
                                this.audioContext.resume().then(() => {
                                    this.unlocked = true;
                                    console.log('[音频] 音频已解锁');
                                }).catch(error => {
                                    console.error('[音频] 音频解锁失败:', error);
                                });
                            }
                        }
                    };
                    
                    // 立即尝试解锁音频
                    window.audioManager.unlock();
                    audioInitialized = true;
                    
                    // 隐藏音频激活提示
                    const audioNotice = document.getElementById('audio-activation-notice');
                    if (audioNotice) {
                        setTimeout(() => {
                            audioNotice.style.opacity = '0';
                            setTimeout(() => {
                                audioNotice.style.display = 'none';
                            }, 500);
                        }, 1000);
                    }
                    
                    // 播放一个测试音
                    setTimeout(() => {
                        window.audioManager.playSound('notification');
                    }, 100);
                    
                } catch (error) {
                    console.error('[音频] 音频系统初始化失败:', error);
                }
            };
            
            // 添加用户交互事件监听器
            userInteractionEvents.forEach(eventType => {
                document.addEventListener(eventType, unlockAudio, { 
                    once: true,
                    passive: true 
                });
            });
            
            // 3秒后如果还没有用户交互，显示提示
            setTimeout(() => {
                if (!audioInitialized) {
                    console.log('[音频] 等待用户交互以激活音频...');
                    
                    // 显示提示
                    const audioNotice = document.getElementById('audio-activation-notice');
                    if (audioNotice) {
                        audioNotice.innerHTML = `
                            <i class="fas fa-volume-up"></i>
                            <div>
                                <div style="font-weight: bold; margin-bottom: 4px;">点击任意位置激活声音</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">某些浏览器需要用户交互才能播放声音</div>
                            </div>
                        `;
                        audioNotice.classList.add('show');
                    }
                }
            }, 3000);
            
            // 强制页面加载后3秒激活音频（如果用户已与页面交互）
            setTimeout(() => {
                if (document.activeElement || 
                    document.hasFocus() || 
                    window.matchMedia('(pointer: fine) and (hover: hover)').matches) {
                    console.log('[音频] 检测到页面已有焦点，尝试激活音频...');
                    unlockAudio();
                }
            }, 3000);
        }

        // 检查设备兼容性
        function checkCompatibility() {
            const compatibility = {
                audio: 'AudioContext' in window || 'webkitAudioContext' in window,
                storage: typeof Storage !== 'undefined',
                notifications: 'Notification' in window,
                serviceWorker: 'serviceWorker' in navigator,
                vibration: 'vibrate' in navigator
            };
            
            console.log('[系统] 设备兼容性检查:', compatibility);
            
            if (!compatibility.audio) {
                console.warn('[系统] 音频API不支持，声音提示将不可用');
                const audioNotice = document.getElementById('audio-activation-notice');
                if (audioNotice) {
                    audioNotice.innerHTML = `
                        <i class="fas fa-volume-mute"></i>
                        <span>当前浏览器不支持音频功能，声音提示不可用</span>
                    `;
                    audioNotice.style.background = '#ff9f1a';
                }
            }
            
            if (!compatibility.storage) {
                console.warn('[系统] 本地存储不支持，将使用会话存储');
                showNotification('浏览器隐私设置可能阻止了本地存储，历史记录和设置将在当前会话中保存。', 'warning');
            }
            
            return compatibility;
        }

        // 初始化存储
        async function initStorage() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                console.log('[存储] 存储访问正常');
                return true;
            } catch (e) {
                console.warn('[存储] 浏览器隐私设置阻止了存储访问');
                window.fallbackStorage = new Map();
                return false;
            }
        }

        // 音频管理器类（简化版，不需要复杂的初始化）
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.unlocked = false;
                this.initialized = false;
                console.log('[音频] 音频管理器创建，等待用户交互');
            }
            
            // 初始化音频（在用户交互后调用）
            init() {
                if (this.initialized) return;
                
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    this.initialized = true;
                    console.log('[音频] 音频上下文创建成功');
                } catch (error) {
                    console.error('[音频] 音频上下文创建失败:', error);
                }
            }
            
            // 播放声音
            playSound(type) {
                if (!this.initialized || !this.audioContext) {
                    console.warn('[音频] 音频系统未初始化，跳过播放');
                    return;
                }
                
                // 确保音频上下文处于运行状态
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume().then(() => {
                        console.log('[音频] 音频上下文已恢复');
                        this._playTone(type);
                    }).catch(error => {
                        console.error('[音频] 音频恢复失败:', error);
                    });
                } else {
                    this._playTone(type);
                }
            }
            
            // 播放音调
            _playTone(type) {
                if (!this.audioContext || this.audioContext.state !== 'running') {
                    console.warn('[音频] 音频上下文未运行，跳过播放');
                    return;
                }
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    const soundConfigs = {
                        start: { frequency: 800, duration: 0.5 },
                        pause: { frequency: 600, duration: 0.3 },
                        complete: { frequency: 1000, duration: 1 },
                        alert: { frequency: 1200, duration: 0.2 },
                        notification: { frequency: 900, duration: 0.1 }
                    };
                    
                    const config = soundConfigs[type] || soundConfigs.start;
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.value = config.frequency;
                    
                    gainNode.gain.value = 0.1;
                    gainNode.gain.exponentialRampToValueAtTime(
                        0.01, 
                        this.audioContext.currentTime + config.duration
                    );
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + config.duration);
                    
                } catch (error) {
                    console.error('[音频] 播放音调失败:', error);
                }
            }
            
            // 解锁音频
            unlock() {
                if (this.audioContext) {
                    this.audioContext.resume().then(() => {
                        this.unlocked = true;
                        console.log('[音频] 音频已解锁');
                    }).catch(error => {
                        console.error('[音频] 音频解锁失败:', error);
                    });
                }
            }
        }

        // 初始化应用程序
        function initApp() {
            console.log('[系统] 初始化应用程序...');
            
            // 初始化状态
            window.timerState = {
                isRunning: false,
                isPaused: false,
                isWorkTime: true,
                timeLeft: 25 * 60,
                workTime: 25 * 60,
                breakTime: 5 * 60,
                longBreakTime: 15 * 60,
                pomodorosCompleted: 0,
                focusTimeToday: 0,
                tasksCompleted: 0,
                currentTask: null,
                timerInterval: null,
                pomodoroName: '专注工作',
                pomodoroCategory: 'work',
                completedPomodoros: [],
                tasks: []
            };
            
            // 从存储加载数据
            loadFromStorage();
            
            // 更新显示
            updateDisplay();
            updateStats();
            renderTaskList();
            renderHistory();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 初始化通知权限
            initNotifications();
            
            console.log('[系统] 应用程序初始化完成');
        }

        // 从存储加载数据
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem('pomodoroTimerData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    Object.assign(window.timerState, data);
                    
                    if (window.timerState.isWorkTime) {
                        window.timerState.timeLeft = window.timerState.workTime;
                    } else {
                        window.timerState.timeLeft = window.timerState.breakTime;
                    }
                    
                    console.log('[存储] 数据加载成功');
                }
            } catch (error) {
                console.error('[存储] 加载数据失败:', error);
            }
        }

        // 保存数据到存储
        function saveToStorage() {
            try {
                localStorage.setItem('pomodoroTimerData', JSON.stringify(window.timerState));
            } catch (error) {
                console.error('[存储] 保存数据失败:', error);
                if (window.fallbackStorage) {
                    window.fallbackStorage.set('pomodoroTimerData', JSON.stringify(window.timerState));
                }
            }
        }

        // 更新显示
        function updateDisplay() {
            const { timeLeft, isWorkTime, pomodoroName } = window.timerState;
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timeDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const modeIndicator = document.getElementById('modeIndicator');
            modeIndicator.textContent = isWorkTime ? '专注时间' : '休息时间';
            modeIndicator.className = `mode-indicator ${isWorkTime ? 'work' : 'break'}`;
            
            document.getElementById('pomodoroName').textContent = pomodoroName;
            updateProgressRing();
            updateTimeInputs();
        }

        // 更新进度环
        function updateProgressRing() {
            const { timeLeft, isWorkTime, workTime, breakTime } = window.timerState;
            const totalTime = isWorkTime ? workTime : breakTime;
            const progress = 1 - (timeLeft / totalTime);
            
            const progressCircle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 145;
            const offset = circumference - (progress * circumference);
            
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = offset;
            progressCircle.className = `progress-ring-circle ${isWorkTime ? 'work' : 'break'}`;
        }

        // 更新时间设置输入
        function updateTimeInputs() {
            const { workTime, breakTime, longBreakTime } = window.timerState;
            
            document.getElementById('workTimeInput').value = Math.floor(workTime / 60);
            document.getElementById('breakTimeInput').value = Math.floor(breakTime / 60);
            document.getElementById('longBreakTimeInput').value = Math.floor(longBreakTime / 60);
        }

        // 更新统计
        function updateStats() {
            const { pomodorosCompleted, focusTimeToday, tasksCompleted, completedPomodoros } = window.timerState;
            
            const totalWorkTime = completedPomodoros.reduce((total, pomodoro) => {
                return total + (pomodoro.workTime || 25 * 60);
            }, 0);
            
            document.getElementById('pomodorosCompleted').textContent = pomodorosCompleted;
            document.getElementById('focusTime').textContent = formatTime(focusTimeToday);
            document.getElementById('tasksCompleted').textContent = tasksCompleted;
            document.getElementById('totalTime').textContent = formatTime(totalWorkTime);
        }

        // 格式化时间
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        // 渲染任务列表
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            const { tasks } = window.timerState;
            
            taskList.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                         data-index="${index}"></div>
                    <div class="task-content">
                        <div class="task-name">${task.name}</div>
                        <div class="task-pomodoros">预计: ${task.estimatedPomodoros || 1} 个番茄</div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn edit-task" data-index="${index}" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-btn delete-task" data-index="${index}" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                taskList.appendChild(taskElement);
            });
            
            if (tasks.length === 0) {
                taskList.innerHTML = `
                    <div class="task-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-tasks" style="margin-right: 10px;"></i>
                        暂无任务，点击"添加"创建新任务
                    </div>
                `;
            }
        }

        // 渲染历史记录
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const { completedPomodoros } = window.timerState;
            
            historyList.innerHTML = '';
            
            const recentHistory = completedPomodoros.slice(-10).reverse();
            
            recentHistory.forEach((pomodoro, index) => {
                const historyElement = document.createElement('div');
                historyElement.className = 'history-item';
                
                const time = new Date(pomodoro.completedAt).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                historyElement.innerHTML = `
                    <div class="history-info">
                        <div class="history-task">${pomodoro.name || '未命名番茄钟'}</div>
                        <div class="history-time">${time}</div>
                    </div>
                    <div class="history-duration">${Math.floor(pomodoro.workTime / 60)}m</div>
                `;
                
                historyList.appendChild(historyElement);
            });
            
            if (recentHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item" style="justify-content: center; opacity: 0.7;">
                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                        暂无历史记录
                    </div>
                `;
            }
        }

        // 开始计时器
        function startTimer() {
            if (window.timerState.isRunning) return;
            
            window.timerState.isRunning = true;
            window.timerState.isPaused = false;
            
            // 播放开始声音
            if (window.audioManager && window.audioManager.initialized) {
                window.audioManager.playSound('start');
            } else {
                console.log('[音频] 音频未初始化，跳过声音');
            }
            
            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 运行中';
            
            // 设置定时器
            window.timerState.timerInterval = setInterval(() => {
                window.timerState.timeLeft--;
                
                if (window.timerState.timeLeft <= 0) {
                    completeTimer();
                }
                
                updateDisplay();
                
                if (window.timerState.timeLeft % 10 === 0) {
                    saveToStorage();
                }
            }, 1000);
            
            console.log('[计时器] 计时器已启动');
        }

        // 暂停计时器
        function pauseTimer() {
            if (!window.timerState.isRunning || window.timerState.isPaused) return;
            
            window.timerState.isPaused = true;
            clearInterval(window.timerState.timerInterval);
            
            // 播放暂停声音
            if (window.audioManager && window.audioManager.initialized) {
                window.audioManager.playSound('pause');
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 继续';
            
            console.log('[计时器] 计时器已暂停');
        }

        // 重置计时器
        function resetTimer() {
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[计时器] 计时器已重置');
        }

        // 完成计时器
        function completeTimer() {
            clearInterval(window.timerState.timerInterval);
            
            const { isWorkTime, workTime, pomodorosCompleted, focusTimeToday, completedPomodoros } = window.timerState;
            
            if (isWorkTime) {
                window.timerState.pomodorosCompleted++;
                window.timerState.focusTimeToday += workTime;
                
                completedPomodoros.push({
                    name: window.timerState.pomodoroName,
                    workTime: workTime,
                    completedAt: new Date().toISOString(),
                    category: window.timerState.pomodoroCategory
                });
                
                const shouldTakeLongBreak = window.timerState.pomodorosCompleted % 4 === 0;
                
                window.timerState.isWorkTime = false;
                window.timerState.timeLeft = shouldTakeLongBreak ? 
                    window.timerState.longBreakTime : 
                    window.timerState.breakTime;
                
                // 播放完成声音
                if (window.audioManager && window.audioManager.initialized) {
                    window.audioManager.playSound('complete');
                }
                
                const message = shouldTakeLongBreak ? 
                    '专注时间结束！现在是长休息时间。' : 
                    '专注时间结束！现在是休息时间。';
                showNotification(message, 'success');
                
                if (Notification.permission === 'granted') {
                    new Notification('番茄钟完成！', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff6b6b"><path d="M0 0h24v24H0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>'
                    });
                }
                
                console.log('[计时器] 专注时间完成，进入休息时间');
            } else {
                window.timerState.isWorkTime = true;
                window.timerState.timeLeft = window.timerState.workTime;
                
                if (window.audioManager && window.audioManager.initialized) {
                    window.audioManager.playSound('alert');
                }
                
                showNotification('休息时间结束！开始下一个专注时段。', 'info');
                console.log('[计时器] 休息时间结束，开始专注时间');
            }
            
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            updateDisplay();
            updateStats();
            renderHistory();
            saveToStorage();
            
            if (window.timerState.isWorkTime) {
                setTimeout(() => {
                    showPomodoroNameModal();
                }, 500);
            }
        }

        // 跳过当前时段
        function skipTimer() {
            if (window.timerState.isRunning) {
                if (!confirm('确定要跳过当前时段吗？')) {
                    return;
                }
            }
            
            clearInterval(window.timerState.timerInterval);
            
            window.timerState.isWorkTime = !window.timerState.isWorkTime;
            window.timerState.isRunning = false;
            window.timerState.isPaused = false;
            window.timerState.timeLeft = window.timerState.isWorkTime ? 
                window.timerState.workTime : 
                window.timerState.breakTime;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i> 开始';
            
            updateDisplay();
            saveToStorage();
            
            console.log('[计时器] 已跳过当前时段');
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} notification-icon"></i>
                <span>${message}</span>
            `;
            
            notifications.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 获取通知图标
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': 
                default: return 'fa-info-circle';
            }
        }

        // 显示番茄钟命名模态框
        function showPomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            const nameInput = document.getElementById('pomodoroNameInput');
            const categorySelect = document.getElementById('pomodoroCategory');
            
            nameInput.value = window.timerState.pomodoroName;
            categorySelect.value = window.timerState.pomodoroCategory;
            
            modal.classList.add('show');
            nameInput.focus();
            
            console.log('[模态框] 显示番茄钟命名模态框');
        }

        // 隐藏番茄钟命名模态框
        function hidePomodoroNameModal() {
            const modal = document.getElementById('pomodoroNameModal');
            modal.classList.remove('show');
        }

        // 初始化通知权限
        function initNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                // 可以请求权限
                console.log('[通知] 可以请求通知权限');
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            console.log('[系统] 设置事件监听器...');
            
            // 音频管理器初始化
            let audioManagerInitialized = false;
            
            // 用户交互时初始化音频管理器
            const initAudioOnInteraction = () => {
                if (!audioManagerInitialized) {
                    window.audioManager = new AudioManager();
                    window.audioManager.init();
                    audioManagerInitialized = true;
                    console.log('[音频] 音频管理器已初始化');
                }
            };
            
            // 添加用户交互事件
            const interactionEvents = ['click', 'touchstart', 'keydown', 'mousedown'];
            interactionEvents.forEach(event => {
                document.addEventListener(event, initAudioOnInteraction, { once: true });
            });
            
            // 计时器控制按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                startTimer();
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                pauseTimer();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                resetTimer();
            });
            
            document.getElementById('skipBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                skipTimer();
            });
            
            // 时间设置按钮
            document.getElementById('increaseWorkTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeWorkTime(1);
            });
            
            document.getElementById('decreaseWorkTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeWorkTime(-1);
            });
            
            document.getElementById('increaseBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeBreakTime(1);
            });
            
            document.getElementById('decreaseBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeBreakTime(-1);
            });
            
            document.getElementById('increaseLongBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeLongBreakTime(1);
            });
            
            document.getElementById('decreaseLongBreakTime').addEventListener('click', () => {
                initAudioOnInteraction();
                changeLongBreakTime(-1);
            });
            
            // 时间输入框事件
            const timeInputs = ['workTimeInput', 'breakTimeInput', 'longBreakTimeInput'];
            timeInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('blur', function() {
                    initAudioOnInteraction();
                    const value = parseInt(this.value) || 1;
                    const min = 1;
                    const max = 120;
                    const validatedValue = Math.max(min, Math.min(max, value));
                    
                    this.value = validatedValue;
                    
                    if (id === 'workTimeInput') {
                        window.timerState.workTime = validatedValue * 60;
                        if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.workTime;
                        }
                    } else if (id === 'breakTimeInput') {
                        window.timerState.breakTime = validatedValue * 60;
                        if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.breakTime;
                        }
                    } else if (id === 'longBreakTimeInput') {
                        window.timerState.longBreakTime = validatedValue * 60;
                    }
                    
                    updateDisplay();
                    saveToStorage();
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });
            });
            
            // 统计重置按钮
            document.getElementById('resetStatsBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                if (confirm('确定要重置所有统计信息吗？此操作不可撤销。')) {
                    window.timerState.pomodorosCompleted = 0;
                    window.timerState.focusTimeToday = 0;
                    window.timerState.tasksCompleted = 0;
                    window.timerState.completedPomodoros = [];
                    updateStats();
                    renderHistory();
                    saveToStorage();
                    showNotification('统计信息已重置', 'success');
                }
            });
            
            // 任务相关按钮
            document.getElementById('addTaskBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                const input = document.getElementById('newTaskInput');
                input.focus();
                input.select();
            });
            
            document.getElementById('confirmAddTask').addEventListener('click', () => {
                initAudioOnInteraction();
                addNewTask();
            });
            
            document.getElementById('newTaskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    initAudioOnInteraction();
                    addNewTask();
                }
            });
            
            // 历史记录清空按钮
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                if (confirm('确定要清空历史记录吗？此操作不可撤销。')) {
                    window.timerState.completedPomodoros = [];
                    renderHistory();
                    saveToStorage();
                    showNotification('历史记录已清空', 'success');
                }
            });
            
            // 模态框相关按钮
            document.getElementById('closeNameModal').addEventListener('click', () => {
                initAudioOnInteraction();
                hidePomodoroNameModal();
            });
            
            document.getElementById('cancelNameBtn').addEventListener('click', () => {
                initAudioOnInteraction();
                hidePomodoroNameModal();
            });
            
            document.getElementById('saveNameBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                const name = document.getElementById('pomodoroNameInput').value.trim();
                const category = document.getElementById('pomodoroCategory').value;
                
                if (name) {
                    window.timerState.pomodoroName = name;
                    window.timerState.pomodoroCategory = category;
                    document.getElementById('pomodoroName').textContent = name;
                    hidePomodoroNameModal();
                    saveToStorage();
                    showNotification('番茄钟名称已更新', 'success');
                } else {
                    showNotification('请输入番茄钟名称', 'error');
                }
            });
            
            // 设置按钮
            document.getElementById('settingsBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                showNotification('设置功能开发中...', 'info');
            });
            
            // 全屏按钮
            document.getElementById('fullscreenBtn').addEventListener('click', function() {
                initAudioOnInteraction();
                toggleFullscreen();
            });
            
            // 主题切换按钮
            document.getElementById('themeToggle').addEventListener('click', function() {
                initAudioOnInteraction();
                toggleTheme();
            });
            
            // 点击任务列表
            document.getElementById('taskList').addEventListener('click', function(e) {
                initAudioOnInteraction();
                const target = e.target;
                const taskItem = target.closest('.task-item');
                
                if (!taskItem) return;
                
                const index = parseInt(taskItem.querySelector('.task-checkbox').dataset.index);
                
                if (target.classList.contains('task-checkbox')) {
                    toggleTaskCompletion(index);
                } else if (target.closest('.edit-task')) {
                    editTask(index);
                } else if (target.closest('.delete-task')) {
                    deleteTask(index);
                }
            });
            
            // 点击模态框外部关闭
            document.getElementById('pomodoroNameModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePomodoroNameModal();
                }
            });
            
            // 按键事件
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case ' ':
                    case 'Spacebar':
                        e.preventDefault();
                        initAudioOnInteraction();
                        if (window.timerState.isRunning) {
                            pauseTimer();
                        } else {
                            startTimer();
                        }
                        break;
                    case 'Escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                        hidePomodoroNameModal();
                        break;
                    case 'r':
                    case 'R':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            initAudioOnInteraction();
                            resetTimer();
                        }
                        break;
                    case 's':
                    case 'S':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            initAudioOnInteraction();
                            skipTimer();
                        }
                        break;
                }
            });
            
            // 页面可见性变化
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[系统] 页面进入后台');
                } else {
                    console.log('[系统] 页面返回前台');
                }
            });
            
            // 页面卸载前保存
            window.addEventListener('beforeunload', function() {
                saveToStorage();
                console.log('[系统] 页面卸载，数据已保存');
            });
            
            console.log('[系统] 事件监听器设置完成');
        }

        // 修改专注时间
        function changeWorkTime(delta) {
            const newTime = Math.max(1, Math.min(120, Math.floor(window.timerState.workTime / 60) + delta));
            window.timerState.workTime = newTime * 60;
            
            if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.workTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // 修改休息时间
        function changeBreakTime(delta) {
            const newTime = Math.max(1, Math.min(60, Math.floor(window.timerState.breakTime / 60) + delta));
            window.timerState.breakTime = newTime * 60;
            
            if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                window.timerState.timeLeft = window.timerState.breakTime;
            }
            
            updateDisplay();
            saveToStorage();
        }

        // 修改长休息时间
        function changeLongBreakTime(delta) {
            const newTime = Math.max(5, Math.min(60, Math.floor(window.timerState.longBreakTime / 60) + delta));
            window.timerState.longBreakTime = newTime * 60;
            updateDisplay();
            saveToStorage();
        }

        // 添加新任务
        function addNewTask() {
            const input = document.getElementById('newTaskInput');
            const name = input.value.trim();
            
            if (!name) {
                showNotification('请输入任务名称', 'error');
                input.focus();
                return;
            }
            
            const task = {
                id: Date.now(),
                name: name,
                completed: false,
                createdAt: new Date().toISOString(),
                estimatedPomodoros: 1
            };
            
            window.timerState.tasks.push(task);
            input.value = '';
            renderTaskList();
            saveToStorage();
            
            showNotification('任务已添加', 'success');
        }

        // 切换任务完成状态
        function toggleTaskCompletion(index) {
            if (index >= 0 && index < window.timerState.tasks.length) {
                window.timerState.tasks[index].completed = !window.timerState.tasks[index].completed;
                
                if (window.timerState.tasks[index].completed) {
                    window.timerState.tasksCompleted++;
                } else {
                    window.timerState.tasksCompleted--;
                }
                
                renderTaskList();
                updateStats();
                saveToStorage();
                
                const message = window.timerState.tasks[index].completed ? 
                    '任务已完成！' : '任务已取消完成';
                showNotification(message, 'success');
            }
        }

        // 编辑任务
        function editTask(index) {
            const task = window.timerState.tasks[index];
            const newName = prompt('编辑任务名称:', task.name);
            
            if (newName && newName.trim()) {
                task.name = newName.trim();
                renderTaskList();
                saveToStorage();
                showNotification('任务已更新', 'success');
            }
        }

        // 删除任务
        function deleteTask(index) {
            if (confirm('确定要删除这个任务吗？')) {
                const task = window.timerState.tasks[index];
                
                if (task.completed) {
                    window.timerState.tasksCompleted--;
                }
                
                window.timerState.tasks.splice(index, 1);
                renderTaskList();
                updateStats();
                saveToStorage();
                showNotification('任务已删除', 'success');
            }
        }

        // 切换全屏
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('全屏请求失败:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // 切换主题
        function toggleTheme() {
            const isDark = document.body.classList.toggle('light-theme');
            const icon = document.querySelector('#themeToggle i');
            
            if (isDark) {
                icon.className = 'fas fa-sun';
                document.documentElement.style.setProperty('--dark-bg', '#f5f6fa');
                document.documentElement.style.setProperty('--darker-bg', '#dcdde1');
                document.documentElement.style.setProperty('--light-text', '#2f3640');
                document.documentElement.style.setProperty('--medium-text', '#353b48');
                document.documentElement.style.setProperty('--dark-text', '#192a56');
            } else {
                icon.className = 'fas fa-moon';
                document.documentElement.style.setProperty('--dark-bg', '#2c3e50');
                document.documentElement.style.setProperty('--darker-bg', '#1e272e');
                document.documentElement.style.setProperty('--light-text', '#f5f6fa');
                document.documentElement.style.setProperty('--medium-text', '#dcdde1');
                document.documentElement.style.setProperty('--dark-text', '#2f3640');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)} notification-icon"></i>
                <span>${message}</span>
            `;
            
            notifications.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 初始化完成
        console.log('[系统] 番茄钟计时器已准备就绪');
        showNotification('番茄钟计时器已启动！按空格键开始/暂停。', 'info');
        
        // 3秒后检查音频状态
        setTimeout(() => {
            if (window.audioManager && window.audioManager.initialized) {
                console.log('[音频] 音频系统已准备就绪');
            } else {
                console.log('[音频] 等待用户交互以激活音频系统');
            }
        }, 3000);
    </script>
</body>
</html>
// 续接上面代码...

        // 键盘快捷键提示
        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: '空格键', action: '开始/暂停计时器' },
                { key: 'R', action: '重置计时器' },
                { key: 'S', action: '跳过当前时段' },
                { key: 'ESC', action: '退出全屏/关闭对话框' },
                { key: 'F11', action: '切换全屏模式' },
                { key: 'Ctrl+S', action: '保存数据' },
                { key: 'Ctrl+E', action: '导出数据' },
                { key: 'Ctrl+I', action: '导入数据' }
            ];
            
            let message = '键盘快捷键：\n';
            shortcuts.forEach(shortcut => {
                message += `  ${shortcut.key}: ${shortcut.action}\n`;
            });
            
            alert(message);
        }

        // 导出数据
        function exportData() {
            const data = {
                version: '1.0.0',
                exportDate: new Date().toISOString(),
                timerData: window.timerState,
                tasks: window.timerState.tasks,
                history: window.timerState.completedPomodoros
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pomodoro-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('数据导出成功！', 'success');
        }

        // 导入数据
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (confirm('导入数据将覆盖当前所有数据，确定继续吗？')) {
                            if (importedData.timerData) {
                                Object.assign(window.timerState, importedData.timerData);
                            }
                            
                            if (importedData.tasks) {
                                window.timerState.tasks = importedData.tasks;
                            }
                            
                            if (importedData.history) {
                                window.timerState.completedPomodoros = importedData.history;
                            }
                            
                            updateDisplay();
                            updateStats();
                            renderTaskList();
                            renderHistory();
                            saveToStorage();
                            
                            showNotification('数据导入成功！', 'success');
                        }
                    } catch (error) {
                        console.error('[导入] 数据导入失败:', error);
                        showNotification('导入失败：文件格式不正确', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 初始化服务工作者（PWA支持）
        function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('[PWA] ServiceWorker 注册成功:', registration.scope);
                    }).catch(error => {
                        console.log('[PWA] ServiceWorker 注册失败:', error);
                    });
                });
            }
        }

        // 添加到主屏幕提示
        function showInstallPrompt() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                const installButton = document.createElement('button');
                installButton.innerHTML = '<i class="fas fa-download"></i> 安装应用';
                installButton.className = 'btn btn-primary';
                installButton.style.position = 'fixed';
                installButton.style.bottom = '20px';
                installButton.style.left = '20px';
                installButton.style.zIndex = '1000';
                
                installButton.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(choiceResult => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('[PWA] 用户同意安装');
                        } else {
                            console.log('[PWA] 用户拒绝安装');
                        }
                        deferredPrompt = null;
                        installButton.remove();
                    });
                });
                
                document.body.appendChild(installButton);
                
                // 7天后自动移除提示
                setTimeout(() => {
                    if (installButton.parentNode) {
                        installButton.remove();
                    }
                }, 7 * 24 * 60 * 60 * 1000);
            });
        }

        // 触摸手势支持
        function setupTouchGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', function(e) {
                if (!touchStartX || !touchStartY) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // 水平滑动大于垂直滑动
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // 左滑
                    if (diffX > 50) {
                        skipTimer();
                        e.preventDefault();
                    }
                    // 右滑
                    else if (diffX < -50) {
                        resetTimer();
                        e.preventDefault();
                    }
                }
                // 垂直滑动
                else {
                    // 下滑
                    if (diffY > 50) {
                        if (window.timerState.isRunning) {
                            pauseTimer();
                        } else {
                            startTimer();
                        }
                        e.preventDefault();
                    }
                }
                
                touchStartX = 0;
                touchStartY = 0;
            });
        }

        // 设备振动（如果支持）
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // 屏幕常亮功能
        function keepScreenAwake() {
            if ('wakeLock' in navigator) {
                let wakeLock = null;
                
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('[屏幕] 屏幕常亮已启用');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('[屏幕] 屏幕常亮已释放');
                        });
                    } catch (err) {
                        console.error('[屏幕] 屏幕常亮启用失败:', err);
                    }
                };
                
                // 页面可见时启用
                const handleVisibilityChange = () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // 初始启用
                requestWakeLock();
                
                return wakeLock;
            }
            return null;
        }

        // 语音合成提示
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // 主题管理
        class ThemeManager {
            constructor() {
                this.themes = {
                    'dark': {
                        '--primary-color': '#ff6b6b',
                        '--primary-dark': '#ff4757',
                        '--secondary-color': '#1e90ff',
                        '--secondary-dark': '#3742fa',
                        '--break-color': '#2ed573',
                        '--break-dark': '#1dd1a1',
                        '--dark-bg': '#2c3e50',
                        '--darker-bg': '#1e272e',
                        '--light-text': '#f5f6fa',
                        '--medium-text': '#dcdde1',
                        '--card-bg': 'rgba(255, 255, 255, 0.05)'
                    },
                    'light': {
                        '--primary-color': '#ff6b6b',
                        '--primary-dark': '#ff4757',
                        '--secondary-color': '#1e90ff',
                        '--secondary-dark': '#3742fa',
                        '--break-color': '#2ed573',
                        '--break-dark': '#1dd1a1',
                        '--dark-bg': '#f5f6fa',
                        '--darker-bg': '#dcdde1',
                        '--light-text': '#2f3640',
                        '--medium-text': '#353b48',
                        '--card-bg': 'rgba(0, 0, 0, 0.05)'
                    },
                    'blue': {
                        '--primary-color': '#3498db',
                        '--primary-dark': '#2980b9',
                        '--secondary-color': '#9b59b6',
                        '--secondary-dark': '#8e44ad',
                        '--break-color': '#2ecc71',
                        '--break-dark': '#27ae60',
                        '--dark-bg': '#2c3e50',
                        '--darker-bg': '#34495e',
                        '--light-text': '#ecf0f1',
                        '--medium-text': '#bdc3c7',
                        '--card-bg': 'rgba(255, 255, 255, 0.05)'
                    },
                    'green': {
                        '--primary-color': '#2ecc71',
                        '--primary-dark': '#27ae60',
                        '--secondary-color': '#3498db',
                        '--secondary-dark': '#2980b9',
                        '--break-color': '#e74c3c',
                        '--break-dark': '#c0392b',
                        '--dark-bg': '#2c3e50',
                        '--darker-bg': '#27ae60',
                        '--light-text': '#ecf0f1',
                        '--medium-text': '#bdc3c7',
                        '--card-bg': 'rgba(255, 255, 255, 0.05)'
                    }
                };
                
                this.currentTheme = 'dark';
                this.loadTheme();
            }
            
            loadTheme() {
                const savedTheme = localStorage.getItem('pomodoro-theme');
                if (savedTheme && this.themes[savedTheme]) {
                    this.currentTheme = savedTheme;
                }
                this.applyTheme();
            }
            
            applyTheme() {
                const theme = this.themes[this.currentTheme];
                Object.keys(theme).forEach(key => {
                    document.documentElement.style.setProperty(key, theme[key]);
                });
                
                const themeToggleIcon = document.querySelector('#themeToggle i');
                if (themeToggleIcon) {
                    themeToggleIcon.className = this.getThemeIcon();
                }
                
                localStorage.setItem('pomodoro-theme', this.currentTheme);
            }
            
            getThemeIcon() {
                switch(this.currentTheme) {
                    case 'light': return 'fas fa-sun';
                    case 'blue': return 'fas fa-tint';
                    case 'green': return 'fas fa-leaf';
                    default: return 'fas fa-moon';
                }
            }
            
            nextTheme() {
                const themeKeys = Object.keys(this.themes);
                const currentIndex = themeKeys.indexOf(this.currentTheme);
                this.currentTheme = themeKeys[(currentIndex + 1) % themeKeys.length];
                this.applyTheme();
                return this.currentTheme;
            }
            
            setTheme(themeName) {
                if (this.themes[themeName]) {
                    this.currentTheme = themeName;
                    this.applyTheme();
                }
            }
        }

        // 番茄钟统计
        class PomodoroStats {
            constructor() {
                this.today = new Date().toISOString().split('T')[0];
                this.weeklyData = {};
                this.monthlyData = {};
                this.loadStats();
            }
            
            loadStats() {
                try {
                    const savedStats = localStorage.getItem('pomodoro-stats');
                    if (savedStats) {
                        const stats = JSON.parse(savedStats);
                        
                        if (stats.today === this.today) {
                            this.daily = stats.daily;
                        } else {
                            this.daily = {
                                date: this.today,
                                pomodoros: 0,
                                focusTime: 0,
                                tasksCompleted: 0,
                                breaksTaken: 0
                            };
                        }
                        
                        this.weeklyData = stats.weeklyData || {};
                        this.monthlyData = stats.monthlyData || {};
                    } else {
                        this.daily = {
                            date: this.today,
                            pomodoros: 0,
                            focusTime: 0,
                            tasksCompleted: 0,
                            breaksTaken: 0
                        };
                    }
                } catch (error) {
                    console.error('[统计] 加载统计失败:', error);
                    this.resetDaily();
                }
            }
            
            saveStats() {
                try {
                    const stats = {
                        today: this.today,
                        daily: this.daily,
                        weeklyData: this.weeklyData,
                        monthlyData: this.monthlyData
                    };
                    localStorage.setItem('pomodoro-stats', JSON.stringify(stats));
                } catch (error) {
                    console.error('[统计] 保存统计失败:', error);
                }
            }
            
            resetDaily() {
                this.daily = {
                    date: this.today,
                    pomodoros: 0,
                    focusTime: 0,
                    tasksCompleted: 0,
                    breaksTaken: 0
                };
                this.saveStats();
            }
            
            addPomodoro(workTime) {
                this.daily.pomodoros++;
                this.daily.focusTime += workTime;
                
                const week = this.getWeekNumber();
                const month = new Date().getMonth();
                
                if (!this.weeklyData[week]) {
                    this.weeklyData[week] = { pomodoros: 0, focusTime: 0 };
                }
                this.weeklyData[week].pomodoros++;
                this.weeklyData[week].focusTime += workTime;
                
                if (!this.monthlyData[month]) {
                    this.monthlyData[month] = { pomodoros: 0, focusTime: 0 };
                }
                this.monthlyData[month].pomodoros++;
                this.monthlyData[month].focusTime += workTime;
                
                this.saveStats();
            }
            
            getWeekNumber() {
                const now = new Date();
                const oneJan = new Date(now.getFullYear(), 0, 1);
                const weekNumber = Math.ceil(((now - oneJan) / 86400000 + oneJan.getDay() + 1) / 7);
                return weekNumber;
            }
            
            getStats() {
                return {
                    daily: this.daily,
                    weekly: this.weeklyData[this.getWeekNumber()] || { pomodoros: 0, focusTime: 0 },
                    monthly: this.monthlyData[new Date().getMonth()] || { pomodoros: 0, focusTime: 0 }
                };
            }
        }

        // 番茄钟分析
        class PomodoroAnalytics {
            constructor() {
                this.stats = new PomodoroStats();
            }
            
            getDailyChartData() {
                const today = new Date();
                const hours = Array.from({length: 24}, (_, i) => {
                    const hour = i.toString().padStart(2, '0') + ':00';
                    return { hour, pomodoros: 0 };
                });
                
                window.timerState.completedPomodoros.forEach(pomodoro => {
                    const date = new Date(pomodoro.completedAt);
                    if (date.toDateString() === today.toDateString()) {
                        const hour = date.getHours();
                        hours[hour].pomodoros++;
                    }
                });
                
                return hours;
            }
            
            getWeeklyChartData() {
                const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                const today = new Date();
                const data = {};
                
                days.forEach(day => data[day] = 0);
                
                window.timerState.completedPomodoros.forEach(pomodoro => {
                    const date = new Date(pomodoro.completedAt);
                    const dayDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff < 7) {
                        const dayName = days[date.getDay()];
                        data[dayName]++;
                    }
                });
                
                return Object.keys(data).map(day => ({ day, count: data[day] }));
            }
            
            getCategoryDistribution() {
                const categories = {};
                
                window.timerState.completedPomodoros.forEach(pomodoro => {
                    const category = pomodoro.category || '未分类';
                    categories[category] = (categories[category] || 0) + 1;
                });
                
                return Object.keys(categories).map(category => ({
                    category,
                    count: categories[category]
                }));
            }
            
            getProductivityScore() {
                const stats = this.stats.getStats();
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                
                const todayPomodoros = window.timerState.completedPomodoros.filter(pomodoro => {
                    const pomodoroDate = new Date(pomodoro.completedAt);
                    return pomodoroDate >= startOfDay && pomodoroDate < endOfDay;
                }).length;
                
                const hoursWorked = stats.daily.focusTime / 3600;
                const breaksEfficiency = stats.daily.breaksTaken > 0 ? 
                    Math.min(1, todayPomodoros / (stats.daily.breaksTaken * 4)) : 1;
                
                const productivity = Math.min(100, 
                    (todayPomodoros * 25) + 
                    (hoursWorked * 20) + 
                    (breaksEfficiency * 25));
                
                return {
                    score: Math.round(productivity),
                    factors: {
                        pomodoros: todayPomodoros * 25,
                        hoursWorked: hoursWorked * 20,
                        breaksEfficiency: breaksEfficiency * 25
                    },
                    todayPomodoros,
                        breaksTaken: stats.daily.breaksTaken
                };
            }
        }

        // 高级功能
        class PomodoroAdvanced {
            constructor() {
                this.analytics = new PomodoroAnalytics();
                this.taskScheduler = null;
                this.reminders = [];
                this.loadReminders();
            }
            
            // 任务调度
            scheduleTask(task, scheduleTime) {
                const now = new Date();
                const scheduleDate = new Date(scheduleTime);
                const delay = scheduleDate.getTime() - now.getTime();
                
                if (delay > 0) {
                    this.taskScheduler = setTimeout(() => {
                        this.showReminder(task);
                        speak(`提醒：${task.name}`);
                        
                        if (window.audioManager && window.audioManager.initialized) {
                            window.audioManager.playSound('alert');
                        }
                    }, delay);
                    
                    console.log(`[提醒] 任务已安排：${task.name} 在 ${scheduleTime}`);
                }
            }
            
            // 显示提醒
            showReminder(task) {
                if (Notification.permission === 'granted') {
                    new Notification('任务提醒', {
                        body: task.name,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233498db"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5z"/></svg>'
                    });
                }
                
                showNotification(`任务提醒：${task.name}`, 'info');
            }
            
            // 保存提醒
            saveReminders() {
                try {
                    localStorage.setItem('pomodoro-reminders', JSON.stringify(this.reminders));
                } catch (error) {
                    console.error('[提醒] 保存提醒失败:', error);
                }
            }
            
            // 加载提醒
            loadReminders() {
                try {
                    const saved = localStorage.getItem('pomodoro-reminders');
                    if (saved) {
                        this.reminders = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('[提醒] 加载提醒失败:', error);
                }
            }
            
            // 添加提醒
            addReminder(task, time) {
                const reminder = {
                    id: Date.now(),
                    task: { ...task },
                    time: time,
                    enabled: true
                };
                
                this.reminders.push(reminder);
                this.saveReminders();
                this.scheduleReminder(reminder);
            }
            
            // 安排提醒
            scheduleReminder(reminder) {
                if (!reminder.enabled) return;
                
                const now = new Date();
                const reminderTime = new Date(reminder.time);
                
                if (reminderTime > now) {
                    const delay = reminderTime.getTime() - now.getTime();
                    
                    setTimeout(() => {
                        this.showReminder(reminder.task);
                        this.removeReminder(reminder.id);
                    }, delay);
                }
            }
            
            // 移除提醒
            removeReminder(id) {
                this.reminders = this.reminders.filter(r => r.id !== id);
                this.saveReminders();
            }
            
            // 导出分析报告
            exportReport() {
                const report = {
                    exportDate: new Date().toISOString(),
                    analytics: {
                        dailyStats: this.analytics.getDailyChartData(),
                        weeklyStats: this.analytics.getWeeklyChartData(),
                        categoryStats: this.analytics.getCategoryDistribution(),
                        productivity: this.analytics.getProductivityScore()
                    },
                    tasks: window.timerState.tasks,
                    history: window.timerState.completedPomodoros,
                    settings: {
                        workTime: window.timerState.workTime,
                        breakTime: window.timerState.breakTime,
                        longBreakTime: window.timerState.longBreakTime
                    }
                };
                
                const dataStr = JSON.stringify(report, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pomodoro-report-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('分析报告导出成功！', 'success');
            }
            
            // 显示分析界面
            showAnalytics() {
                const analyticsData = this.analytics.getProductivityScore();
                
                let message = '📊 今日生产力分析\n';
                message += `🏆 生产力得分: ${analyticsData.score}/100\n`;
                message += `🍅 完成番茄钟: ${analyticsData.todayPomodoros}\n`;
                message += `⏰ 专注时长: ${formatTime(window.timerState.focusTimeToday)}\n`;
                message += `✅ 完成任务: ${window.timerState.tasksCompleted}\n`;
                message += `💪 休息效率: ${analyticsData.breaksTaken} 次休息\n\n`;
                message += '📈 表现分析:\n';
                
                if (analyticsData.score >= 80) {
                    message += '🎉 优秀！继续保持高效的专注！\n';
                } else if (analyticsData.score >= 60) {
                    message += '👍 良好！可以尝试增加专注时间。\n';
                } else if (analyticsData.score >= 40) {
                    message += '😊 一般！注意休息和工作平衡。\n';
                } else {
                    message += '💪 加油！试试25分钟的番茄钟。\n';
                }
                
                alert(message);
            }
        }

        // 扩展键盘快捷键
        function setupExtendedKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // 只在没有输入框聚焦时处理
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case ' ':
                        e.preventDefault();
                        if (window.timerState.isRunning) {
                            pauseTimer();
                        } else {
                            startTimer();
                        }
                        break;
                        
                    case 'r':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            resetTimer();
                        }
                        break;
                        
                    case 's':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            skipTimer();
                        }
                        break;
                        
                    case 'e':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            exportData();
                        }
                        break;
                        
                    case 'i':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            importData();
                        }
                        break;
                        
                    case '?':
                        if (e.ctrlKey || e.key === '?') {
                            e.preventDefault();
                            showKeyboardShortcuts();
                        }
                        break;
                        
                    case 'f11':
                        toggleFullscreen();
                        break;
                        
                    case 'escape':
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                        hidePomodoroNameModal();
                        break;
                }
            });
        }

        // 初始化高级功能
        function initAdvancedFeatures() {
            console.log('[系统] 初始化高级功能...');
            
            // 主题管理器
            window.themeManager = new ThemeManager();
            
            // 高级功能管理器
            window.advancedManager = new PomodoroAdvanced();
            
            // 屏幕常亮
            if ('wakeLock' in navigator) {
                const wakeLockButton = document.createElement('button');
                wakeLockButton.innerHTML = '<i class="fas fa-sun"></i>';
                wakeLockButton.className = 'theme-toggle';
                wakeLockButton.style.bottom = '200px';
                wakeLockButton.title = '屏幕常亮';
                wakeLockButton.id = 'wakeLockBtn';
                
                wakeLockButton.addEventListener('click', () => {
                    if (window.wakeLock) {
                        window.wakeLock.release();
                        window.wakeLock = null;
                        wakeLockButton.innerHTML = '<i class="fas fa-sun"></i>';
                        showNotification('屏幕常亮已关闭', 'info');
                    } else {
                        window.wakeLock = keepScreenAwake();
                        if (window.wakeLock) {
                            wakeLockButton.innerHTML = '<i class="fas fa-sun" style="color: #ff6b6b;"></i>';
                            showNotification('屏幕常亮已开启', 'success');
                        }
                    }
                });
                
                document.body.appendChild(wakeLockButton);
            }
            
            // 语音控制
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    handleVoiceCommand(command);
                };
                
                recognition.onerror = function(event) {
                    console.log('[语音] 语音识别错误:', event.error);
                };
                
                const voiceButton = document.createElement('button');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceButton.className = 'theme-toggle';
                voiceButton.style.bottom = '260px';
                voiceButton.title = '语音控制';
                voiceButton.id = 'voiceControlBtn';
                
                voiceButton.addEventListener('click', () => {
                    recognition.start();
                    showNotification('正在监听语音命令...', 'info');
                });
                
                document.body.appendChild(voiceButton);
            }
            
            // 分析按钮
            const analyticsButton = document.createElement('button');
            analyticsButton.innerHTML = '<i class="fas fa-chart-line"></i>';
            analyticsButton.className = 'theme-toggle';
            analyticsButton.style.bottom = '320px';
            analyticsButton.title = '分析报告';
            analyticsButton.id = 'analyticsBtn';
            
            analyticsButton.addEventListener('click', () => {
                window.advancedManager.showAnalytics();
            });
            
            document.body.appendChild(analyticsButton);
            
            // 备份按钮
            const backupButton = document.createElement('button');
            backupButton.innerHTML = '<i class="fas fa-save"></i>';
            backupButton.className = 'theme-toggle';
            backupButton.style.bottom = '380px';
            backupButton.title = '备份数据';
            backupButton.id = 'backupBtn';
            
            backupButton.addEventListener('click', () => {
                exportData();
            });
            
            document.body.appendChild(backupButton);
            
            console.log('[系统] 高级功能初始化完成');
        }

        // 处理语音命令
        function handleVoiceCommand(command) {
            console.log('[语音] 收到命令:', command);
            
            if (command.includes('开始') || command.includes('启动')) {
                startTimer();
                speak('计时器已启动');
            } else if (command.includes('暂停') || command.includes('停止')) {
                pauseTimer();
                speak('计时器已暂停');
            } else if (command.includes('重置') || command.includes('重新开始')) {
                resetTimer();
                speak('计时器已重置');
            } else if (command.includes('跳过')) {
                skipTimer();
                speak('已跳过当前时段');
            } else if (command.includes('专注') && command.includes('时间')) {
                const match = command.match(/(\d+)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    if (minutes >= 1 && minutes <= 120) {
                        window.timerState.workTime = minutes * 60;
                        if (window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.workTime;
                        }
                        updateDisplay();
                        saveToStorage();
                        speak(`专注时间已设置为${minutes}分钟`);
                    }
                }
            } else if (command.includes('休息') && command.includes('时间')) {
                const match = command.match(/(\d+)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    if (minutes >= 1 && minutes <= 60) {
                        window.timerState.breakTime = minutes * 60;
                        if (!window.timerState.isWorkTime && !window.timerState.isRunning) {
                            window.timerState.timeLeft = window.timerState.breakTime;
                        }
                        updateDisplay();
                        saveToStorage();
                        speak(`休息时间已设置为${minutes}分钟`);
                    }
                }
            } else {
                speak('未识别命令，请重试');
            }
        }

        // 错误边界处理
        function setupErrorHandling() {
            // 全局错误处理
            window.addEventListener('error', function(event) {
                console.error('[错误] 全局错误:', event.error);
                showNotification('发生错误，请刷新页面重试', 'error');
            });
            
            // 未处理的Promise拒绝
            window.addEventListener('unhandledrejection', function(event) {
                console.error('[错误] 未处理的Promise拒绝:', event.reason);
                showNotification('发生未知错误', 'error');
            });
            
            // 存储错误处理
            window.addEventListener('storage', function(event) {
                if (event.key === 'pomodoroTimerData' && event.newValue) {
                    try {
                        const newData = JSON.parse(event.newValue);
                        Object.assign(window.timerState, newData);
                        updateDisplay();
                        updateStats();
                        renderTaskList();
                        renderHistory();
                        showNotification('数据已从其他标签页同步', 'info');
                    } catch (error) {
                        console.error('[同步] 数据同步失败:', error);
                    }
                }
            });
        }

        // 性能监控
        function setupPerformanceMonitoring() {
            if ('performance' in window && 'memory' in performance) {
                setInterval(() => {
                    const memory = performance.memory;
                    console.log('[性能] 内存使用:', 
                        Math.round(memory.usedJSHeapSize / 1024 / 1024) + 'MB / ' +
                        Math.round(memory.totalJSHeapSize / 1024 / 1024) + 'MB'
                    );
                    
                    // 如果内存使用过高，清理一些临时数据
                    if (memory.usedJSHeapSize > memory.totalJSHeapSize * 0.8) {
                        console.warn('[性能] 内存使用过高，清理缓存');
                        if (window.audioManager && window.audioManager.audioContext) {
                            window.audioManager.audioContext.close();
                            window.audioManager.audioContext = null;
                        }
                    }
                }, 60000); // 每分钟检查一次
            }
        }

        // 触摸反馈
        function setupTouchFeedback() {
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    vibrate([50]);
                }
            });
        }

        // 初始化完成后的额外设置
        window.addEventListener('load', function() {
            console.log('[系统] 页面加载完成，进行最终初始化...');
            
            // 初始化高级功能
            initAdvancedFeatures();
            
            // 设置触摸手势
            setupTouchGestures();
            
            // 设置扩展键盘快捷键
            setupExtendedKeyboardShortcuts();
            
            // 设置错误处理
            setupErrorHandling();
            
            // 设置性能监控
            setupPerformanceMonitoring();
            
            // 设置触摸反馈
            if ('vibrate' in navigator) {
                setupTouchFeedback();
            }
            
            // 初始化PWA
            if ('serviceWorker' in navigator) {
                initServiceWorker();
                showInstallPrompt();
            }
            
            // 自动保存
            setInterval(() => {
                saveToStorage();
                console.log('[系统] 自动保存完成');
            }, 30000); // 每30秒保存一次
            
            // 每日重置
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    window.timerState.focusTimeToday = 0;
                    window.timerState.tasksCompleted = 0;
                    window.timerState.completedPomodoros = [];
                    updateStats();
                    showNotification('新的一天开始了！统计数据已重置。', 'info');
                }
            }, 60000); // 每分钟检查一次
            
            // 检查在线状态
            window.addEventListener('online', () => {
                showNotification('已恢复网络连接', 'success');
            });
            
            window.addEventListener('offline', () => {
                showNotification('网络连接断开，应用将在离线模式下运行', 'warning');
            });
            
            console.log('[系统] 最终初始化完成');
        });

        // 服务工作者文件（模拟）
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', function(event) {
                    console.log('[Service Worker] 安装中...');
                    event.waitUntil(
                        caches.open('pomodoro-v1').then(function(cache) {
                            return cache.addAll([
                                './',
                                './index.html',
                                './manifest.json'
                            ]);
                        })
                    );
                });
                
                self.addEventListener('fetch', function(event) {
                    event.respondWith(
                        caches.match(event.request).then(function(response) {
                            return response || fetch(event.request);
                        })
                    );
                });
                
                self.addEventListener('activate', function(event) {
                    console.log('[Service Worker] 激活');
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(registration => {
                console.log('[PWA] ServiceWorker 注册成功:', registration.scope);
            }).catch(error => {
                console.log('[PWA] ServiceWorker 注册失败:', error);
            });
        }

        // 应用清单
        const manifest = {
            "name": "番茄钟计时器",
            "short_name": "番茄钟",
            "description": "高效率的番茄钟时间管理工具",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#2c3e50",
            "theme_color": "#ff6b6b",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🍅</text></svg>",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🍅</text></svg>",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };

        // 将清单添加到页面
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
        document.head.appendChild(manifestLink);

        // 添加元标签
        const metaThemeColor = document.createElement('meta');
        metaThemeColor.name = 'theme-color';
        metaThemeColor.content = '#2c3e50';
        document.head.appendChild(metaThemeColor);

        const metaAppleMobileWebAppCapable = document.createElement('meta');
        metaAppleMobileWebAppCapable.name = 'apple-mobile-web-app-capable';
        metaAppleMobileWebAppCapable.content = 'yes';
        document.head.appendChild(metaAppleMobileWebAppCapable);

        const metaAppleMobileWebAppStatusBarStyle = document.createElement('meta');
        metaAppleMobileWebAppStatusBarStyle.name = 'apple-mobile-web-app-status-bar-style';
        metaAppleMobileWebAppStatusBarStyle.content = 'black-translucent';
        document.head.appendChild(metaAppleMobileWebAppStatusBarStyle);

        console.log('[系统] 番茄钟计时器已完全加载！');
        console.log('[系统] 版本: 6.3.1 | 高级功能已启用');
    </script>
</body>
</html>
